<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>IDE by Vinyl_</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        .slot.pair_list {
            background: #2c2035;
            border-color: #e84393;
            width: 120px;
            height: 35px;
        }

        .slot.pair_list.editing {
            width: 220px !important;
            height: 180px !important;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            justify-content: flex-start;
            padding: 15px 5px 5px 5px;
        }

        .slot.pair_list.editing textarea.slot-input {
            position: relative;
            z-index: 10 !important;
            pointer-events: auto !important;
            pointer-events: auto !important;
            cursor: text;
        }

        .slot.pair_list.editing .drag-handle-overlay {
            z-index: 1;
        }

        .slot.pair_list textarea.slot-input {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            color: #ff79c6;
            color: #ff79c6;
            font-family: 'Consolas', monospace;
            font-size: 11px;
            padding: 5px;
            border: 1px solid #6272a4;
            resize: none;
            outline: none;
            pointer-events: auto !important;
            pointer-events: auto !important;
        }

        .slot.item_array {
            width: 60px;
            height: auto;
            min-height: 60px;
            max-height: 500px;
            border-color: #00b894;
            background: #1e272e;
            display: flex;
            flex-direction: column;
            padding: 5px;
            gap: 5px;
            overflow-y: auto;
            border-style: double;
            align-items: center;
        }

        .slot.table {
            width: auto;
            min-width: 100px;
            height: auto;
            min-height: 60px;
            border-color: #0984e3;
            background: #1e272e;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 5px;
            border-style: solid;
            align-items: stretch;
        }

        .slot.table table {
            border-collapse: collapse;
            width: 100%;
            font-size: 10px;
        }

        .slot.table th,
        .slot.table td {
            border: 1px solid #444;
            padding: 2px;
            min-width: 40px;
        }

        .slot.table th {
            background: rgba(255, 255, 255, 0.05);
            color: #aaa;
            font-size: 9px;
            text-align: left;
        }

        .slot.table input {
            width: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 10px;
            outline: none;
            padding: 2px;
        }

        .table-row-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .table-add-row-btn {
            background: rgba(9, 132, 227, 0.2);
            border: 1px dashed #0984e3;
            color: #0984e3;
            font-size: 10px;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
            text-align: center;
        }

        .table-add-row-btn:hover {
            background: rgba(9, 132, 227, 0.4);
        }

        .item-array-add-btn {
            width: 46px;
            height: 25px;
            border: 1px dashed #00b894;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00b894;
            font-size: 18px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .item-array-add-btn:hover {
            background: rgba(0, 184, 148, 0.1);
        }

        .item-array-add-slot {
            width: 46px;
            height: 30px;
            border: 1px dashed #00b894;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00b894;
            font-size: 20px;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .item-array-add-slot:hover {
            background: rgba(0, 184, 148, 0.2);
        }

        .item-array-slot {
            width: 46px;
            height: 46px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            border-radius: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .item-array-slot img {
            width: 32px;
            height: 32px;
        }

        .item-array-slot::before {
            content: attr(data-index);
            position: absolute;
            top: 0;
            left: 2px;
            font-size: 8px;
            color: #555;
        }

        .tree-root-drop-zone {
            height: 30px;
            margin-top: 10px;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #555;
            transition: all 0.2s;
        }

        .tree-root-drop-zone.drag-over {
            background: rgba(9, 132, 227, 0.2);
            border-color: var(--accent);
            color: #fff;
        }

        .fallback-name.type-item {
            color: #ffffff;
        }

        .fallback-name.type-fluid {
            color: #74b9ff;
        }

        .fallback-name.type-aspect {
            color: #a29bfe;
        }

        .fallback-name.type-research {
            color: #fdcb6e;
        }

        .sidebar-left.collapsed,
        #resizer-left.collapsed {
            display: none !important;
        }

        .slot.list {
            width: 120px;
            height: 35px;
            background: #2c2035;
            border: 2px solid #9b59b6;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: height 0.2s;
            overflow: visible;
        }

        .slot.list.editing {
            height: 120px;
            align-items: stretch;
            padding: 15px 5px 5px 5px;
        }

        .slot.list textarea.slot-input {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            color: #e0aaff;
            font-family: 'Consolas', monospace;
            font-size: 11px;
            padding: 5px;
            border: 1px solid #444;
            resize: none;
            outline: none;
            position: relative;
            z-index: 1001 !important;
            pointer-events: auto !important;
            cursor: text;
        }

        .slot.list.editing .drag-handle-overlay {
            z-index: 1;
        }

        .mini-asp-fallback {
            width: 16px;
            height: 16px;
            background: rgba(0, 0, 0, 0.6);
            color: #a29bfe;
            font-size: 6px;
            font-weight: bold;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            line-height: 6px;
            word-break: break-all;
            font-family: 'Consolas', monospace;
        }

        .fallback-box {
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .fallback-name {
            font-size: 8px;
            color: #74b9ff;
            text-align: center;
            line-height: 9px;
            word-break: break-all;
            padding: 2px;
            font-family: 'Consolas', monospace;
            text-transform: uppercase;
            font-weight: bold;
        }

        .img-error {
            display: none !important;
        }

        .code-syntax-block {
            background: #4834d4;
            color: #fff;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            display: inline;
            margin: 0 1px;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .code-syntax-block:hover {
            background: #f1c40f;
            color: #000;
            border-color: #f1c40f;
            box-shadow: 0 0 10px #f1c40f;
        }

        .syntax-select-overlay {
            background: #1e272e;
            color: #fff;
            border: 1px solid #6c5ce7;
            border-radius: 4px;
            font-size: 11px;
            padding: 4px;
            outline: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            z-index: 100000;
            font-family: 'Consolas', monospace;
        }

        .syntax-select-overlay option {
            background: #1e272e;
            color: #fff;
            padding: 4px;
        }

        #code-template-visual {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            color: #ccc;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            padding: 10px;
            border-radius: 4px;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.8;
        }

        #code-template-visual:focus {
            border-color: #6c5ce7;
        }

        .slot.research .slot-content-text {
            font-size: 10px;
            color: #fdcb6e;
            font-weight: bold;
            padding: 2px;
        }

        .slot.list {
            width: 120px;
            height: 35px;
            background: #2c2035;
            border: 2px solid #9b59b6;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: height 0.2s;
        }

        .slot.list.editing {
            height: 120px;
            align-items: stretch;
        }

        .slot.list textarea.slot-input {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            color: #e0aaff;
            font-family: 'Consolas', monospace;
            font-size: 11px;
            padding: 6px;
            border: none;
            resize: none;
            outline: none;
            pointer-events: auto;
        }

        .slot.list .slot-select-craft {
            width: 90%;
            height: 25px;
            background: #2c3e50;
            color: white;
            border: 1px solid #34495e;
            border-radius: 3px;
            font-size: 11px;
            outline: none;
            cursor: pointer;
            pointer-events: auto;
        }

        .slot-select-craft {
            width: 100%;
            height: 100%;
            background: #2c2035;
            color: white;
            border: none;
            font-size: 11px;
            outline: none;
            cursor: pointer;
        }

        .mini-asp {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            padding: 2px 4px;
            margin: 1px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.1s;
            cursor: pointer;
        }

        .mini-asp:hover {
            border-color: #a29bfe;
            transform: scale(1.05);
        }

        .mini-asp img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }

        .mini-asp span {
            font-size: 10px;
            color: #fff;
            font-weight: bold;
            margin-left: 4px;
            font-family: monospace;
        }

        .slot.array {
            width: 100px;
            height: 160px;
            border-color: #e17055;
            background: #2f3640;
            flex-direction: column;
            padding: 5px;
        }

        .slot.array textarea {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            color: #fab1a0;
            font-size: 10px;
            font-family: 'Consolas', monospace;
            resize: none;
            outline: none;
            padding: 2px;
        }

        .mini-asp span {
            background: rgba(0, 0, 0, 0.6);
            padding: 0 3px;
            border-radius: 4px;
            min-width: 10px;
            text-align: center;
        }

        .asp-count-badge {
            background: #0984e3;
            color: white;
            padding: 0 6px;
            border-radius: 10px;
            font-size: 10px;
            margin: 0 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .asp-tag {
            cursor: ns-resize;
            user-select: none;
        }

        .asp-count-badge {
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            padding: 0 6px;
            border-radius: 10px;
            font-weight: bold;
            font-family: monospace;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 0 4px;
        }

        .asp-tag:hover {
            border-color: #a29bfe;
            background: #3d2b3e;
        }

        .slot.highlight-hover {
            border-color: #f1c40f !important;
            box-shadow: 0 0 20px #f1c40f !important;
            transform: scale(1.1) translateY(-5px);
            z-index: 1000 !important;
        }

        .el-item.active-link {
            background: #34495e;
            border-color: #f1c40f;
        }

        #aspect-list-container {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            max-width: 500px;
        }

        :root {
            --bg-dark: #0a0a0b;
            --panel-bg: rgba(18, 18, 20, 0.85);
            --sidebar-bg: rgba(13, 13, 15, 0.95);
            --glass-blur: blur(16px);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #e2e8f0;
            --text-dim: #94a3b8;
            --radius: 8px;
            --radius-sm: 6px;
            --radius-lg: 12px;
            --font-main: 'Inter', sans-serif;
            --font-logo: 'Outfit', sans-serif;
            --font-code: 'JetBrains Mono', 'Consolas', monospace;
        }

        body {
            background: radial-gradient(circle at 50% 10%, #1e1b4b 0%, #050505 100%);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: var(--font-main);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        input,
        button,
        textarea,
        select {
            font-family: inherit;
        }

        .header {
            height: 48px;
            background: var(--panel-bg);
            backdrop-filter: var(--glass-blur);
            border-bottom: var(--glass-border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 50;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .logo {
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 18px;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
            width: 100%;
            position: relative;
        }

        .sidebar-left {
            width: 320px;
            background: var(--sidebar-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-right: var(--glass-border);
            display: flex;
            flex-direction: row;
            z-index: 15;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Vertical Tabs Strip */
        .lib-tabs-vertical {
            width: 40px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 5px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .lib-tab-v {
            width: 32px;
            height: 32px;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: var(--radius-sm);
            font-size: 16px;
            color: var(--text-dim);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .lib-tab-v:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            transform: translateX(2px);
        }

        .lib-tab-v.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .lib-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .search-box {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 8px 12px;
            margin: 12px;
            border-radius: var(--radius);
            outline: none;
            font-size: 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-box:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .item-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 5px;
        }

        .lib-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            cursor: grab;
            font-size: 11px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .lib-card:hover {
            background: rgba(255, 255, 255, 0.04);
            border-left-color: rgba(255, 255, 255, 0.1);
        }

        .lib-card img {
            width: 24px;
            height: 24px;
            image-rendering: pixelated;
        }

        .lib-card.fluid-card {
            border-left: 3px solid #74b9ff;
        }

        .lib-card.aspect-card {
            border-left: 3px solid #a29bfe;
        }

        .lib-card.research-card {
            border-left: 3px solid #fdcb6e;
        }

        .main-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #121212;
            position: relative;
            min-width: 0;
        }

        .top-bar {
            min-height: 40px;
            height: auto;
            background: var(--panel-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-bottom: var(--glass-border);
            display: flex;
            align-items: center;
            padding: 5px 15px;
            gap: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
            z-index: 10;
        }

        /* –ß—Ç–æ–±—ã —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –Ω–µ –ª–æ–º–∞–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ */
        .top-bar>div[style*="width:1px"] {
            height: 25px !important;
            align-self: center;
        }

        .stage-body {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .vertical-toolbar {
            width: 50px;
            background: var(--panel-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-right: var(--glass-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 6px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }

        .tool-btn {
            width: 42px;
            height: 38px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            gap: 2px;
        }

        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            transform: translateY(-1px);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .tool-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .tool-btn.danger {
            color: #ff7675;
            border-color: rgba(255, 118, 117, 0.3);
        }

        .tool-btn.danger:hover {
            background: #d63031;
            color: white;
            border-color: #d63031;
        }

        .separator {
            width: 30px;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 2px 0;
            flex-shrink: 0;
        }

        #canvas-viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #0f0f0f;
            cursor: default;
        }

        #canvas-viewport.panning {
            cursor: grabbing;
            cursor: -webkit-grabbing;
        }

        #canvas-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 5000px;
            height: 5000px;
            transform-origin: 0 0;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .code-panel {
            height: 180px;
            min-height: 60px;
            max-height: 50vh;
            background: #121214;
            border-top: 1px solid #333;
            display: flex;
            z-index: 40;
            position: relative;
            flex-shrink: 0;
        }

        .panel-resizer {
            position: absolute;
            top: -5px;
            left: 0;
            width: 100%;
            height: 10px;
            background: transparent;
            cursor: ns-resize;
            z-index: 9999;
            transition: background 0.2s;
        }

        .panel-resizer:hover,
        .panel-resizer.active {
            background: var(--accent);
        }

        .vertical-resizer {
            width: 4px;
            background: transparent;
            cursor: col-resize;
            transition: 0.2s;
            z-index: 1000;
        }

        .vertical-resizer:hover,
        .vertical-resizer.active {
            background: var(--accent);
        }

        .horizontal-resizer {
            height: 4px;
            background: transparent;
            cursor: ns-resize;
            transition: 0.2s;
            z-index: 1000;
        }

        .horizontal-resizer:hover,
        .horizontal-resizer.active {
            background: var(--accent);
        }

        .code-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            gap: 5px;
        }

        .code-label {
            font-size: 11px;
            color: #888;
            font-weight: bold;
            text-transform: uppercase;
        }

        textarea {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            color: #a29bfe;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            resize: none;
            padding: 8px;
            outline: none;
            border-radius: 4px;
        }

        .sidebar-right {
            width: 280px;
            background: var(--panel-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-left: var(--glass-border);
            display: flex;
            flex-direction: column;
            z-index: 15;
        }

        .panel-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 10px;
            font-size: 11px;
            font-weight: bold;
            color: #aaa;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            letter-spacing: 0.5px;
        }

        .tree-toolbar {
            padding: 5px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .tree-container {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .tree-header {
            display: flex;
            align-items: center;
            padding: 4px 6px;
            cursor: pointer;
            color: #ccc;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid transparent;
            margin-bottom: 2px;
            transition: background 0.1s;
        }

        .tree-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tree-header.selected-node {
            background: rgba(9, 132, 227, 0.2);
            border-color: var(--accent);
        }

        .tree-header.active-page {
            background: var(--accent) !important;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tree-children {
            padding-left: 14px;
            border-left: 1px solid #333;
            margin-left: 7px;
        }

        .tree-children.hidden {
            display: none;
        }

        /* BUTTONS & INPUTS */
        .btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            padding: 6px 14px;
            cursor: pointer;
            border-radius: var(--radius);
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .btn.primary {
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            border: none;
            color: white;
            box-shadow: 0 2px 8px var(--accent-glow);
        }

        .btn.primary:hover {
            filter: brightness(1.1);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .btn.success {
            background: #00b894;
            border-color: #00b894;
            color: white;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .control-label {
            font-size: 9px;
            color: #888;
            font-weight: bold;
        }

        .input-dark {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #555;
            color: white;
            padding: 4px;
            border-radius: 3px;
            font-size: 11px;
            outline: none;
        }

        .input-dark:focus {
            border-color: var(--accent);
        }

        /* EDITOR UI */
        .editor-ui-panel {
            display: none;
            align-items: center;
            gap: 5px;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #555;
        }

        .editor-ui-panel.active {
            display: flex;
        }

        .option-tag {
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid #555;
            white-space: nowrap;
        }

        /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ê–°–ü–ï–ö–¢–û–í --- */
        .asp-tag {
            background: #2d1e2e;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #6c5ce7;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #a29bfe;
            flex-shrink: 0;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ü–∏—Ñ—Ä—ã –í–ù–£–¢–†–ò –∞—Å–ø–µ–∫—Ç–∞ */
        .asp-tag input {
            width: 35px !important;
            height: 18px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #555;
            color: white;
            text-align: center;
            border-radius: 2px;
            font-size: 11px;
            outline: none;
        }

        .asp-tag input:focus {
            border-color: #a29bfe;
        }

        /* SLOTS */
        .slot {
            position: absolute;
            width: 52px;
            height: 52px;
            background: #1e1e24;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            user-select: none;
            border-radius: var(--radius);
            z-index: 10;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .slot.fluid {
            border-color: #0984e3;
            background: #1e272e;
        }

        .slot.aspect {
            border-color: #6c5ce7;
            background: #2d1e2e;
        }

        .slot.research {
            border-color: #fdcb6e;
            background: #3e321e;
        }

        .slot.counter {
            background: #2d3436;
            border-color: #00b894;
            width: 60px;
            height: 30px;
        }

        .slot.text {
            background: #2d3436;
            border-color: #a29bfe;
            width: 100px;
            height: 30px;
        }

        .slot.list {
            background: #2c2035;
            border-color: #9b59b6;
            width: 100px;
            height: 30px;
            padding: 0;
            display: block;
        }

        .slot.note {
            background: #feca57;
            border-color: #ff9f43;
            width: 150px;
            height: 120px;
            border-radius: 2px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .slot.note textarea {
            color: #2d3436;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
            padding: 8px;
            line-height: 1.3;
        }

        .slot.any {
            border-color: #ecf0f1;
            background: #34495e;
        }

        .slot.any::after {
            content: "*";
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            color: #ecf0f1;
            font-weight: bold;
        }

        /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö –ù–ê –•–û–õ–°–¢–ï (–°–ï–¢–ö–ê) --- */
        .slot.aspect_list {
            background: #2d1e2e;
            border-color: #e67e22;
            width: 110px;
            height: auto;
            min-height: 52px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            padding: 2px;
            gap: 2px;
            align-content: start;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –º–∏–Ω–∏-–∞—Å–ø–µ–∫—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ */
        .mini-asp {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 2px;
            padding: 1px 2px;
            overflow: hidden;
        }

        .mini-asp img {
            width: 16px;
            height: 16px;
        }

        .mini-asp span {
            font-size: 9px;
            color: #fff;
            font-weight: bold;
            margin-left: 2px;
        }

        .slot:hover {
            border-color: var(--accent);
            z-index: 50;
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6), 0 0 15px var(--accent-glow);
        }

        .slot.selected {
            border: 2px solid #e17055;
            z-index: 100;
            box-shadow: 0 0 0 2px rgba(225, 112, 85, 0.4);
        }

        .slot.linking-source {
            border: 2px dashed #2ecc71;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.6);
            z-index: 100;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
            }
        }

        .slot img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
            pointer-events: none;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
        }

        .slot-id {
            position: absolute;
            top: -18px;
            left: 0;
            font-size: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 1px 4px;
            border-radius: 3px;
            pointer-events: none;
            white-space: nowrap;
        }

        .craft-mode .slot-id {
            display: none !important;
        }

        .slot-custom-label {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 4px;
            font-size: 11px;
            font-weight: bold;
            color: #ecf0f1;
            text-shadow: 1px 1px 2px black;
            white-space: nowrap;
            pointer-events: none;
        }

        .editing .slot-custom-label {
            margin-bottom: 18px;
            color: #f1c40f;
        }

        .slot-count {
            position: absolute;
            bottom: -2px;
            right: 0px;
            font-size: 13px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 0 #000, -1px -1px 0 #000;
            pointer-events: none;
        }

        .slot-content-text {
            font-size: 9px;
            text-align: center;
            color: #fff;
            pointer-events: none;
            line-height: 1.1;
            overflow: hidden;
            padding: 2px;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
        }

        .slot-input,
        .slot-select {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: white;
            text-align: center;
            font-size: 12px;
            outline: none;
            font-family: 'Consolas', monospace;
        }

        .slot-select option {
            background: #222;
        }

        .drag-handle-overlay {
            display: none;
            position: absolute;
            inset: 0;
            cursor: grab;
            z-index: 2;
        }

        .slot.editing .drag-handle-overlay {
            display: block;
        }

        #selection-marquee {
            position: absolute;
            border: 1px solid #0984e3;
            background: rgba(9, 132, 227, 0.2);
            display: none;
            z-index: 9999;
            pointer-events: none;
            border-radius: 2px;
        }

        /* CONNECTIONS */
        #connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏ */
        .conn-line {
            stroke: #2ecc71;
            stroke-width: 3;
            fill: none;
            stroke-dasharray: 10 5;
            animation: flow 0.5s linear infinite;
            filter: drop-shadow(0 0 5px rgba(46, 204, 113, 0.5));
            transition: stroke 0.3s, stroke-width 0.3s;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å–ª–æ—Ç */
        .conn-line.highlight {
            stroke: #f1c40f;
            stroke-width: 5;
            filter: drop-shadow(0 0 8px #f1c40f);
        }

        @keyframes flow {
            from {
                stroke-dashoffset: 15;
            }

            to {
                stroke-dashoffset: 0;
            }
        }

        #context-menu {
            position: fixed;
            display: none;
            flex-direction: column;
            background: rgba(40, 40, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #555;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            padding: 4px 0;
            min-width: 150px;
        }

        .ctx-item {
            padding: 6px 15px;
            font-size: 12px;
            color: #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .ctx-item:hover {
            background: var(--accent);
            color: white;
        }

        .ctx-separator {
            height: 1px;
            background: #555;
            margin: 3px 0;
        }

        .ctx-shortcut {
            color: #aaa;
            font-size: 10px;
            margin-left: 10px;
        }

        .align-tools {
            display: flex;
            gap: 2px;
            margin-left: 10px;
            padding-left: 10px;
            border-left: 1px solid #555;
        }

        .align-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #444;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid #555;
            font-size: 14px;
        }

        .align-btn:hover {
            background: #666;
            color: white;
        }

        /* --- –í–ï–†–¢–ò–ö–ê–õ–¨–ù–´–ï –†–ê–ó–î–ï–õ–ò–¢–ï–õ–ò --- */
        .vertical-resizer {
            width: 6px;
            background: transparent;
            cursor: col-resize;
            z-index: 100;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .vertical-resizer:hover,
        .vertical-resizer.active {
            background: var(--accent);
            opacity: 0.5;
        }

        .elements-list {
            flex: 1;
            min-height: 0;
            max-height: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 4px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 5px;
        }

        .el-item {
            background: #222;
            border: 1px solid #444;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            color: #fff;
            cursor: grab;
            white-space: nowrap;
            transition: 0.2s;
        }

        .el-item:hover {
            background: #333;
            border-color: var(--accent);
        }

        .el-item b {
            font-family: 'Consolas', monospace;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –±–ª–æ–∫–∞ –ú–∞—Å—Å–∏–≤–∞ (Mass) */
        .slot.array {
            width: 120px;
            height: 180px;
            border-color: #e17055;
            background: #2f3640;
            display: flex;
            flex-direction: column;
            padding: 5px;
            box-sizing: border-box;
        }

        .slot.array textarea {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            color: #fab1a0;
            font-size: 10px;
            font-family: 'Consolas', monospace;
            resize: none;
            outline: none;
            padding: 4px;
            box-sizing: border-box;
            margin-top: 10px;
        }

        .slot.array textarea:focus {
            border-color: #e17055;
            background: rgba(0, 0, 0, 0.6);
        }

        .slot.group {
            border: 2px dashed #f1c40f;
            background: rgba(241, 196, 15, 0.1);
            pointer-events: none;
            z-index: 0 !important;
            /* –ì—Ä—É–ø–ø–∞ –≤—Å–µ–≥–¥–∞ –Ω–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ */
            width: auto;
            height: auto;
        }

        .slot.group.editing {
            pointer-events: auto !important;
        }

        .slot.group .slot-custom-label {
            color: #f1c40f;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 8px;
            border-radius: 3px;
        }

        .conn-line.selected {
            stroke: #f1c40f;
            stroke-width: 4;
            filter: drop-shadow(0 0 10px #f1c40f);
            animation: pulse-gold 1s infinite;
        }

        @keyframes pulse-gold {
            0% {
                stroke-opacity: 0.7;
            }

            50% {
                stroke-opacity: 1;
            }

            100% {
                stroke-opacity: 0.7;
            }
        }

        .quick-action-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #74b9ff;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quick-action-btn:hover {
            background: rgba(116, 185, 255, 0.2);
            border-color: #74b9ff;
        }

        #canvas-stats {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            color: #aaa;
            z-index: 100;
        }

        #quick-actions-panel {
            display: none;
            position: fixed;
            top: 45px;
            right: 15px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            z-index: 10000;
            min-width: 200px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        #quick-actions-panel h4 {
            margin: 0 0 10px 0;
            color: #74b9ff;
        }

        .missing-texture {
            background-image:
                linear-gradient(45deg, #222 25%, transparent 25%),
                linear-gradient(-45deg, #222 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #222 75%),
                linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 8px 8px;
            background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
        }

        .custom-tooltip {
            position: fixed;
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid var(--accent);
            padding: 8px 12px;
            border-radius: 6px;
            color: #fff;
            font-size: 11px;
            pointer-events: none;
            z-index: 100000;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            max-width: 300px;
        }

        .custom-tooltip-title {
            color: #fff;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .custom-tooltip-detail {
            color: #aaa;
            font-family: 'Consolas', monospace;
            word-break: break-all;
            white-space: pre-wrap;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div id="item-tooltip" class="custom-tooltip">
        <div class="custom-tooltip-title" id="tooltip-name"></div>
        <div class="custom-tooltip-detail" id="tooltip-code"></div>
    </div>
    <div class="header" id="main-header">
        <div class="logo">üí† IDE BY Vinyl_</div>

        <!-- MOVED TOOLBAR CONTROLS -->
        <div style="display:flex; align-items:center; gap:10px; flex:1; padding-left:20px; overflow-x:auto;">
            <button class="btn primary" id="edit-mode-btn" onclick="toggleEditMode()"
                style="width:120px; font-weight:bold; padding:4px 12px; font-size:11px;">üîßMODE:CRAFT</button>
            <div style="width:1px; height:20px; background:#555;"></div>

            <div class="control-group">
                <span class="control-label">ID</span>
                <input type="text" id="slot-id-input" class="input-dark" style="width:70px;"
                    oninput="updateSlotID(this.value)" disabled>
            </div>
            <div class="control-group">
                <span class="control-label">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                <input type="text" id="slot-label-input" class="input-dark" style="width:90px;"
                    oninput="updateSlotLabel(this.value)" disabled>
            </div>

            <div style="width:1px; height:20px; background:#555;"></div>

            <!-- Editor UIs (Hidden by default) -->
            <div id="list-builder-ui" class="editor-ui-panel">
                <span style="font-size:10px;color:#aaa">–í–∞—Ä–∏–∞–Ω—Ç—ã:</span>
                <input type="text" id="list-option-add" class="input-dark" style="width:60px;" placeholder="–¢–µ–∫—Å—Ç">
                <button class="btn success" onclick="addOptionToSelected()" style="padding:2px 6px;">+</button>
                <div id="list-options-container"></div>
            </div>

            <div id="item-array-ui" class="editor-ui-panel">
                <span style="font-size:10px;color:#aaa">–≠–ª–µ–º–µ–Ω—Ç–æ–≤:</span>
                <b id="item-array-count" style="color:#00b894; margin: 0 5px;">0</b>
                <button class="btn danger" onclick="clearItemArray()" style="padding:2px 6px;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            </div>

            <div id="table-ui" class="editor-ui-panel">
                <div class="control-group">
                    <span class="control-label">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å</span>
                    <input type="text" id="table-sep-input" class="input-dark" style="width:30px;" placeholder=","
                        oninput="updateTableSep(this.value)">
                </div>
                <button class="btn success" onclick="addColumnToTable()" style="padding:2px 6px;">+Col</button>
                <button class="btn info" onclick="addTableRowFromUI()" style="padding:2px 6px;">+Row</button>
                <div id="table-cols-container" style="display:flex; gap:4px;"></div>
            </div>

            <div id="aspect-list-ui" class="editor-ui-panel">
                <div id="aspect-list-container" style="display:flex; gap:4px; flex-wrap:wrap;"></div>
            </div>

            <div id="align-tools-panel" class="align-tools" style="display:none; border:none; padding:0; margin:0;">
                <div class="align-btn" onclick="alignSelected('left')" title="–í–ª–µ–≤–æ">‚¨ÖÔ∏è</div>
                <div class="align-btn" onclick="alignSelected('top')" title="–í–≤–µ—Ä—Ö">‚¨ÜÔ∏è</div>
                <div class="align-btn" onclick="alignSelected('grid')" title="–°–µ—Ç–∫–∞">üï∏Ô∏è</div>
            </div>

            <div style="flex:1"></div>

            <div
                style="display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
                <button class="btn" onclick="changeZoom(-0.1)" style="padding:4px 8px;">‚ûñ</button>
                <span id="zoom-label" style="font-size:10px; width:30px; text-align:center;">100%</span>
                <button class="btn" onclick="changeZoom(0.1)" style="padding:4px 8px;">‚ûï</button>
                <div style="width:1px; height:20px; background:#555; margin:0 4px;"></div>
                <button class="btn" onclick="undo()" title="Ctrl+Z" style="padding:4px 8px;">‚Ü©</button>
                <button class="btn" onclick="redo()" title="Ctrl+Y" style="padding:4px 8px;">‚Ü™</button>
                <div style="width:1px; height:20px; background:#555; margin:0 4px;"></div>
                <button class="btn danger" onclick="clearPageCanvas()" style="padding:4px 8px;">üóëÔ∏è</button>
            </div>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" onclick="document.getElementById('price-upload').click()">–¶–µ–Ω—ã</button>
            <input type="file" id="price-upload" hidden accept=".database" onchange="loadPricesFile(this)">



            <button class="btn" onclick="document.getElementById('db-upload').click()">–ü—Ä–µ–¥–º–µ—Ç—ã</button>
            <input type="file" id="db-upload" hidden accept=".csv" onchange="loadItemsCSV(this)">

            <button class="btn" onclick="document.getElementById('proj-upload').click()">–û—Ç–∫—Ä—ã—Ç—å</button>
            <input type="file" id="proj-upload" hidden accept=".json" onchange="loadProjectFile(this)">

            <button class="btn primary" onclick="saveProjectFile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

            <button class="btn" onclick="document.getElementById('script-import').click()">–ò–º–ø. –°–∫—Ä–∏–ø—Ç</button>
            <input type="file" id="script-import" hidden accept=".zs,.txt" onchange="importFullScript(this)">
            <button class="btn" onclick="importCraftFromText()">–ò–º–ø. –ö—Ä–∞—Ñ—Ç</button>
        </div>
    </div>
    </div>
    <div class="horizontal-resizer" id="resizer-top"></div>

    <div class="workspace">
        <div class="sidebar-left" id="sidebar-left-panel">
            <div class="lib-tabs-vertical">
                <div class="lib-tab-v active" onclick="setLibMode('items', this)" title="–ü—Ä–µ–¥–º–µ—Ç—ã">üì¶</div>
                <div class="lib-tab-v" onclick="setLibMode('liquids', this)" title="–ñ–∏–¥–∫–æ—Å—Ç–∏">üíß</div>
                <div class="lib-tab-v" onclick="setLibMode('aspects', this)" title="–ê—Å–ø–µ–∫—Ç—ã">‚ú®</div>
                <div class="lib-tab-v" onclick="setLibMode('research', this)" title="–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è">üìñ</div>
            </div>

            <div class="lib-content-area">
                <input type="text" class="search-box" id="lib-search" placeholder="–ü–æ–∏—Å–∫ (ID –∏–ª–∏ –∏–º—è)..."
                    oninput="renderLibraryDebounced()">
                <div class="item-list" id="library-container"></div>
            </div>
        </div>

        <div class="vertical-resizer" id="resizer-left"></div>

        <div class="main-stage">
            <div class="top-bar" style="display:none;"></div>

            <div class="stage-body">
                <div class="vertical-toolbar" id="builder-controls" style="display:none;">
                    <div class="tool-btn" onclick="addSlot('pair_list')" style="color:#e84393"
                        onmouseenter="showTooltip(event, '–°–ø–∏—Å–æ–∫ (PList)', '–°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–º—è –∑–Ω–∞—á–µ–Ω–∏—é.\n–ò–º—è:–ó–Ω–∞—á–µ–Ω–∏–µ\n–ü—Ä–∏–º–µ—Ä: –ñ–µ–ª–µ–∑–æ:ingotIron')"
                        onmouseleave="hideTooltip()">
                        üë•<br>PList</div>
                    <div class="tool-btn" onclick="addSlot('item_array')" style="color:#00b894"
                        onmouseenter="showTooltip(event, '–ú–∞—Å—Å–∏–≤ –ø—Ä–µ–¥–º–µ—Ç–æ–≤', '–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤.\n–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤.')"
                        onmouseleave="hideTooltip()">üìë<br>ItmArr</div>
                    <div class="tool-btn" onclick="addSlot('table')" style="color:#0984e3"
                        onmouseenter="showTooltip(event, '–¢–∞–±–ª–∏—Ü–∞', '–°–µ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö.\n–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Excel –∏ —Ñ–æ—Ä–º—É–ª—ã —á–µ—Ä–µ–∑ =.')"
                        onmouseleave="hideTooltip()">
                        üìä<br>Table</div>
                    <div class="tool-btn" onclick="addSlot('item')"
                        onmouseenter="showTooltip(event, '–ü—Ä–µ–¥–º–µ—Ç', '–û–¥–∏–Ω–æ—á–Ω—ã–π —Å–ª–æ—Ç –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞.\n–ö–æ–ª-–≤–æ: –ö–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏.')"
                        onmouseleave="hideTooltip()">üì¶<br>Item</div>
                    <div class="tool-btn" onclick="addSlot('fluid')"
                        onmouseenter="showTooltip(event, '–ñ–∏–¥–∫–æ—Å—Ç—å', '–°–ª–æ—Ç –¥–ª—è –∂–∏–¥–∫–æ—Å—Ç–∏.\n–°–∏–Ω—Ç–∞–∫—Å–∏—Å: <liquid:ID>.')"
                        onmouseleave="hideTooltip()">üíß<br>Fluid</div>
                    <div class="tool-btn" onclick="addSlot('aspect')"
                        onmouseenter="showTooltip(event, '–ê—Å–ø–µ–∫—Ç', '–û–¥–∏–Ω–æ—á–Ω—ã–π –º–∞–≥–∏—á–µ—Å–∫–∏–π –∞—Å–ø–µ–∫—Ç.')"
                        onmouseleave="hideTooltip()">‚ú®<br>Asp</div>
                    <div class="tool-btn" onclick="addSlot('aspect_list')" style="color:#e67e22"
                        onmouseenter="showTooltip(event, '–°–ø–∏—Å–æ–∫ –∞—Å–ø–µ–∫—Ç–æ–≤', '–ù–∞–±–æ—Ä –∞—Å–ø–µ–∫—Ç–æ–≤ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º.\n–ü—Ä–∏–º–µ—Ä: terra 2, aqua 5.')"
                        onmouseleave="hideTooltip()">‚ú®üìú<br>AsLst</div>
                    <div class="separator"></div>
                    <div class="tool-btn" onclick="addSlot('list')" style="color:#9b59b6"
                        onmouseenter="showTooltip(event, '–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫', '–í—ã–±–æ—Ä –æ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞.')"
                        onmouseleave="hideTooltip()">
                        üîª<br>List</div>
                    <div class="tool-btn" onclick="addSlot('array')" style="color:#e17055"
                        onmouseenter="showTooltip(event, '–ú–∞—Å—Å–∏–≤ (Mass)', '–ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.')"
                        onmouseleave="hideTooltip()">
                        üìã<br>Mass</div>
                    <div class="tool-btn" onclick="addSlot('research')" style="color:#fdcb6e"
                        onmouseenter="showTooltip(event, '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–°–ª–æ—Ç –¥–ª—è –∫–æ–¥–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.\n–ü—Ä–∏–º–µ—Ä: THAUMONOMICON.')"
                        onmouseleave="hideTooltip()">
                        üìñ<br>Res</div>
                    <div class="tool-btn" onclick="addSlot('any')" style="color:#95a5a6"
                        onmouseenter="showTooltip(event, '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π', '–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ª—é–±–æ–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö.')"
                        onmouseleave="hideTooltip()">
                        ‚ú≥Ô∏è<br>Univ</div>
                    <div class="separator"></div>
                    <div class="tool-btn" onclick="addSlot('counter')" style="color:#2ecc71"
                        onmouseenter="showTooltip(event, '–ß–∏—Å–ª–æ (Cnt)', '–ß–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.\n–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏–∫—É: =64/2.')"
                        onmouseleave="hideTooltip()">123<br>Cnt
                    </div>
                    <div class="tool-btn" onclick="addSlot('text')" style="color:#74b9ff"
                        onmouseenter="showTooltip(event, '–¢–µ–∫—Å—Ç (Txt)', '–û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–µ–∫—Å—Ç–∞.\n–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º—É–ª—ã —á–µ—Ä–µ–∑ =.')"
                        onmouseleave="hideTooltip()">Abc<br>Txt</div>
                    <div class="tool-btn" onclick="addSlot('note')" style="color:#feca57"
                        onmouseenter="showTooltip(event, '–ó–∞–º–µ—Ç–∫–∞', '–¢–µ–∫—Å—Ç–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä –¥–ª—è –ø–æ–º–µ—Ç–æ–∫ –Ω–∞ —Ö–æ–ª—Å—Ç–µ.')"
                        onmouseleave="hideTooltip()">üìå<br>Note
                    </div>
                    <div class="separator"></div>
                    <div class="tool-btn" id="btn-link-mode" onclick="toggleLinkMode()"
                        onmouseenter="showTooltip(event, '–¶–µ–ø–æ—á–∫–∞ (Link)', '–°–æ–µ–¥–∏–Ω—è–µ—Ç –±–ª–æ–∫–∏. –ó–Ω–∞—á–µ–Ω–∏—è\n–æ–±—ä–µ–¥–∏–Ω—è—Ç—Å—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.')"
                        onmouseleave="hideTooltip()">üîó<br>Link</div>

                    <div class="tool-btn" id="btn-group-mode" onclick="toggleGroupMode()"
                        onmouseenter="showTooltip(event, '–ì—Ä—É–ø–ø–∞', '–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏.\n–°–ª–æ—Ç—ã —Å—Ç–∞–Ω—É—Ç –µ–¥–∏–Ω—ã–º —Ü–µ–ª—ã–º.')"
                        onmouseleave="hideTooltip()">üí†<br>Grp</div>

                    <div style="flex:1"></div>
                    <div class="tool-btn danger" onclick="deleteSelectedSlots()"
                        onmouseenter="showTooltip(event, '–£–¥–∞–ª–∏—Ç—å', '–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏.\n–ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: Del.')"
                        onmouseleave="hideTooltip()">üóëÔ∏è<br>Del
                    </div>
                </div>

                <div id="canvas-viewport" class="craft-mode">
                    <div id="canvas-content" onmousedown="onCanvasMouseDown(event)"
                        oncontextmenu="handleContextMenu(event)">
                        <svg id="connections-layer"></svg>
                        <div id="canvas-slots-layer"></div>
                        <div id="selection-marquee"></div>
                    </div>
                </div>
            </div>

            <div class="code-panel" id="code-panel-container">
                <div id="resizer-handle" class="panel-resizer"></div>
                <div class="code-col">
                    <div class="code-label" style="display:flex; justify-content:space-between; align-items:center;">
                        –®–∞–±–ª–æ–Ω –°–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ <button class="btn info" style="font-size:10px; padding: 2px 5px;"
                            onclick="openRecipeSelectorModal()">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫—Ä–∞—Ñ—Ç–æ–≤</button></div>
                    <div id="code-template-visual" contenteditable="true" oninput="syncVisualToHidden()"
                        onfocus="saveState()" onblur="renderVisualTemplate(this.innerText, true)"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —à–∞–±–ª–æ–Ω..."></div>

                    <textarea id="code-template" style="display:none;" oninput="updateTemplate(this.value)"></textarea>
                </div>

                <div class="code-col" style="flex: 0 0 160px;">
                    <div class="code-label">–î–æ—Å—Ç—É–ø–Ω—ã–µ ID</div>
                    <div id="page-elements-list" class="elements-list"></div>
                </div>

                <div class="code-col">
                    <div class="code-label">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
                    <textarea id="code-result" readonly></textarea>
                    <button class="btn success" style="margin-top:5px;" onclick="copyCode()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="vertical-resizer" id="resizer-right"></div>

        <div class="sidebar-right" id="sidebar-right-panel">
            <div class="panel-header">–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê</div>
            <div class="tree-toolbar">
                <button class="btn" onclick="addFolder()" title="–ù–æ–≤–∞—è –ø–∞–ø–∫–∞">+–ü–∞–ø–∫–∞</button>
                <button class="btn" onclick="addPage()" title="–ù–æ–≤—ã–π –ª–∏—Å—Ç">+–õ–∏—Å—Ç</button>
                <button class="btn" onclick="renameNode()" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                <button class="btn danger" onclick="deleteNode()" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
            </div>
            <div class="tree-container" id="project-tree"></div>
            <div class="panel-header" style="text-align:center; font-size:9px; color:#555;">generated by AI and Vinyl_
                tears</div>
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" onclick="execCtx('copy')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="ctx-item" onclick="execCtx('paste')">–í—Å—Ç–∞–≤–∏—Ç—å</div>
        <div class="ctx-item" onclick="execCtx('duplicate')">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å <span class="ctx-shortcut">Ctrl+D</span></div>
        <div class="ctx-separator"></div>
        <div class="ctx-item" onclick="renameSelectedGroup()">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
        <div class="ctx-separator"></div>
        <div class="ctx-item" onclick="execCtx('align')">–í—ã—Ä–æ–≤–Ω—è—Ç—å —Å–µ—Ç–∫—É</div>
        <div class="ctx-separator"></div>
        <div class="ctx-item" onclick="groupSelectedSlots()">–°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="ctx-separator"></div>
        <div class="ctx-item" style="color:#ff7675" onclick="execCtx('delete')">–£–¥–∞–ª–∏—Ç—å <span
                class="ctx-shortcut">Del</span></div>
    </div>

    <div id="quick-actions-panel">
        <h4>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
        <div style="display:flex; flex-direction:column; gap:8px;">
            <button class="btn success" onclick="groupSelectedSlots()" style="justify-content:start;">üì¶ –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å
                –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–µ</button>
            <button class="btn" onclick="alignSelected('grid')" style="justify-content:start;">üî≤ –í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ
                —Å–µ—Ç–∫–µ</button>
            <button class="btn" onclick="enableNamedAutosave(30000)" style="justify-content:start;">‚è±Ô∏è –í–∫–ª.
                –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</button>
            <div style="height:1px; background:#333; margin:5px 0;"></div>
            <button class="btn danger" onclick="clearPageCanvas()" style="justify-content:start;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                —Ö–æ–ª—Å—Ç</button>
        </div>

        <div style="margin-top:10px; font-size:10px; color:#666; border-top:1px solid #333; padding-top:5px;">
            –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:<br>
            Ctrl+S - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å<br>
            Ctrl+F - –ü–æ–∏—Å–∫<br>
            Esc - –°–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è
        </div>
    </div>

    <script>
        function importFullScript(input) {
            const file = input.files[0];
            if (!file) return;

            const fr = new FileReader();
            fr.onload = (e) => {
                const content = e.target.result;

                const recipeRegex = /(?:\w+\.)+\w+\s*\([\s\S]*?<([^>]+)>(?:\.withTag\s*\([\s\S]*?\))?\s*,\s*\[\s*\[([\s\S]*?)\]\s*\]\s*\);/g;

                let match;
                const recipesFound = [];

                while ((match = recipeRegex.exec(content)) !== null) {
                    recipesFound.push({
                        fullMatch: match[0],
                        resultId: match[1],
                        gridContent: match[2]
                    });
                }

                if (recipesFound.length === 0) {
                    alert("–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –∫—Ä–∞—Ñ—Ç–æ–≤!");
                    return;
                }

                if (confirm(`–ù–∞–π–¥–µ–Ω–æ –∫—Ä–∞—Ñ—Ç–æ–≤: ${recipesFound.length}. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–∞–ø–∫—É —Å —ç—Ç–∏–º–∏ –∫—Ä–∞—Ñ—Ç–∞–º–∏?`)) {
                    processScriptRecipes(file.name, recipesFound);
                }
            };
            fr.readAsText(file);
        }

        function processScriptRecipes(fileName, recipes) {
            saveState();

            const folderId = 'folder_' + Date.now();
            const newFolder = {
                id: folderId,
                type: 'folder',
                name: "–ò–º–ø–æ—Ä—Ç: " + fileName,
                expanded: true,
                iconData: null,
                children: []
            };

            recipes.forEach((rec, index) => {
                const pageId = 'p_import_' + Date.now() + '_' + index;
                const itemName = rec.resultId.split(':').pop();

                const dynamicTemplate = createDynamicTemplate(rec);

                const newPage = {
                    id: pageId,
                    type: 'page',
                    name: (index + 1) + ". " + itemName,
                    iconData: null,
                    slots: [],
                    template: dynamicTemplate
                };

                fillImportedPage(newPage, rec);
                newFolder.children.push(newPage);
            });

            projectStructure.push(newFolder);
            renderTree();

            if (newFolder.children.length > 0) {
                loadPage(newFolder.children[0].id);
            }

            saveState();
            alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${recipes.length} –∫—Ä–∞—Ñ—Ç–æ–≤ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —à–∞–±–ª–æ–Ω–∞–º–∏!`);
        }

        function createDynamicTemplate(rec) {
            let template = rec.fullMatch;

            template = template.replace(/<[^>]+>(?:\.withTag\s*\([\s\S]*?\))?(?:\s*\*\s*\d+)?/, "{out1}");

            if (template.includes("Infusion") || template.includes("addRecipe")) {
                template = template.replace(/"([a-z]+\s+\d+[^"]*)"/i, '"{asl1}"');
            }

            const gridMatch = template.match(/\[\s*\[([\s\S]*?)\]\s*\]/);
            if (gridMatch) {
                let innerGrid = gridMatch[1];
                let itemCounter = 1;

                const itemRegex = /<[^>]+>(?:\.withTag\s*\([\s\S]*?\))?(?:\s*\*\s*\d+)?|null/g;

                const templatedGrid = innerGrid.replace(itemRegex, () => {
                    return `{in${itemCounter++}}`;
                });

                template = template.replace(gridMatch[1], templatedGrid);
            }

            return template;
        }

        function fillImportedPage(page, data) {
            const outSlot = {
                id: "out1", type: "item",
                x: 700, y: 150,
                label: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
                content: null, val: "", next: null
            };
            syncItemWithDatabase(outSlot, data.resultId, 1);
            page.slots.push(outSlot);

            const itemRegex = /<([^>]+)>(?:\.withTag\s*\([\s\S]*?\))?(?:\s*\*\s*(\d+))?|null/g;
            const gridItems = [];
            let match;
            while ((match = itemRegex.exec(data.gridContent)) !== null) {
                if (match[0] === 'null') {
                    gridItems.push(null);
                } else {
                    gridItems.push({
                        id: match[1].trim(),
                        count: match[2] ? parseInt(match[2]) : 1
                    });
                }
            }

            const size = gridItems.length > 9 ? 9 : 3;
            const step = 55;
            const startX = 50;
            const startY = 50;

            gridItems.forEach((item, i) => {
                const row = Math.floor(i / size);
                const col = i % size;
                const slot = {
                    id: "in" + (i + 1),
                    type: "item",
                    x: startX + col * step,
                    y: startY + row * step,
                    content: null, val: "", next: null
                };
                if (item) syncItemWithDatabase(slot, item.id, item.count);
                page.slots.push(slot);
            });

            if (page.template.includes("{asl1}")) {
                const aspectMatch = data.fullMatch.match(/"([a-z]+\s+\d+[^"]*)"/i);
                const aslSlot = {
                    id: "asl1", type: "aspect_list",
                    x: startX, y: startY + (size * step) + 30,
                    content: [], val: "", next: null
                };
                if (aspectMatch) {
                    aslSlot.content = aspectMatch[1].split(',').map(part => {
                        const bits = part.trim().split(/\s+/);
                        const name = bits[0].toLowerCase();
                        return {
                            name: name, code: name, val: parseInt(bits[1]) || 1,
                            img: `https://ru.minecraft.wiki/images/Grid_${name.charAt(0).toUpperCase() + name.slice(1)}_(Thaumcraft_4).png`
                        };
                    });
                }
                page.slots.push(aslSlot);
            }
        }
        function importCraftFromText() {
            let input = prompt("–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —Ä–µ—Ü–µ–ø—Ç–∞ (Minetweaker —Å–∫—Ä–∏–ø—Ç):");
            if (!input) return;

            // 1. Remove comments
            let cleanInput = input.replace(/\/\*[\s\S]*?\*\//g, ""); // Remove /* */
            cleanInput = cleanInput.replace(/\/\/.*$/gm, ""); // Remove // (multiline aware)
            cleanInput = cleanInput.replace(/\r?\n|\r/g, " "); // Flatten

            // 2. Split and Strict Filter
            const statements = cleanInput.split(';').map(s => s.trim()).filter(s => {
                const lower = s.toLowerCase();
                if (s.length < 10) return false;

                // Exclusions
                if (lower.includes('shapeless')) return false;
                if (lower.includes('remove')) return false;
                if (lower.includes('tooltip')) return false;

                // Inclusions (Whitelist)
                // Standard Shaped
                if (lower.startsWith('recipes.addshaped')) return true;
                // Avaritia
                if (lower.includes('avaritia') && lower.includes('add')) return true;
                // Mods Machines (generic catch-all for mods.thermal..., mods.enderio...)
                if (lower.startsWith('mods.') && lower.includes('add')) return true;

                return false;
            });

            if (statements.length === 0) {
                alert("–í–∞–ª–∏–¥–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã (Shaped/Machine) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∫–æ–ø–∏—Ä—É–µ—Ç–µ addShaped –∏–ª–∏ mods...add... \n–°—Ç—Ä–æ–∫–∏ remove –∏ Shapeless –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.");
                return;
            }

            // Confirm import
            if (!confirm(`–ù–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤: ${statements.length}.\n–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö?`)) return;

            // If we have multiple statements (or even 1, generic handling is safer now), use Bulk Mode logic for consistency
            if (statements.length >= 1) {
                // Determine target: if only 1, ask if replace current or new page? 
                // For simplicity: if 1 -> Current Page. If > 1 -> New Folder.

                if (statements.length === 1) {
                    // Single Mode
                    const page = findPage(activePageId);
                    if (!page) return;
                    saveState();

                    const pageData = parseRecipeString(statements[0]);
                    if (!pageData) { alert("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞."); return; }

                    ensurePageSlots(page, 'custom', pageData.inputs.length);

                    const outSlot = page.slots.find(s => s.id === 'out');
                    if (outSlot && pageData.result) syncItemWithDatabase(outSlot, pageData.result.id, pageData.result.count);

                    const inSlots = page.slots.filter(s => s.id.startsWith('in'));
                    pageData.inputs.forEach((inp, i) => {
                        if (inp && inSlots[i]) syncItemWithDatabase(inSlots[i], inp.id, inp.count);
                    });

                    page.template = pageData.template; // Update template
                    renderCanvas();
                    generateCode();
                    renderPageElements();
                    saveState();

                } else {
                    // Bulk Mode
                    const folderId = 'folder_imp_' + Date.now();
                    const newFolder = {
                        id: folderId,
                        type: 'folder',
                        name: '–°–∫—Ä–∏–ø—Ç (' + statements.length + ')',
                        expanded: true,
                        children: []
                    };

                    let importedCount = 0;
                    statements.forEach((stmt, idx) => {
                        const pageData = parseRecipeString(stmt);
                        if (pageData) {
                            const pageId = 'page_imp_' + Date.now() + '_' + idx;
                            const newPage = {
                                id: pageId,
                                type: 'page',
                                name: (pageData.outName || 'Rec') + ' ' + (idx + 1),
                                slots: [],
                                template: pageData.template || ''
                            };
                            ensurePageSlots(newPage, 'custom', pageData.inputs.length);

                            const outSlot = newPage.slots.find(s => s.id === 'out');
                            if (outSlot && pageData.result) syncItemWithDatabase(outSlot, pageData.result.id, pageData.result.count);

                            const inSlots = newPage.slots.filter(s => s.id.startsWith('in'));
                            pageData.inputs.forEach((inp, i) => {
                                if (inp && inSlots[i]) syncItemWithDatabase(inSlots[i], inp.id, inp.count);
                            });

                            newFolder.children.push(newPage);
                            importedCount++;
                        }
                    });

                    projectStructure.push(newFolder);
                    renderTree();
                    alert(`–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ —Å ${importedCount} —Ä–µ—Ü–µ–ø—Ç–∞–º–∏.`);
                }
            }
        }
        // Old function placeholder to avoid confusion (removed logic)
        function _unused_old_import() {
            itemRegexGlobal = /<([^>]+)>(?:.withTag\((?:{[^}]*}|[^)])*\))?(?:\s*\*\s*(\d+))?/g;

            // 1. Output
            let resultMatch = null;
            let resultFullId = null;
            let resultCount = 1;
        }

        function parseRecipeString(cleanInput) {
            // Regex strategies
            const itemRegexGlobal = /<([^>]+)>(?:.withTag\((?:{[^}]*}|[^)])*\))?(?:\s*\*\s*(\d+))?/g;

            // 1. Output
            let resultMatch = null;
            let resultFullId = null;
            let resultCount = 1;

            // Try identify output before the first '[' (array start)
            const gridStart = cleanInput.indexOf('[');
            let searchArea = cleanInput;
            if (gridStart > -1) searchArea = cleanInput.substring(0, gridStart);

            let match = itemRegexGlobal.exec(searchArea);
            if (match) {
                resultFullId = match[1].trim();
                resultCount = match[2] ? parseInt(match[2]) : 1;
            } else {
                // Fallback parsing
                const simple = /<([^>]+)>/.exec(cleanInput);
                if (simple) resultFullId = simple[1];
            }
            itemRegexGlobal.lastIndex = 0;

            if (!resultFullId) return null;

            // 2. Inputs (Array content)
            const gridMatch = cleanInput.match(/\[([\s\S]*)\]/);
            let gridContent = "";

            if (gridMatch) {
                gridContent = gridMatch[1];
            } else {
                // Shapeless fallback: content after output
                const idx = cleanInput.indexOf(resultFullId);
                if (idx > -1) gridContent = cleanInput.substring(idx + resultFullId.length);
            }

            const inputs = [];
            const gridItemRegex = /<([^>]+)>(?:.withTag\((?:{[^}]*}|[^)])*\))?(?:\s*\*\s*(\d+))?|null/g;

            while ((match = gridItemRegex.exec(gridContent)) !== null) {
                if (match[0] === 'null') {
                    inputs.push(null);
                } else {
                    inputs.push({ id: match[1].trim(), count: match[2] ? parseInt(match[2]) : 1 });
                }
            }

            // Try to guess template
            let template = "";
            let parts = cleanInput.split('(');
            if (parts.length > 0) template = parts[0] + "({out}, {in})"; // Placeholder

            // Extract item name for page name
            let outName = resultFullId.split(':').pop();

            return {
                result: { id: resultFullId, count: resultCount },
                inputs: inputs,
                template: template,
                outName: outName
            };
        }
        function syncItemWithDatabase(slot, inputId, count) {
            if (!inputId || inputId === 'null') {
                slot.content = null;
                return;
            }

            let found = DB_ITEMS.find(i => i.fullId === inputId);

            if (!found) found = DB_ITEMS.find(i => i.fullId === inputId + ":0");
            if (!found && inputId.endsWith(':0')) found = DB_ITEMS.find(i => i.fullId === inputId.slice(0, -2));

            if (found) {
                slot.content = {
                    type: 'item',
                    code: found.fullId,
                    name: found.loc,
                    count: count
                };
            } else {
                const parts = inputId.split(':');
                let iconName = parts.length > 2 ? parts[0] + ":" + parts[1] : inputId;
                slot.content = {
                    type: 'item',
                    code: inputId,
                    name: iconName,
                    count: count
                };
            }
        }

        function syncWithDB(slot, fullId) {
            if (!fullId || fullId === 'null') {
                slot.content = null;
                return;
            }

            const dbItem = DB_ITEMS.find(item => item.fullId === fullId);

            if (dbItem) {
                slot.content = {
                    type: 'item',
                    code: dbItem.fullId,
                    name: dbItem.loc,
                    count: 1
                };
            } else {
                const parts = fullId.split(':');
                slot.content = {
                    type: 'item',
                    code: fullId,
                    name: parts.length > 2 ? parts[0] + ":" + parts[1] : fullId,
                    count: 1
                };
            }
        }
        function updateStatsDisplay() {
            const stats = getCanvasStats();
            let statsElement = document.getElementById('canvas-stats');
            if (!statsElement) {
                statsElement = document.createElement('div');
                statsElement.id = 'canvas-stats';
                document.getElementById('canvas-viewport').appendChild(statsElement);
            }

            let totalPrice = 0;
            const page = findPage(activePageId);
            if (page) {
                page.slots.forEach(slot => {
                    if (!slot.id.toLowerCase().includes('out') && slot.content && slot.content.code) {
                        let code = slot.content.code;
                        let price = ITEM_PRICES[code];

                        if (price === undefined && code.endsWith(':0')) price = ITEM_PRICES[code.slice(0, -2)];
                        if (price === undefined && !code.includes(':', code.indexOf(':') + 1)) price = ITEM_PRICES[code + ":0"];

                        totalPrice += (price || 0) * (slot.content.count || 1);
                    }
                });
            }

            statsElement.innerHTML = `
                <div style="color: #00b894; font-weight: bold; font-size: 13px; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 3px; text-align: center;">
                    üí∞ Cost: ${totalPrice.toFixed(3)}
                </div>
                <div style="display: flex; gap: 8px; justify-content: center; opacity: 0.6; font-size: 10px;">
                    <span>üì¶ ${stats.slots}</span><span>üîó ${stats.connections}</span>
                </div>
            `;
        }
        let ITEM_PRICES = {};

        function loadPricesFile(input) {
            const fr = new FileReader();
            fr.onload = (e) => {
                const rawContent = e.target.result;
                ITEM_PRICES = {};
                try {
                    const data = JSON.parse(rawContent);
                    if (data.items) {
                        Object.values(data.items).forEach(item => {
                            const key = item.metadata !== 0 ? `${item.registryData}:${item.metadata}` : item.registryData;
                            ITEM_PRICES[key] = parseFloat(item.price);
                        });
                    }
                } catch (err) {
                    rawContent.split(/\r?\n/).forEach(line => {
                        if (!line.includes('-')) return;
                        const [id, price] = line.split('-').map(s => s.trim());
                        if (id && price) ITEM_PRICES[id] = parseFloat(price.replace(',', '.'));
                    });
                }
                console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ü–µ–Ω:", Object.keys(ITEM_PRICES).length);
                renderCanvas();
            };
            fr.readAsText(input.files[0]);
        }
        const DB_LIQUIDS = [
            { name: "acid", code: "acid" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –∞–¥–∞–º–∞–Ω—Ç–∏–Ω", code: "adamantine.molten" }, { name: "–ù–µ–≤–µ—Å–æ–º—ã–π –∞—ç—Ä–æ—Ç–µ—É–º", code: "aerotheum" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –∞–ª—é–º–∏–Ω–∏–π", code: "aluminum.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è –∞–ª—é–º–∏–Ω–∏–µ–≤–∞—è –ª–∞—Ç—É–Ω—å", code: "aluminumbrass.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –∞–ª—é–º–∏—Ç", code: "alumite.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –∞—Ä–¥–∏—Ç", code: "ardite.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –±–µ–¥—Ä–æ–∫–∏–π", code: "bedrockium.molten" }, { name: "–ú–µ—Å—Ç–æ-–∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å", code: "betterquesting.placeholder" }, { name: "–ë–∞–∫—Ç–µ—Ä–∏—è", code: "binnie.bacteria" }, { name: "–ü–æ–ª–∏–º–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –±–∞–∫—Ç–µ—Ä–∏—è", code: "binnie.bacteriapoly" }, { name: "–ë–∞–∫—Ç–µ—Ä–∏—è –í–µ–∫—Ç–æ—Ä", code: "binnie.bacteriavector" }, { name: "–°—ã—Ä–∞—è –î–ù–ö", code: "binnie.dna.raw" }, { name: "–ü–∏—Ç–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞", code: "binnie.growthmedium" }, { name: "–≠—Ç–∞–Ω–æ–ª", code: "bioethanol" }, { name: "–ë–∏–æ—Ç–æ–ø–ª–∏–≤–æ", code: "biofuel" }, { name: "–ë–∏–æ–º–∞—Å—Å–∞", code: "biomass" }, { name: "–ö—Ä–æ–≤—å", code: "blood" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª—É—Ç–æ–Ω–∏–π", code: "blutonium.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è –ª–∞—Ç—É–Ω—å", code: "brass.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è –±—Ä–æ–Ω–∑–∞", code: "bronze.molten" }, { name: "–ú–æ–ª–æ—á–Ω—ã–π —à–æ–∫–æ–ª–∞–¥", code: "chocolatemilk" }, { name: "–û–±–ª–∞—á–Ω–∞—è –≤–æ–¥–∞", code: "cloud_seed" }, { name: "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–∞—è –≤–æ–¥–∞", code: "cloud_seed_concentrated" }, { name: "–†–∞–∑–∂–∏–∂–µ–Ω–Ω—ã–π —É–≥–æ–ª—å", code: "coal" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–±–∞–ª—å—Ç", code: "cobalt.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–æ–≤–æ–¥—è—â–µ–µ –∂–µ–ª–µ–∑–æ", code: "conductive.iron.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è –º–µ–¥—å", code: "copper.molten" }, { name: "–õ–µ–¥—è–Ω–æ–π –∫—Ä–∏–æ—Ç–µ—É–º", code: "cryotheum" }, { name: "fluid.bigreactors.cyanite.still", code: "cyanite" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è —Ç—ë–º–Ω–∞—è —Å—Ç–∞–ª—å", code: "dark.steel.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è –Ω–∞—ç–ª–µ–∫—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞–ª—å", code: "electrical.steel.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π —ç–ª–µ–∫—Ç—Ä—É–º", code: "electrum.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç–∏–π", code: "elementium.molten" }, { name: "–°–∂–∏–∂–µ–Ω–Ω—ã–π –∏–∑—É–º—Ä—É–¥", code: "emerald.liquid" }, { name: "–†–µ–∑–æ–Ω–∏—Ä—É—é—â–∏–π —ç–Ω–¥–µ—Ä–∏—É–º", code: "ender" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π —ç–Ω–¥–µ—Ä–∏—É–º", code: "enderium.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–ª–∞–≤", code: "energetic.alloy.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –≤–æ–ª—à–µ–±–Ω—ã–π –º–µ—Ç–∞–ª–ª", code: "fairy.molten" }, { name: "–û–≥–Ω–µ–Ω–Ω–∞—è –≤–æ–¥–∞", code: "fire_water" }, { name: "–ñ–∏–¥–∫–∞—è —Å–º–µ—Ä—Ç—å", code: "fluiddeath" }, { name: "–û—á–∏—â–∞—é—â–∞—è –∂–∏–¥–∫–æ—Å—Ç—å", code: "fluidpure" }, { name: "–ó–∞—Ä–∞–∂—ë–Ω–Ω–∞—è –∂–∏–∂–∞", code: "fluxgoo" }, { name: "–ú—ë–¥", code: "for.honey" }, { name: "fluid.bigreactors.fuelColumn.still", code: "fuelcolumn" }, { name: "–ñ–∏–¥–∫–æ–µ —Å—Ç–µ–∫–ª–æ", code: "glass" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–æ–µ —Å—Ç–µ–∫–ª–æ", code: "glass.molten" }, { name: "–ó–∞—Ä—è–∂–µ–Ω–Ω—ã–π —Å–≤–µ—Ç—è—â–∏–π—Å—è –∫–∞–º–µ–Ω—å", code: "glowstone" }, { name: "–ö–ª–µ–π", code: "glue" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–æ–µ –∑–æ–ª–æ—Ç–æ", code: "gold.molten" }, { name: "fluid.honey", code: "honey" }, { name: "–°–∞–º–æ–≥–æ–Ω", code: "hootch" }, { name: "–ë–∏–æ–≥–∞–∑", code: "ic2biogas" }, { name: "–ë–∏–æ–º–∞—Å—Å–∞", code: "ic2biomass" }, { name: "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ–Ω–∞", code: "ic2constructionfoam" }, { name: "–•–ª–∞–¥–∞–≥–µ–Ω—Ç (IC2)", code: "ic2coolant" }, { name: "–î–∏—Å—Ç–∏–ª–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–æ–¥–∞", code: "ic2distilledwater" }, { name: "–ì–æ—Ä—è—á–∏–π —Ö–ª–∞–¥–∞–≥–µ–Ω—Ç (IC2)", code: "ic2hotcoolant" }, { name: "–ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞", code: "ic2hotwater" }, { name: "–ë–∞–∑–∞–ª—å—Ç–æ–≤–∞—è –ª–∞–≤–∞", code: "ic2pahoehoelava" }, { name: "–ü–∞—Ä", code: "ic2steam" }, { name: "–ü–µ—Ä–µ–≥—Ä–µ—Ç—ã–π –ø–∞—Ä", code: "ic2superheatedsteam" }, { name: "–ñ–∏–¥–∫–∞—è –º–∞—Ç–µ—Ä–∏—è", code: "ic2uumatter" }, { name: "–ú–æ–ª–æ—Ç—ã–π –ª—ë–¥", code: "ice" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –∏–Ω–≤–∞—Ä", code: "invar.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–æ–µ –∂–µ–ª–µ–∑–æ", code: "iron.molten" }, { name: "–§—Ä—É–∫—Ç–æ–≤—ã–π —Å–æ–∫", code: "juice" }, { name: "fluid.latex", code: "latex" }, { name: "–õ–∞–≤–∞", code: "lava" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π —Å–≤–∏–Ω–µ—Ü", code: "lead.molten" }, { name: "fluid.Life Essence", code: "life essence" }, { name: "–°–æ–ª–Ω–µ—á–Ω–∞—è –≤–æ–¥–∞", code: "liquid_sunshine" }, { name: "–ñ–∏–¥–∫–∏–π –î–ù–ö", code: "liquiddna" }, { name: "fluid.liquidnitrogen", code: "liquidnitrogen" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –ª—É–¥–∏–∫—Ä–∏—Ç", code: "ludicrite.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –ª–∞–º–∏—É–º", code: "lumium.molten" }, { name: "–ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –º–∞–Ω–∞", code: "mana" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è –º–∞–Ω–∞—Å—Ç–∞–ª—å", code: "manasteel.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –º–∞–Ω—É–ª–ª–∏–Ω", code: "manyullyn.molten" }, { name: "–ú–µ–¥–æ–≤—É—Ö–∞", code: "mead" }, { name: "–ñ–∏–¥–∫–∏–π —Ñ–∞—Ä—à", code: "meat" }, { name: "–ú–æ–ª–æ–∫–æ", code: "milk" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –º–∏—Ñ—Ä–∏–ª", code: "mithril.molten" }, { name: "–≠—Å—Å–µ–Ω—Ü–∏—è", code: "mobessence" }, { name: "fluid.molten.bedrockiumIngots", code: "molten.bedrockiumingots" }, { name: "–ü—Ä–æ–ø–∏—Ç–∞–Ω–Ω–æ–µ –∫—Ä–æ–≤—å—é —Ä–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–æ–µ –∂–µ–ª–µ–∑–æ", code: "molten.blood_infused_iron" }, { name: "fluid.molten.unstableIngots", code: "molten.unstableingots" }, { name: "–ì—Ä–∏–±–Ω–æ–π —Å—É–ø", code: "mushroomsoup" }, { name: "–ú—É—Ç–∞–≥–µ–Ω", code: "mutagen" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∏–∫–µ–ª—å", code: "nickel.molten" }, { name: "–ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–π –¥–∏—Å—Ç–∏–ª–ª—è—Ç", code: "nutrient_distillation" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –æ–±—Å–∏–¥–∏–∞–Ω", code: "obsidian.molten" }, { name: "–¢–µ–∫—Ç–æ–Ω–∏—á–µ—Å–∫–∏–π –ø–µ—Ç—Ä–æ—Ç–µ—É–º", code: "petrotheum" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–æ–µ –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–µ –∑–æ–ª–æ—Ç–æ", code: "phased.gold.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–æ–µ –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–µ –∂–µ–ª–µ–∑–æ", code: "phased.iron.molten" }, { name: "–°–≤–∏–Ω–æ–µ –∂–µ–ª–µ–∑–æ", code: "pigiron.molten" }, { name: "–ñ–∏–¥–∫–∞—è —Ä–æ–∑–æ–≤–∞—è —Å–ª–∏–∑—å", code: "pinkslime" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è –ø–ª–∞—Ç–∏–Ω–∞", code: "platinum.molten" }, { name: "fluid.poison", code: "poison" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –ø–æ–∫—Ñ–µ–Ω–∏—É–º", code: "pokefennium.molten" }, { name: "–ü—Ä–æ—Ç–µ–∏–Ω", code: "protein" }, { name: "–ü—ã–ª–∞—é—â–∏–π –ø–∏—Ä–æ—Ç–µ—É–º", code: "pyrotheum" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π –∞—É—Ä—É–º", code: "red.aurum.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–≤–æ–¥—è—â–∏–π –∫—Ä–∞—Å–Ω—ã–π –º–µ—Ç–∞–ª–ª", code: "redmetal.molten" }, { name: "–î–µ—Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π –∫–∞–º–µ–Ω—å", code: "redstone" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π —Å–ø–ª–∞–≤ –∏–∑ –∫—Ä–∞—Å–Ω–æ–≥–æ –∫–∞–º–Ω—è", code: "redstone.alloy.molten" }, { name: "–ñ–∏–¥–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π –∫–∞–º–µ–Ω—å", code: "redstone.molten" }, { name: "fluid.resin", code: "resin" }, { name: "–†–∞–∫–µ—Ç–Ω–æ–µ —Ç–æ–ø–ª–∏–≤–æ", code: "rocket_fuel" }, { name: "fluid.sap", code: "sap" }, { name: "–†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –º–∞—Å–ª–æ", code: "seedoil" }, { name: "–ù–∞–≤–æ–∑", code: "sewage" }, { name: "–ü–∏—Ç–Ω—ã–π –º—ë–¥", code: "short.mead" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∏–Ω–∞–ª", code: "signalum.molten" }, { name: "–ñ–∏–¥–∫–∏–π –∫—Ä–µ–º–Ω–∏–π", code: "silicon.liquid" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–µ—Ä–µ–±—Ä–æ", code: "silver.molten" }, { name: "–ñ–∏–¥–∫–∞—è —Å–∏–Ω—è—è —Å–ª–∏–∑—å", code: "slime.blue" }, { name: "–®–ª–∞–º", code: "sludge" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π —Å–æ—É–ª–∞—Ä–∏–π", code: "soularium.molten" }, { name: "–ü–∞—Ä", code: "steam" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–∞–ª—å", code: "steel.molten" }, { name: "–û–±–æ–∂–∂—ë–Ω–Ω—ã–π –∫–∞–º–µ–Ω—å", code: "stone.seared" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è —Ç–µ—Ä—Ä–∞—Å—Ç–∞–ª—å", code: "terrasteel.molten" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–æ–µ –æ–ª–æ–≤–æ", code: "tin.molten" }, { name: "fluid.turpentine", code: "turpentine" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π –ø—É—Å—Ç–æ—Ç–Ω—ã–π –º–µ—Ç–∞–ª", code: "voidmetal.molten" }, { name: "–í–æ–¥–∞", code: "water" }, { name: "–í–µ–¥—å–º–∏–Ω–∞ –≤–æ–¥–∞", code: "witchwater" }, { name: "–ñ–∏–¥–∫–∏–π –æ–ø—ã—Ç", code: "xpjuice" }, { name: "fluid.bigreactors.yellorium.still", code: "yellorium" }, { name: "–†–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω—ã–π —Ü–∏–Ω–∫", code: "zinc.molten" }
        ];

        const DB_ASPECTS = [
            "aer", "terra", "ignis", "aqua", "ordo", "perditio", "gelum", "lux", "motus", "permutatio",
            "potentia", "tempestas", "vacuos", "venenum", "victus", "vitreus", "bestia", "fames", "herba",
            "iter", "limus", "metallum", "mortuus", "praecantatio", "sano", "tenebrae", "vinculum", "volatus",
            "alienis", "arbor", "auram", "corpus", "exanimis", "spiritus", "vitium", "cognitio", "sensus",
            "humanus", "instrumentum", "lucrum", "messis", "perfodio", "fabrico", "machina", "pannus", "telum",
            "tutamen", "gula", "infernus", "superbia", "desidia", "luxuria", "invidia", "ira", "tempus", "meto", "terminus"
        ];

        const DB_RESEARCH = [
            { name: "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è", code: "RESEARCH" }, { name: "–§—Ä–∞–≥–º–µ–Ω—Ç—ã –∑–Ω–∞–Ω–∏–π", code: "KNOWFRAG" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã", code: "ASPECTS" }, { name: "–ê—É—Ä–∞ –∏ –µ—ë —É–∑–ª—ã", code: "NODES" }, { name: "–†—É–¥—ã", code: "ORE" }, { name: "–†–∞—Å—Ç–µ–Ω–∏—è –∏ –¥–µ—Ä–µ–≤—å—è", code: "PLANTS" }, { name: "–≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞", code: "RESEARCHER1" }, { name: "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ", code: "RESEARCHER2" }, { name: "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π", code: "RESEARCHDUPE" }, { name: "–°—Ç–æ–ª —Ä–∞—Å—â–µ–ø–ª–µ–Ω–∏—è", code: "DECONSTRUCTOR" }, { name: "–û—Å–Ω–æ–≤—ã —Å–æ–∑–¥–∞–Ω–∏—è –∂–µ–∑–ª–æ–≤", code: "BASICTHAUMATURGY" }, { name: "–ñ–µ–ª–µ–∑–Ω–∞—è —Ä–µ—à–µ—Ç–∫–∞", code: "GRATE" }, { name: "–£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å —É–∑–ª–æ–º –∞—É—Ä—ã", code: "NODETAPPER1" }, { name: "–ú–∞—Å—Ç–µ—Ä—Å–∫–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å —É–∑–ª–æ–º –∞—É—Ä—ã", code: "NODETAPPER2" }, { name: "–ë–µ—Ä–µ–∂–ª–∏–≤—ã–π –º–∞–≥", code: "NODEPRESERVE" }, { name: "–¢–∞—É–º–æ–º–µ—Ç—Ä", code: "THAUMOMETER" }, { name: "–û—á–∫–∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è", code: "GOGGLES" },
            { name: "–ú–∞–≥–∏—á–µ—Å–∫–∞—è –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏—è", code: "THAUMIUM" }, { name: "–ù–∏—Ç–æ—Ä", code: "NITOR" }, { name: "–ê–ª—é–º–µ–Ω—Ç—É–º", code: "ALUMENTUM" }, { name: "–ì–æ–ª–æ–¥–Ω—ã–π —Å—É–Ω–¥—É–∫", code: "HUNGRYCHEST" }, { name: "–ó–æ–ª–æ—Ç—ã–µ –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫–∏", code: "CAP_gold" }, { name: "–¢–∞—É–º-–Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫–∏", code: "CAP_thaumium" }, { name: "–°–µ—Ä–µ–±—Ä—è–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫–∏", code: "CAP_silver" }, { name: "–ú–µ–¥–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫–∏", code: "CAP_copper" }, { name: "–°—Ç–µ—Ä–∂–µ–Ω—å –∏–∑ –≤–µ–ª–∏–∫–æ–≥–æ –¥–µ—Ä–µ–≤–∞", code: "ROD_greatwood" }, { name: "–°—Ç–µ—Ä–∂–µ–Ω—å –∏–∑ —Å–µ—Ä–µ–±—Ä—è–Ω–æ–≥–æ –¥–µ—Ä–µ–≤–∞", code: "ROD_silverwood" }, { name: "–°–∫–∏–ø–µ—Ç—Ä—ã", code: "SCEPTRE" }, { name: "–û–±—Å–∏–¥–∏–∞–Ω–æ–≤—ã–π —Å—Ç–µ—Ä–∂–µ–Ω—å", code: "ROD_obsidian" }, { name: "–ö–æ—Å—Ç—è–Ω–æ–π —Å—Ç–µ—Ä–∂–µ–Ω—å", code: "ROD_bone" }, { name: "–û–≥–Ω–µ–Ω–Ω—ã–π —Å—Ç–µ—Ä–∂–µ–Ω—å", code: "ROD_blaze" }, { name: "–õ–µ–¥—è–Ω–æ–π —Å—Ç–µ—Ä–∂–µ–Ω—å", code: "ROD_ice" }, { name: "–ö–≤–∞—Ä—Ü–µ–≤—ã–π —Å—Ç–µ—Ä–∂–µ–Ω—å", code: "ROD_quartz" }, { name: "–¢—Ä–æ—Å—Ç–Ω–∏–∫–æ–≤—ã–π —Å—Ç–µ—Ä–∂–µ–Ω—å", code: "ROD_reed" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–æ—Ö–∏", code: "ROD_greatwood_staff" }, { name: "–°–µ—Ä–µ–±—Ä—è–Ω–æ–¥—Ä–µ–≤–µ—Å–Ω–æ–µ —è–¥—Ä–æ –ø–æ—Å–æ—Ö–∞", code: "ROD_silverwood_staff" }, { name: "–û–±—Å–∏–¥–∏–∞–Ω–æ–≤–æ–µ —è–¥—Ä–æ –ø–æ—Å–æ—Ö–∞", code: "ROD_obsidian_staff" }, { name: "–ö–æ—Å—Ç—è–Ω–æ–µ —è–¥—Ä–æ –ø–æ—Å–æ—Ö–∞", code: "ROD_bone_staff" }, { name: "–û–≥–Ω–µ–Ω–Ω–æ–µ —è–¥—Ä–æ –ø–æ—Å–æ—Ö–∞", code: "ROD_blaze_staff" }, { name: "–õ–µ–¥—è–Ω–æ–µ —è–¥—Ä–æ –ø–æ—Å–æ—Ö–∞", code: "ROD_ice_staff" }, { name: "–ö–≤–∞—Ä—Ü–µ–≤–æ–µ —è–¥—Ä–æ –ø–æ—Å–æ—Ö–∞", code: "ROD_quartz_staff" }, { name: "–¢—Ä–æ—Å—Ç–Ω–∏–∫–æ–≤–æ–µ —è–¥—Ä–æ –ø–æ—Å–æ—Ö–∞", code: "ROD_reed_staff" }, { name: "–°–∏–Ω–≥—É–ª—è—Ä–Ω–æ–µ —è–¥—Ä–æ –ø–æ—Å–æ—Ö–∞", code: "ROD_primal_staff" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫–∏", code: "FOCUSFIRE" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ó–∞–º–æ—Ä–æ–∑–∫–∞", code: "FOCUSFROST" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –®–æ–∫", code: "FOCUSSHOCK" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ö–æ–ø–∞–Ω–∏–µ", code: "FOCUSEXCAVATION" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –†–∞–≤–Ω–æ—Ü–µ–Ω–Ω—ã–π –æ–±–º–µ–Ω", code: "FOCUSTRADE" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: 9 –∫—Ä—É–≥–æ–≤ –∞–¥–∞", code: "FOCUSHELLBAT" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ß–µ—Ä–≤–æ—Ç–æ—á–∏–Ω–∞", code: "FOCUSPORTABLEHOLE" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ", code: "FOCUSWARDING" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –°–∏–Ω–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å", code: "FOCUSPRIMAL" }, { name: "–°—É–º–∫–∞ –¥–ª—è –Ω–∞–±–∞–ª–¥–∞—à–Ω–∏–∫–æ–≤", code: "FOCUSPOUCH" }, { name: "–°–∞–ø–æ–≥–∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞", code: "BOOTSTRAVELLER" }, { name: "–°—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –ø—É–∑—ã—Ä—å–∫–∏", code: "PHIAL" },
            { name: "–°—Ç–æ–ª", code: "TABLE" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –≤–µ—Ä—Å—Ç–∞–∫", code: "ARCTABLE" }, { name: "–°—Ç–æ–ª –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π", code: "RESTABLE" }, { name: "–¢–∞—É–º–æ–Ω–æ–º–∏–∫–æ–Ω", code: "THAUMONOMICON" }, { name: "–ù–∞—á–∞–ª–∞ –∞–ª—Ö–∏–º–∏–∏", code: "CRUCIBLE" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∫–∞–Ω—å", code: "ENCHFABRIC" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏—è", code: "ENCHANT" }, { name: "–¢–æ–ø–æ—Ä –ü–æ—Ç–æ–∫–∞", code: "ELEMENTALAXE" }, { name: "–ö–∏—Ä–∫–∞ –û–≥–Ω—è", code: "ELEMENTALPICK" }, { name: "–ú–µ—á –ë—É—Ä–∏", code: "ELEMENTALSWORD" }, { name: "–õ–æ–ø–∞—Ç–∞ –ó–µ–º–ª–µ—Ä–æ—è", code: "ELEMENTALSHOVEL" }, { name: "–ú–æ—Ç—ã–≥–∞ –†–æ—Å—Ç–∞", code: "ELEMENTALHOE" }, { name: "–ê–ª—Ö–∏–º–∏—è —É–¥–≤–æ–µ–Ω–∏—è", code: "ALCHEMICALDUPLICATION" }, { name: "–ê–ª—Ö–∏–º–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ", code: "ALCHEMICALMANUFACTURE" }, { name: "–≠–Ω—Ç—Ä–æ–ø–∏—è", code: "ENTROPICPROCESSING" }, { name: "–¢—Ä–∞–Ω—Å–º—É—Ç–∞—Ü–∏—è –º–µ—Ç–∞–ª–ª–∞", code: "TRANSIRON" }, { name: "–¢—Ä–∞–Ω—Å–º—É—Ç–∞—Ü–∏—è –∑–æ–ª–æ—Ç–∞", code: "TRANSGOLD" }, { name: "–¢—Ä–∞–Ω—Å–º—É—Ç–∞—Ü–∏—è –º–µ–¥–∏", code: "TRANSCOPPER" }, { name: "–¢—Ä–∞–Ω—Å–º—É—Ç–∞—Ü–∏—è –æ–ª–æ–≤–∞", code: "TRANSTIN" }, { name: "–¢—Ä–∞–Ω—Å–º—É—Ç–∞—Ü–∏—è —Å–µ—Ä–µ–±—Ä–∞", code: "TRANSSILVER" }, { name: "–¢—Ä–∞–Ω—Å–º—É—Ç–∞—Ü–∏—è —Å–≤–∏–Ω—Ü–∞", code: "TRANSLEAD" }, { name: "–û—á–∏—Å—Ç–∫–∞ –º–µ—Ç–∞–ª–ª–∞", code: "PUREIRON" }, { name: "–û—á–∏—Å—Ç–∫–∞ –∑–æ–ª–æ—Ç–∞", code: "PUREGOLD" }, { name: "–û—á–∏—Å—Ç–∫–∞ –º–µ–¥–∏", code: "PURECOPPER" }, { name: "–û—á–∏—Å—Ç–∫–∞ –æ–ª–æ–≤–∞", code: "PURETIN" }, { name: "–û—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–µ–±—Ä–∞", code: "PURESILVER" }, { name: "–û—á–∏—Å—Ç–∫–∞ —Å–≤–∏–Ω—Ü–∞", code: "PURELEAD" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –∂–∏—Ä", code: "TALLOW" }, { name: "–°–æ–ª–æ–º–µ–Ω–Ω—ã–µ –≥–æ–ª–µ–º—ã", code: "GOLEMSTRAW" }, { name: "–î–µ—Ä–µ–≤—è–Ω–Ω—ã–µ –≥–æ–ª–µ–º—ã", code: "GOLEMWOOD" }, { name: "–°–∞–ª—å–Ω—ã–µ –≥–æ–ª–µ–º—ã", code: "GOLEMTALLOW" }, { name: "–ö–∏—Ä–ø–∏—á–Ω—ã–µ –≥–æ–ª–µ–º—ã", code: "GOLEMCLAY" }, { name: "–ì–æ–ª–µ–º—ã –∏–∑ –ø–ª–æ—Ç–∏", code: "GOLEMFLESH" }, { name: "–ö–∞–º–µ–Ω–Ω—ã–µ –≥–æ–ª–µ–º—ã", code: "GOLEMSTONE" }, { name: "–ñ–µ–ª–µ–∑–Ω—ã–µ –≥–æ–ª–µ–º—ã", code: "GOLEMIRON" }, { name: "–¢–∞—É–º-–≥–æ–ª–µ–º—ã", code: "GOLEMTHAUMIUM" }, { name: "–•—Ä—É—Å—Ç–∞–ª—å–Ω—ã–π –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫", code: "GOLEMBELL" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –°–±–æ—Ä", code: "COREGATHER" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –û–ø—É—Å—Ç–æ—à–µ–Ω–∏–µ", code: "COREEMPTY" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ", code: "COREUSE" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ", code: "COREFILL" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –ñ–∞—Ç–≤–∞", code: "COREHARVEST" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –°—Ä—É–±–∫–∞", code: "CORELUMBER" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –û—Ö—Ä–∞–Ω–∞", code: "COREGUARD" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –ó–∞–±–∏–≤–∞–Ω–∏–µ", code: "COREBUTCHER" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –ó–∞–ª–∏–≤–∫–∞", code: "CORELIQUID" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞", code: "CORESORTING" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –†—ã–±–∞–ª–∫–∞", code: "COREFISHING" }, { name: "–°–µ—Ä–¥—Ü–µ –≥–æ–ª–µ–º–∞: –ê–ª—Ö–∏–º–∏—è", code: "COREALCHEMY" }, { name: "–£–ª—É—á—à–µ–Ω–∏–µ –≥–æ–ª–µ–º–∞: –í–æ–∑–¥—É—Ö", code: "UPGRADEAIR" }, { name: "–£–ª—É—á—à–µ–Ω–∏–µ –≥–æ–ª–µ–º–∞: –ó–µ–º–ª—è", code: "UPGRADEEARTH" }, { name: "–£–ª—É—á—à–µ–Ω–∏–µ –≥–æ–ª–µ–º–∞: –û–≥–æ–Ω—å", code: "UPGRADEFIRE" }, { name: "–£–ª—É—á—à–µ–Ω–∏–µ –≥–æ–ª–µ–º–∞: –í–æ–¥–∞", code: "UPGRADEWATER" }, { name: "–£–ª—É—á—à–µ–Ω–∏–µ –≥–æ–ª–µ–º–∞: –ü–æ—Ä—è–¥–æ–∫", code: "UPGRADEORDER" }, { name: "–£–ª—É—á—à–µ–Ω–∏–µ –≥–æ–ª–µ–º–∞: –•–∞–æ—Å", code: "UPGRADEENTROPY" }, { name: "–ú–∞–ª–µ–Ω—å–∫–∏–µ —Ü–∏–ª–∏–Ω–¥—Ä—ã", code: "TINYHAT" }, { name: "–ú–∞–ª–µ–Ω—å–∫–∏–µ —Ñ–µ—Å–∫–∏", code: "TINYFEZ" }, { name: "–ú–∞–ª–µ–Ω—å–∫–∏–µ –±–∞–±–æ—á–∫–∏", code: "TINYBOWTIE" }, { name: "–ú–∞–ª–µ–Ω—å–∫–∏–µ –æ—á–∫–∏", code: "TINYGLASSES" }, { name: "–ê—Ä–±–∞–ª–µ—Ç –≥–æ–ª–µ–º–∞", code: "TINYDART" }, { name: "–ó–∞–±—Ä–∞–ª–æ –≥–æ–ª–µ–º–∞", code: "TINYVISOR" }, { name: "–ë—Ä–æ–Ω–µ–ø–ª–∞—Å—Ç–∏–Ω–∞ –≥–æ–ª–µ–º–∞", code: "TINYARMOR" }, { name: "–ö—É–≤–∞–ª–¥–∞ –≥–æ–ª–µ–º–∞", code: "TINYHAMMER" }, { name: "–û—á–∏—Å—Ç–∫–∞ —ç—Å—Å–µ–Ω—Ü–∏–∏", code: "DISTILESSENTIA" }, { name: "–ë–∞–Ω–∫–∏ –∏ –±–∏—Ä–∫–∏", code: "JARLABEL" }, { name: "–ê–¥—Å–∫–∞—è –ø–µ—á—å", code: "INFERNALFURNACE" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–µ –º–µ—Ö–∞", code: "BELLOWS" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –∫–∞–º–µ–Ω—å", code: "ARCANESTONE" }, { name: "–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –º–∞–≥–∏–µ–π", code: "INFUSION" }, { name: "–ú–æ–∑–≥ –≤ –±–∞–Ω–∫–µ", code: "JARBRAIN" }, { name: "–¢–∞—É–º–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–Ω–µ—Ü", code: "HOVERHARNESS" }, { name: "–¢–∞—É–º–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—è—Å", code: "HOVERGIRDLE" }, { name: "–£–ª—É—á—à–µ–Ω–Ω—ã–µ –≥–æ–ª–µ–º—ã", code: "ADVANCEDGOLEM" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –±—É—Ä", code: "ARCANEBORE" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –ø–æ–¥—ä—ë–º–Ω–∏–∫", code: "LEVITATOR" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–æ–µ–æ–µ —É—Ö–æ", code: "ARCANEEAR" }, { name: "–ó–µ—Ä–∫–∞–ª—å–Ω–∞—è –º–∞–≥–∏—è", code: "MIRROR" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–æ–µ —Ä—É—á–Ω–æ–µ –∑–µ—Ä–∫–∞–ª–æ", code: "MIRRORHAND" }, { name: "–£–∑–µ–ª –∞—É—Ä—ã –≤ –±–∞–Ω–∫–µ", code: "NODEJAR" }, { name: "–ö–∞–º–µ–Ω—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞", code: "PAVETRAVEL" }, { name: "–ö–∞–º–µ–Ω—å —Å–¥–µ—Ä–∂–∏–≤–∞–Ω–∏—è", code: "PAVEWARD" }, { name: "–ü–µ—Ä–µ–∑–∞—Ä—è–¥–æ—á–Ω—ã–π –ø—å–µ–¥–µestal", code: "WANDPED" }, { name: "–†–∞—Å—â–µ–ø–∏—Ç–µ–ª—å –∞—Å–ø–µ–∫—Ç–æ–≤", code: "WANDPEDFOC" }, { name: "–≠—Ñ–∏—Ä–Ω—ã–π —Ü–≤–µ—Ç–æ–∫", code: "ETHEREALBLOOM" }, { name: "–ì–Ω–æ–º—ã", code: "PECH" }, { name: "–ó–∞—á–∞—Ä–æ–≤—ã–≤–∞–Ω–∏–µ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º", code: "INFUSIONENCHANTMENT" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫", code: "ARCANELAMP" }, { name: "–ü–µ—Ä–≤–∏—á–Ω–æ–µ —á—É–¥–æ—Ç–≤–æ—Ä—Å—Ç–≤–æ", code: "BASICARTIFACE" }, { name: "–¢—Ä—É–±—ã –¥–ª—è —ç—Å—Å–µ–Ω—Ü–∏–π", code: "TUBES" }, { name: "–ê–ª—Ö–∏–º–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω—Ç—Ä–∏—Ñ—É–≥–∞", code: "CENTRIFUGE" }, { name: "–•–æ–¥—è—á–∏–π —Å—É–Ω–¥—É–∫", code: "TRAVELTRUNK" }, { name: "–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫ —Ä–æ—Å—Ç–∞", code: "LAMPGROWTH" }, { name: "–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫ —Å–∫—Ä–µ—â–∏–≤–∞–Ω–∏—è", code: "LAMPFERTILITY" }, { name: "–ü—É—Å—Ç–æ—Ç–Ω–∞—è –±–∞–Ω–∫–∞", code: "JARVOID" }, { name: "–£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ç—Ä—É–±—ã", code: "TUBEFILTER" }, { name: "–ó–µ—Ä–∫–∞–ª–∞ –¥–ª—è —ç—Å—Å–µ–Ω—Ü–∏–∏", code: "MIRRORESSENTIA" }, { name: "–ö–æ—Å—Ç—è–Ω–æ–π –ª—É–∫", code: "BONEBOW" }, { name: "–≠–Ω–µ—Ä–≥–æ—Å—Ç—Ä–µ–ª—ã", code: "PRIMALARROW" }, { name: "–ê–≤—Ç–æ–∞–ª—Ö–∏–º–∏—è", code: "THAUMATORIUM" }, { name: "–†—É–Ω–Ω—ã–π —â–∏—Ç", code: "RUNICARMOR" }, { name: "–£—Å–∏–ª–µ–Ω–∏–µ —Ä—É–Ω–Ω–æ–≥–æ —â–∏—Ç–∞", code: "RUNICAUGMENTATION" }, { name: "–≠–Ω–µ—Ä–≥–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª—å—Ü–æ —Ä—É–Ω–Ω–æ–≥–æ —â–∏—Ç–∞", code: "RUNICCHARGED" }, { name: "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–µ–µ –∫–æ–ª—å—Ü–æ —Ä—É–Ω–Ω–æ–≥–æ —â–∏—Ç–∞", code: "RUNICHEALING" }, { name: "–ö–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—è—Å —Ä—É–Ω–Ω–æ–≥–æ —â–∏—Ç–∞", code: "RUNICKINETIC" }, { name: "–ê–º—É–ª–µ—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ —Ä—É–Ω–Ω–æ–≥–æ —â–∏—Ç–∞", code: "RUNICEMERGENCY" }, { name: "–ú–∞–≥–∏—è –∑–∞—â–∏—Ç—ã", code: "WARDEDARCANA" }, { name: "–•—Ä–∞–Ω–∏–ª–∏—â–µ –í–∏—Å", code: "VISAMULET" }, { name: "–£–∑–µ–ª-—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä—ã", code: "NODESTABILIZER" }, { name: "–£–ª—É—á—à–µ–Ω–Ω—ã–µ —É–∑–µ–ª-—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä—ã", code: "NODESTABILIZERADV" }, { name: "–ì–æ–ª–µ–º-–¥–µ–∞–∫—Ç–∏–≤–∞—Ç–æ—Ä", code: "GOLEMFETTER" }, { name: "–ü—Ä–∏—Ä—É—á–µ–Ω–∏–µ –í–∏—Å", code: "VISPOWER" }, { name: "–í–∏—Å-–∑–∞—Ä—è–∂–∞—Ç–µ–ª—å", code: "VISCHARGERELAY" }, { name: "–ò—Å–∫–∞–∂–µ–Ω–∏–µ, –ü–æ—Ä—á–∞ –∏ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ", code: "WARP" }, { name: "–û—á–∏—â–∞—é—â–∞—è —Å–æ–ª—å", code: "BATHSALTS" }, { name: "–ñ–∏–¥–∫–∞—è —Å–º–µ—Ä—Ç—å", code: "LIQUIDDEATH" }, { name: "–ë–æ–µ–≤–æ–π —Ç–∞—É–º-–¥–æ—Å–ø–µ—Ö", code: "ARMORFORTRESS" }, { name: "–®–ª–µ–º –ø—Ä–æ–≤–∏–¥–µ–Ω–∏—è", code: "HELMGOGGLES" }, { name: "–ú–∞—Å–∫–∞ —Å–º–µ—é—â–µ–≥–æ—Å—è –¥—å—è–≤–æ–ª–∞", code: "MASKGRINNINGDEVIL" }, { name: "–ú–∞—Å–∫–∞ –∑–ª–æ–≥–æ –ø—Ä–∏–≤–∏–¥–µ–Ω–∏—è", code: "MASKANGRYGHOST" }, { name: "–ú–∞—Å–∫–∞ —Ç—è–Ω—É—â–µ–≥–æ—Å—è –¥–µ–º–æ–Ω–∞", code: "MASKSIPPINGFIEND" }, { name: "–û—Ç–∫—Ä—ã—Ç–∏–µ –¥—Ä–µ–≤–Ω–æ—Å—Ç–∏", code: "ELDRITCHMINOR" }, { name: "–û—Ç–∫—Ä–æ–≤–µ–Ω–∏–µ –¥—Ä–µ–≤–Ω–æ—Å—Ç–∏", code: "ELDRITCHMAJOR" }, { name: "–ü—É—Å—Ç–æ—Ç–Ω—ã–π –º–µ—Ç–∞–ª–ª", code: "VOIDMETAL" }, { name: "–ü—É—Å—Ç–æ—Ç–Ω–æ–µ –æ–¥–µ—è–Ω–∏–µ", code: "ARMORVOIDFORTRESS" }, { name: "–ü—É—Å—Ç–æ—Ç–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫–∏", code: "CAP_void" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∞—è –≤–∞–Ω–Ω–∞", code: "ARCANESPA" }, { name: "–õ–µ—á–∞—â–µ–µ –º—ã–ª–æ", code: "SANESOAP" }, { name: "–ü—Å–∏—Ö–∏—á–µ—Å–∫–∏–π –¥–µ—Ç–µ–∫—Ç–æ—Ä", code: "SANITYCHECK" }, { name: "–ë–∞–≥—Ä–æ–≤—ã–π –∫—É–ª—å—Ç", code: "CRIMSON" }, { name: "–û—Ç–∫—Ä—ã—Ç–∏–µ –ì–ª–∞–∑–∞", code: "OCULUS" }, { name: "–£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —ç—Å—Å–µ–Ω—Ü–∏–∏", code: "ESSENTIARESERVOIR" }, { name: "–ö—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏—è —ç—Å—Å–µ–Ω—Ü–∏–∏", code: "ESSENTIACRYSTAL" }, { name: "–í—ã–º–ø–µ–ª—ã", code: "BANNERS" }, { name: "–ü–æ—Ä—á–∞ –≤ –±—É—Ç—ã–ª–∫–µ", code: "BOTTLETAINT" }, { name: "–£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞–±–∞–ª–¥–∞—à–Ω–∏–∫–æ–≤", code: "FOCALMANIPULATION" }, { name: "–£–ª—É—á—à–µ–Ω–∏–µ 5 —É—Ä–æ–≤–Ω—è: –ú—ã—à–∏-–≤–∞–º–ø–∏—Ä—ã", code: "VAMPBAT" }, { name: "–°–∏–Ω–≥—É–ª—è—Ä–Ω–∞—è –∂–µ–º—á—É–∂–∏–Ω–∞", code: "PRIMPEARL" }, { name: "–°–∏–Ω–≥—É–ª—è—Ä–Ω—ã–π —É–∑–µ–ª –∞—É—Ä—ã", code: "PRIMNODE" }, { name: "–£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–ª—Ö–∏–º–∏—á–µ—Å–∫–∞—è –ø–µ—á—å", code: "ADVALCHEMYFURNACE" }, { name: "–ü–æ–ª–æ—Ç—ë—Ä –ø–æ—Ä—á–∏", code: "FLUXSCRUB" }, { name: "–í–Ω–µ—à–Ω–∏–µ –ó–µ–º–ª–∏", code: "ENTEROUTER" }, { name: "–û—Ç–∫—Ä—ã—Ç–∏–µ –í–Ω–µ—à–Ω–∏—Ö –ó–µ–º–µ–ª—å", code: "OUTERREV" }, { name: "–ó–ª–æ–≤–µ—â–∏–π –∫–∞–º–µ–Ω—å", code: "SINSTONE" }, { name: "–°–∏–Ω–≥—É–ª—è—Ä–Ω—ã–π –∫—Ä—É—à–∏—Ç–µ–ª—å", code: "PRIMALCRUSHER" },
            { name: "Thaumic Energistics", code: "TERESEARCH" }, { name: "–¶–∏—Ñ—Ä–æ—Å–µ–Ω—Ü–∏—è", code: "TECORES" }, { name: "–•—Ä–∞–Ω–∏–ª–∏—â–µ —Ü–∏—Ñ—Ä–æ—Å–µ–Ω—Ü–∏–∏", code: "TESTORAGE" }, { name: "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ü–∏—Ñ—Ä–æ—Å–µ–Ω—Ü–∏–∏", code: "TEIO" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —Ç–µ—Ä–º–∏–Ω–∞–ª —Å–æ–∑–¥–∞–Ω–∏—è", code: "TEARCANETERM" }, { name: "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç—Å—Å–µ–Ω—Ü–∏–∏", code: "TEESSTERM" }, { name: "–ü–æ—Å—Ç–∞–≤—â–∏–∫ —ç—Å—Å–µ–Ω—Ü–∏–∏", code: "TEESSPROV" }, { name: "–ü–æ—Å—Ç–∞–≤—â–∏–∫ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è", code: "TEINFPROV" }, { name: "–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –í–∏—Å-—Ä–µ–ª–µ", code: "TEVISINT" }, { name: "–ñ–µ–ª–µ–∑–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á", code: "TEIRONGEARBOX" }, { name: "–¢–∞—É–º–∏—á–µ—Å–∫–∞—è –∫–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á", code: "TETHAUMGBOX" }, { name: "–£–¥–≤–æ–µ–Ω–∏–µ –∫–≤–∞—Ä—Ü–∞", code: "TECERTUSDUPE" }, { name: "–í—ã—Å–µ—á–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π", code: "TEKNOWLEDGEINSCRIBER" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä—â–∏–∫", code: "TEARCANEASSEMBLER" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: AE-–∫–ª—é—á", code: "TEFOCUSWRENCH" },
            { name: "–ü–µ—Ä–∏—Ñ–µ—Ä–∏—è Computercraft", code: "PERIPHERALS" }, { name: "–ê—Å–ø–µ–∫—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä", code: "ASPECT_ANALYZER" }, { name: "–ó–∞–∫–æ–ø—Ç–∏–≤—à–∏–π—Å—è –∫–≤–∞—Ä—Ü", code: "DARK_QUARTZ" }, { name: "–¢–æ–º –∑–∞–ø–∏—Å–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π", code: "SHARE_TOME" }, { name: "–¢—Ä–∞–Ω—Å–≤–µ–∫—Ç–æ—Ä", code: "INTERFACE" }, { name: "–ì–æ–ª–µ–º-—Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å", code: "GOLEM_CONNECTOR" }, { name: "–°–≤–µ—Ç—è—â–∏–π—Å—è –≥–∞–∑", code: "GASEOUS_LIGHT" }, { name: "–ì–∞–∑ —Ç–µ–º–Ω–æ—Ç—ã", code: "GASEOUS_SHADOW" }, { name: "–†–∞—Å—Å–µ–∏–≤–∞—Ç–µ–ª—å –≥–∞–∑–∞", code: "GAS_REMOVER" }, { name: "–¢–∫–∞–Ω—å –ø–æ–≥–ª–æ—â–µ–Ω–∏—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π", code: "SPELL_CLOTH" }, { name: "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –¥–æ—â–µ—á–∫–∞", code: "ANIMATION_TABLET" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ü–æ–¥—ä—ë–º", code: "FOCUS_FLIGHT" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ", code: "FOCUS_DISLOCATION" }, { name: "–¢–∞–ª–∏—Å–º–∞–Ω –æ—á–∏—â–µ–Ω–∏—è", code: "CLEANSING_TALISMAN" }, { name: "–ì–∏–ø–µ—Ä—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ù–∏—Ç–æ—Ä", code: "BRIGHT_NITOR" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –¢–µ–ª–µ–∫–∏–Ω–µ–∑", code: "FOCUS_TELEKINESIS" }, { name: "–ö–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏—Ç—è–∂–∞—Ç–µ–ª—å", code: "MAGNETS" }, { name: "–û—Å–º–æ—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–æ–ª –∑–∞—á–∞—Ä–æ–≤–∞–Ω–∏–π", code: "ENCHANTER" }, { name: "–¢–∞–ª–∏—Å–º–∞–Ω —É–¥–µ—Ä–∂–∞–Ω–∏—è", code: "XP_TALISMAN" }, { name: "–í–æ—Ä–æ–Ω–∫–∞ –¥–ª—è —ç—Å—Å–µ–Ω—Ü–∏–∏", code: "FUNNEL" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –ü—Ä—ã–≥—É—á–µ—Å—Ç—å", code: "TTENCH_ASCENT_BOOST" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –ó–∞–º–µ–¥–ª–µ–Ω–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ", code: "TTENCH_SLOW_FALL" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –û–≥–Ω–µ–Ω–Ω–æ–µ –ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏–µ", code: "TTENCH_AUTO_SMELT" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –†–∞–∑—Ä—É—à–µ–Ω–∏–µ", code: "TTENCH_DESINTEGRATE" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –ë—ã—Å—Ç—Ä–∞—è —Å—Ç—Ä–µ–ª—å–±–∞", code: "TTENCH_QUICK_DRAW" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –í–∞–º–ø–∏—Ä–∏–∑–º", code: "TTENCH_VAMPIRISM" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –£–¥–∞—Ä –ø–æ –ø–ª–æ—â–∞–¥–∏", code: "TTENCH_DISPERSED" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —É–¥–∞—Ä", code: "TTENCH_FOCUSED" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –î–æ–±–∏–≤–∞—é—â–∏–π —É–¥–∞—Ä", code: "TTENCH_FINAL" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –•—Ä–∞–±—Ä–æ—Å—Ç—å", code: "TTENCH_VALIANCE" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –¢—É–Ω–Ω–µ–ª—å", code: "TTENCH_TUNNEL" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –û—Å–∫–æ–ª–æ—á–Ω–æ—Å—Ç—å", code: "TTENCH_SHATTER" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –£–¥–∞—Ä–Ω–∞—è –≤–æ–ª–Ω–∞", code: "TTENCH_SHOCKWAVE" }, { name: "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ: –ù–∞—Å–∫–æ–∫", code: "TTENCH_POUNCE" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ü–ª–∞–º—è –∏—Ñ—Ä–∏—Ç–∞", code: "FOCUS_SMELT" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –õ–µ—á–µ–Ω–∏–µ", code: "FOCUS_HEAL" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –í–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –ö—Ä–∞—è", code: "FOCUS_ENDER_CHEST" }, { name: "–ü—Ä–æ–∫–ª—è—Ç–æ–µ –ª–µ–∑–≤–∏–µ –¥—É—Ö–∞", code: "BLOOD_SWORD" }, { name: "–ü—Ä–∏–∑—ã–≤ —Å—É—â–µ—Å—Ç–≤", code: "SUMMON" }, { name: "–¢—Ä–∞–Ω—Å–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –¥–∏—Å–ª–æ–∫–∞—Ç–æ—Ä", code: "DISLOCATOR" }, { name: "–®–ª–µ–º –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è", code: "REVEALING_HELM" }, { name: "–¢–∞—É–º-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å", code: "REPAIRER" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ò—Å–∫–∞–∂–µ–Ω–∏–µ", code: "FOCUS_DEFLECT" }, { name: "–õ–µ–≤–∏—Ç–∞—Ç–æ—Ä", code: "LEVITATOR_LOCOMOTIVE" }, { name: "–≠—Ñ–∏—Ä–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞", code: "PLATFORM" }, { name: "–ö—Ä–∏—Å—Ç–∞–ª–ª—ã –∏–∑–º–µ—Ä–µ–Ω–∏–π", code: "DIMENSION_SHARDS" }, { name: "–ò—Ö–æ—Ä", code: "ICHOR" }, { name: "–ò—Ö–æ—Ä–æ–≤–∞—è —Ç–∫–∞–Ω—å", code: "ICHOR_CLOTH" }, { name: "–ò—Ö–æ—Ä–∏–π", code: "ICHORIUM" }, { name: "–ò—Ö–æ—Ä–Ω—ã–π —Å–µ—Ä–µ–±—Ä–æ–¥—Ä–µ–≤–µ—Å–Ω—ã–π —Å—Ç–µ—Ä–∂–µ–Ω—å", code: "ROD_ICHORCLOTH" }, { name: "–ò—Ö–æ—Ä–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫–∏", code: "CAP_ICHOR" }, { name: "–ò—Ö–æ—Ä–æ–≤–∞—è –º–∞–Ω—Ç–∏—è", code: "ICHORCLOTH_ARMOR" }, { name: "–ö–∞–ø—é—à–æ–Ω –∞–¥—Å–∫–∏—Ö –≥–ª—É–±–∏–Ω", code: "ICHORCLOTH_HELM_GEM" }, { name: "–†–æ–±–∞ —Å—Ç—Ä–∞—Ç–æ—Å—Ñ–µ—Ä—ã", code: "ICHORCLOTH_CHEST_GEM" }, { name: "–ü—ã–ª–∞—é—â–∏–µ —à–∞—Ä–æ–≤–∞—Ä—ã", code: "ICHORCLOTH_LEGS_GEM" }, { name: "–°–∞–ø–æ–≥–∏ —â–∏—Ç–∞", code: "ICHORCLOTH_BOOTS_GEM" }, { name: "–ö–æ—à–∞—á–∏–π –∞–º—É–ª–µ—Ç", code: "CAT_AMULET" }, { name: "–ò—Ö–æ—Ä–∏–µ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", code: "ICHOR_TOOLS" }, { name: "–ü—Ä–æ–±—É–∂–¥—ë–Ω–Ω–∞—è –∏—Ö–æ—Ä–∏–µ–≤–∞—è –∫–∏—Ä–∫–∞", code: "ICHOR_PICK_GEM" }, { name: "–ü—Ä–æ–±—É–∂–¥—ë–Ω–Ω–∞—è –∏—Ö–æ—Ä–∏–µ–≤–∞—è –ª–æ–ø–∞—Ç–∞", code: "ICHOR_SHOVEL_GEM" }, { name: "–ü—Ä–æ–±—É–∂–¥—ë–Ω–Ω—ã–π –∏—Ö–æ—Ä–∏–µ–≤—ã–π —Ç–æ–ø–æ—Ä", code: "ICHOR_AXE_GEM" }, { name: "–ü—Ä–æ–±—É–∂–¥—ë–Ω–Ω—ã–π –∏—Ö–æ—Ä–∏–µ–≤—ã–π –º–µ—á", code: "ICHOR_SWORD_GEM" }, { name: "–ë–µ–∑–¥–æ–Ω–Ω–∞—è —Å—É–º–∫–∞", code: "ICHOR_POUCH" }, { name: "–ö–æ–ª—å—Ü–æ —á–µ—Ä–Ω–æ–π –¥—ã—Ä—ã", code: "BLOCK_TALISMAN" }, { name: "–¢–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥–æ–≤–æ–µ —Å—Ç–µ–∫–ª–æ", code: "PLACEMENT_MIRROR" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –¢–µ–Ω–µ–≤–æ–π –ª—É—á", code: "FOCUS_SHADOWBEAM" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –í—ã—Å–∞—Å—ã–≤–∞–Ω–∏–µ –æ–ø—ã—Ç–∞", code: "FOCUS_XP_DRAIN" }, { name: "–ü—Ä–æ—Ç–æ–≥–ª–∏–Ω–∞", code: "PROTOCLAY" }, { name: "–ù–µ–±–µ—Å–Ω—ã–µ –ø–æ—Ä—Ç–∞–ª—ã", code: "WARP_GATE" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ù–µ–±–µ—Å–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ", code: "FOCUS_RECALL" }, { name: "–≠–ª–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ–≥–æ–Ω—å: Ignis", code: "FIRE_IGNIS" }, { name: "–≠–ª–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ–≥–æ–Ω—å: Aqua", code: "FIRE_AQUA" }, { name: "–≠–ª–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ–≥–æ–Ω—å: Aer", code: "FIRE_AER" }, { name: "–≠–ª–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ–≥–æ–Ω—å: Terra", code: "FIRE_TERRA" }, { name: "–≠–ª–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ–≥–æ–Ω—å: Ordo", code: "FIRE_ORDO" }, { name: "–≠–ª–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ–≥–æ–Ω—å: Perditio", code: "FIRE_PERDITIO" }, { name: "–ù–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Å–µ–º–µ–Ω–∞", code: "INFUSED_POTIONS" },
            { name: "–¢—Ä–µ–≤–æ–∂–Ω–∞—è –Ω–∞—Ö–æ–¥–∫–∞", code: "TAINTEDMAGIC" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —Ñ—É–Ω–≥—É–∞—Ä", code: "MAGICFUNGUAR" }, { name: "–¢–µ–Ω–µ–≤–æ–π –º–µ—Ç–∞–ª–ª", code: "SHADOWMETAL" }, { name: "–ù–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã", code: "EVILSHARDS" }, { name: "–¢–µ–Ω–µ–≤–æ–π –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫", code: "CAP_shadowmetal" }, { name: "–¢–∫–∞–Ω–µ–≤—ã–π –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫", code: "CAP_cloth" }, { name: "–¢–µ–Ω–µ–≤–∞—è —Ç–∫–∞–Ω—å", code: "SHADOWCLOTH" }, { name: "–¢–µ–Ω–µ–≤–æ–π —Ç–∫–∞–Ω–µ–≤—ã–π –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫", code: "CAP_shadowcloth" }, { name: "–¢–µ–Ω–µ–≤–∞—è –±—Ä–æ–Ω—è", code: "SHADOWFORTRESSARMOR" }, { name: "–¢–µ–Ω–µ–≤—ã–µ –æ—á–∫–∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è", code: "WARPEDGOGGLES" }, { name: "–ü—É—Å—Ç–æ—Ç–Ω—ã–µ –æ—á–∫–∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è", code: "VOIDGOGGLES" }, { name: "–ò—Å–∫–∞–∂—ë–Ω–Ω—ã–π —Å—Ç–µ—Ä–∂–µ–Ω—å", code: "ROD_warpwood" }, { name: "–ò—Å–∫–∞–∂—ë–Ω–Ω–æ–µ —è–¥—Ä–æ –ø–æ—Å–æ—Ö–∞", code: "ROD_warpwood_staff" }, { name: "–ö—Ä–æ–≤–∞–≤–∞—è —Ç–∫–∞–Ω—å", code: "CRIMSONROBES" }, { name: "–ü—É—Å—Ç–æ—Ç–Ω—ã–µ –¥–æ—Å–ø–µ—Ö–∏", code: "VOIDFORTRESS" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ó–∞—Ä–∞–∂—ë–Ω–Ω—ã–π —à—Ç–æ—Ä–º", code: "TAINTFOCUS" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –¢—ë–º–Ω–∞—è –º–∞—Ç–µ—Ä–∏—è", code: "ELDRITCHFOCUS" }, { name: "–ë–∞–≥—Ä–æ–≤–∞—è –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏—è", code: "KNIGHTROBES" }, { name: "–î–æ—Å–ø–µ—Ö–∏ –ü—Ä–µ—Ç–æ—Ä–∞", code: "PRAETORARMOR" }, { name: "–ò—Å–∫–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ", code: "WARPTREE" }, { name: "–ü—É—Å—Ç–æ—Ç–Ω—ã–µ –±–æ—Ç–∏–Ω–∫–∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞", code: "VOIDWALKERBOOTS" }, { name: "–ö—Ä–∏—Å—Ç–∞–ª–ª –°–æ–∑–∏–¥–∞–Ω–∏—è", code: "CREATIONSHARD" }, { name: "–°–æ–∑–∏–¥–∞–Ω–∏–µ", code: "CREATION" }, { name: "–¢–∞—É–º-—Ä–∞—Å—â–µ–ø–∏—Ç–µ–ª—å", code: "THAUMICDISASSEMBLER" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –í—Ä–µ–º—è", code: "FOCUSTIME" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ü–æ–≥–æ–¥–∞", code: "FOCUSWEATHER" }, { name: "–ü—É—Å—Ç–æ—Ç–Ω—ã–π –ø–æ—è—Å —Ä—É–Ω–∏—á–µ—Å–∫–æ–≥–æ —â–∏—Ç–∞", code: "VOIDSASH" }, { name: "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π –∫–∏–Ω–∂–∞–ª", code: "CRYSTALDAGGER" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ë—É–ª–∞–≤–∞ –º–∞–≥–∞", code: "MACEFOCUS" }, { name: "–ë–∞–≥—Ä–æ–≤—ã–π –º–µ—á", code: "CRIMSONBLADE" }, { name: "–ë–∞–≥—Ä–æ–≤—ã–π –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫", code: "CAP_crimsoncloth" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –ó–∞—Ä–∞–∂—ë–Ω–Ω–∞—è –≤–æ–ª–Ω–∞", code: "FOCUSTAINTEDBLAST" }, { name: "–°–∏–Ω–≥—É–ª—è—Ä–Ω—ã–π –º–µ—á", code: "PRIMALBLADE" }, { name: "–£–ª—É—á—à–µ–Ω–∏–µ 5 —É—Ä–æ–≤–Ω—è: –ö—Ä–æ–≤–æ–∂–∞–¥–Ω–æ—Å—Ç—å", code: "BLOODLUSTUPGRADE" }, { name: "–ü—É–∑—ã—Ä—ë–∫ –ø—É—Å—Ç–æ—Ç–Ω–æ–π –∫—Ä–æ–≤–∏", code: "VOIDSENTBLOOD" }, { name: "–¢–∞—É–º-–∫–∞—Ç–∞–Ω–∞", code: "THAUMIUMKATANA" }, { name: "–ü—É—Å—Ç–æ—Ç–Ω–∞—è –∫–∞—Ç–∞–Ω–∞", code: "VOIDMETALKATANA" }, { name: "–¢–µ–Ω–µ–≤–∞—è –∫–∞—Ç–∞–Ω–∞", code: "SHADOWMETALKATANA" }, { name: "–û–≥–Ω–µ–Ω–Ω–æ–µ –Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ", code: "INSCRIPTIONFIRE" }, { name: "–ú–∞–≥–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ", code: "INSCRIPTIONTAINT" }, { name: "–ë–µ—Å—Å–º–µ—Ä—Ç–Ω–æ–µ –Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ", code: "INSCRIPTIONUNDEAD" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –û—Å–∫–æ–ª–æ–∫ –í–∏—Å", code: "FOCUSSHARD" }, { name: "–ù–∞–±–∞–ª–¥–∞—à–Ω–∏–∫: –°–≤–µ—Ç", code: "FOCUSLUMOS" }, { name: "–§–ª—É—Ç–∏–π—Å–∫–∏–π —á–∞—Ä–º", code: "FLYTECHARM" }
        ];

        let DB_ITEMS = [];

        let projectStructure = [{
            id: 'proj_default',
            type: 'folder',
            name: '–ú–æ–π –ü—Ä–æ–µ–∫—Ç',
            expanded: true,
            iconData: null,
            children: [{
                id: 'page_1',
                type: 'page',
                name: '–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1',
                iconData: null,
                slots: [],
                template: ''
            }]
        }];

        let activePageId = 'page_1';
        let currentLibMode = 'items';
        let isEditMode = false;
        let selectedSlotIds = new Set();
        let selectedNodeId = null;
        let canvasScale = 1.0;

        let isDraggingSelection = false;
        let dragStartMousePos = { x: 0, y: 0 };
        let initialSlotPositions = {};
        let isMarqueeActive = false;
        let marqueeStart = { x: 0, y: 0 };
        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        let panScrollStart = { x: 0, y: 0 };

        let isLinkMode = false;
        let linkStartId = null;

        let history = [];
        let historyStep = -1;

        let draggedTreeNodeId = null;
        let draggedTreeNodeType = null;

        let appClipboard = null;
        const AUTOSAVE_INTERVAL = 5000;
        let autosaveInterval = null;

        window.onload = function () {
            loadFromAutoSave();
            saveState();
            renderTree();
            loadPage(activePageId || 'page_1');

            // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –∏–∑ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
            if (!DB_ITEMS || DB_ITEMS.length === 0) {
                const storedItems = localStorage.getItem('cubix_items_db');
                if (storedItems) {
                    try {
                        DB_ITEMS = JSON.parse(storedItems);
                        console.log("–ë–∞–∑–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –ø–∞–º—è—Ç–∏:", DB_ITEMS.length);
                        renderLibrary();
                    } catch (e) { console.error("–û—à–∏–±–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤", e); }
                }
            }

            // –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ (—Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞)
            tryAutoLoadItems();

            renderLibrary();

            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
                if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) { e.preventDefault(); redo(); }
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') { e.preventDefault(); duplicateSelection(); }
                if (e.key === 'Delete') { deleteSelectedSlots(); }
                if (e.ctrlKey && e.shiftKey && e.key === 'S') { e.preventDefault(); exportItemsDB(); }
                if (e.ctrlKey && e.key === 'f') { e.preventDefault(); document.getElementById('lib-search').focus(); }
                if (e.key === 'Escape') { selectedSlotIds.clear(); renderCanvas(); updateBuilderInputs(); }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.slot.list')) closeAllDropdowns();
                document.getElementById('context-menu').style.display = 'none';
                if (!e.target.closest('#quick-actions-panel') && !e.target.closest('.quick-action-btn')) {
                    document.getElementById('quick-actions-panel').style.display = 'none';
                }
            });

            // setInterval(autoSave, AUTOSAVE_INTERVAL);
            setupResizers();
            setupTemplateDrop();
        };

        async function tryAutoLoadItems() {
            try {
                const response = await fetch('Items.csv');
                if (response.ok) {
                    const csvText = await response.text();
                    processItemsCSV(csvText);
                    console.log("Items.csv –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –ø–∞–ø–∫–∏.");
                }
            } catch (e) {
                console.log("–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ Items.csv –Ω–µ —É–¥–∞–ª–∞—Å—å (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –≤—ã–±–æ—Ä –≤—Ä—É—á–Ω—É—é).");
            }
        }

        function autoSave() {
            localStorage.setItem('cubix_autosave', JSON.stringify(projectStructure));
        }

        function loadFromAutoSave() {
            const s = localStorage.getItem('cubix_autosave');
            if (s) {
                try {
                    projectStructure = JSON.parse(s);
                } catch (e) {
                    console.error('Error loading autosave:', e);
                }
            }
        }

        function saveState() {
            if (historyStep < history.length - 1) {
                history = history.slice(0, historyStep + 1);
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∏ —Ç–µ–∫—É—â—É—é –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            history.push(JSON.stringify({
                project: projectStructure,
                activePage: activePageId
            }));
            historyStep++;
            if (history.length > 50) {
                history.shift();
                historyStep--;
            }
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                restoreState();
            }
        }

        function redo() {
            if (historyStep < history.length - 1) {
                historyStep++;
                restoreState();
            }
        }

        function restoreState() {
            if (!history[historyStep]) return;
            const state = JSON.parse(history[historyStep]);
            projectStructure = state.project;
            activePageId = state.activePage;

            const p = findPage(activePageId);
            if (p) {
                const templateArea = document.getElementById('code-template');
                if (templateArea) templateArea.value = p.template || '';
                renderVisualTemplate(p.template || "");
            }

            renderTree();
            renderCanvas();
            updateBuilderInputs();
            generateCode();
        }

        function copySelection() {
            if (selectedSlotIds.size === 0) return;
            const page = findPage(activePageId);
            const slotsToCopy = page.slots.filter(s => selectedSlotIds.has(s.id));
            appClipboard = JSON.parse(JSON.stringify(slotsToCopy));
        }

        function pasteSelection() {
            if (!appClipboard || !isEditMode) return;
            saveState();
            const page = findPage(activePageId);
            selectedSlotIds.clear();

            appClipboard.forEach(clipSlot => {
                let baseId = clipSlot.id.replace(/\d+$/, '');
                if (!baseId) baseId = 'copy';
                let count = 1;
                while (page.slots.find(s => s.id === baseId + count)) {
                    count++;
                }
                const newId = baseId + count;

                const newSlot = JSON.parse(JSON.stringify(clipSlot));
                newSlot.id = newId;
                newSlot.x += 20;
                newSlot.y += 20;
                newSlot.next = null;

                page.slots.push(newSlot);
                selectedSlotIds.add(newId);
            });

            renderCanvas();
            updateBuilderInputs();
            generateCode();
            saveState();
        }

        function duplicateSelection() {
            copySelection();
            pasteSelection();
        }

        function handleContextMenu(e) {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            menu.style.display = 'flex';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';

            if (!e.target.closest('.slot')) {
                if (!e.ctrlKey) {
                    selectedSlotIds.clear();
                    renderCanvas();
                    updateBuilderInputs();
                }
            }
        }

        function execCtx(action) {
            document.getElementById('context-menu').style.display = 'none';
            if (action === 'copy') copySelection();
            if (action === 'paste') pasteSelection();
            if (action === 'duplicate') duplicateSelection();
            if (action === 'delete') deleteSelectedSlots();
            if (action === 'align') alignSelected('grid');
        }

        function setLibMode(mode, el) {
            currentLibMode = mode;
            document.querySelectorAll('.lib-tab-v').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('lib-search').value = '';
            renderLibrary();
        }

        function renderLibrary() {
            const cont = document.getElementById('library-container');
            const search = document.getElementById('lib-search').value.trim();
            let html = '';

            const getFiltered = (arr) => arr.filter(item => checkMatch(item, search));

            if (currentLibMode === 'items') {
                if (DB_ITEMS.length === 0) {
                    html = '<div style="padding:10px; color:#666; text-align:center;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Items.csv</div>';
                } else {
                    html = getFiltered(DB_ITEMS).slice(0, 150).map(i => `
                <div class="lib-card" draggable="true" ondragstart="dragStartLib(event, 'item', '${i.fullId}', '${i.loc}')">
                    <img src="itempanel_icons/${i.loc}.png" onerror="this.style.opacity='0.2'">
                    <div>
                        <b>${i.loc}</b><br>
                        <span style="color:#666; font-family:monospace; font-size:9px;">${i.fullId}</span>
                    </div>
                </div>
            `).join('');
                }
            } else if (currentLibMode === 'liquids') {
                html = getFiltered(DB_LIQUIDS).map(l => `
            <div class="lib-card fluid-card" draggable="true" ondragstart="dragStartLib(event, 'fluid', '${l.code}', '${l.name}')">
                <div style="position:relative; width:24px; height:24px; flex-shrink:0;">
                    <div class="missing-texture" style="width:24px; height:24px;"></div>
                    <img src="itempanel_icons/${l.name}.png" style="position:absolute; top:0; left:0; width:24px; height:24px;" onerror="this.style.display='none'">
                </div>
                <div><b>${l.name}</b><br><span style="color:#555; font-size:9px;">${l.code}</span></div>
            </div>
        `).join('');
            } else if (currentLibMode === 'aspects') {
                html = getFiltered(DB_ASPECTS).map(a => {
                    const img = `https://ru.minecraft.wiki/images/Grid_${a.charAt(0).toUpperCase() + a.slice(1)}_(Thaumcraft_4).png`;
                    return `
                <div class="lib-card aspect-card" draggable="true" ondragstart="dragStartLib(event, 'aspect', '${a}', '${a}', '${img}')">
                    <img src="${img}" onerror="this.style.opacity='0.3'">
                    <div><b>${a}</b></div>
                </div>
            `;
                }).join('');
            } else if (currentLibMode === 'research') {
                html = getFiltered(DB_RESEARCH).map(r => `
            <div class="lib-card research-card" draggable="true" ondragstart="dragStartLib(event, 'research', '${r.code}', '${r.name}')">
                <img src="https://ru.minecraft.wiki/images/6/64/Grid_Thaumonomicon_(Thaumcraft_4).png" style="width:24px;">
                <div><b>${r.name}</b><br><span style="color:#555; font-size:9px;">${r.code}</span></div>
            </div>
        `).join('');
            }

            cont.innerHTML = html || '<div style="padding:20px; color:#555; text-align:center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        }

        function dragStartLib(e, type, code, name, img) {
            e.dataTransfer.setData('json', JSON.stringify({
                type,
                code,
                name,
                count: 1,
                img
            }));
        }


        // --- TOOLTIP LOGIC ---
        window.showTooltip = function (e, name, code) {
            const tooltip = document.getElementById('item-tooltip');
            if (!tooltip) return;
            const nameEl = document.getElementById('tooltip-name');
            const codeEl = document.getElementById('tooltip-code');

            if (!name && !code) return;

            nameEl.innerText = name || "---";
            codeEl.innerText = code || "";

            tooltip.style.display = 'block';
            updateTooltipPos(e);
        };

        window.updateTooltipPos = function (e) {
            const tooltip = document.getElementById('item-tooltip');
            if (!tooltip) return;
            let x = e.clientX + 15;
            let y = e.clientY + 15;

            const tw = tooltip.offsetWidth;
            const th = tooltip.offsetHeight;
            if (x > window.innerWidth - tw - 20) x = e.clientX - tw - 15;
            if (y > window.innerHeight - th - 20) y = e.clientY - th - 15;

            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        };

        window.hideTooltip = function () {
            const tooltip = document.getElementById('item-tooltip');
            if (tooltip) tooltip.style.display = 'none';
        };

        // --- CANVAS ---
        function changeZoom(delta) {
            canvasScale = Math.max(0.2, Math.min(3.0, canvasScale + delta));
            document.getElementById('zoom-label').innerText = Math.round(canvasScale * 100) + "%";
            document.getElementById('canvas-content').style.transform = `scale(${canvasScale})`;
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-mode-btn');
            btn.innerText = isEditMode ? "üîßMODE:EDIT" : "üîßMODE:CRAFT";

            const sidebarLeft = document.getElementById('sidebar-left-panel');
            const resizerLeft = document.getElementById('resizer-left');

            if (isEditMode) {
                sidebarLeft.classList.add('collapsed');
                resizerLeft.classList.add('collapsed');
            } else {
                sidebarLeft.classList.remove('collapsed');
                resizerLeft.classList.remove('collapsed');
            }

            const builderControls = document.getElementById('builder-controls');
            const alignPanel = document.getElementById('align-tools-panel');

            if (isEditMode) {
                builderControls.style.display = 'flex';
                alignPanel.style.display = 'flex';
            } else {
                builderControls.style.display = 'none';
                alignPanel.style.display = 'none';
            }

            const viewport = document.getElementById('canvas-viewport');
            if (isEditMode) {
                viewport.classList.remove('craft-mode');
            } else {
                viewport.classList.add('craft-mode');
            }

            selectedSlotIds.clear();
            updateBuilderInputs();
            renderCanvas();

            if (isLinkMode) {
                toggleLinkMode();
            }
        }

        function toggleLinkMode() {
            isLinkMode = !isLinkMode;
            const btn = document.getElementById('btn-link-mode');
            if (isLinkMode) {
                btn.classList.add('active');
                linkStartId = null;
            } else {
                btn.classList.remove('active');
                linkStartId = null;
            }
            renderCanvas();
        }

        let openDropdownId = null;

        function toggleDropdown(id) {
            if (openDropdownId && openDropdownId !== id) {
                document.getElementById('dropdown-' + openDropdownId)?.classList.remove('open');
            }
            const dd = document.getElementById('dropdown-' + id);
            if (dd) {
                if (dd.classList.contains('open')) {
                    dd.classList.remove('open');
                    openDropdownId = null;
                } else {
                    dd.classList.add('open');
                    openDropdownId = id;
                }
            }
        }

        function closeAllDropdowns() {
            if (openDropdownId) {
                document.getElementById('dropdown-' + openDropdownId)?.classList.remove('open');
                openDropdownId = null;
            }
        }

        window.updatePairListOptions = function (id, text) {
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === id);
            if (slot) {
                slot.options = text.split('\n').filter(line => line.trim() !== "").map(line => {
                    const parts = line.split(':');
                    return {
                        label: parts[0] ? parts[0].trim() : "–ë–µ–∑ –∏–º–µ–Ω–∏",
                        value: parts[1] ? parts[1].trim() : (parts[0] ? parts[0].trim() : "")
                    };
                });
                generateCode();
            }
        };

        function renderCanvas() {
            const page = findPage(activePageId);
            const container = document.getElementById('canvas-slots-layer');
            if (!container || !page) return;
            container.innerHTML = '';
            renderConnections(page);

            page.slots.forEach(slot => {
                const el = document.createElement('div');
                el.id = 'slot-div-' + slot.id;

                const isSelected = isEditMode && selectedSlotIds.has(slot.id);

                el.className = `slot ${slot.type} ${isEditMode ? 'editing' : ''} ${isSelected ? 'selected' : ''}`;

                el.onmouseenter = (e) => {
                    if (!isEditMode && slot.content && slot.type !== 'aspect_list' && slot.type !== 'item_array') {
                        showTooltip(e, slot.content.name, slot.content.code);
                    }
                    if (typeof highlightTemplateBlocks === "function") highlightTemplateBlocks(slot.id, true);
                };
                el.onmousemove = (e) => {
                    if (!isEditMode && slot.content && slot.type !== 'aspect_list' && slot.type !== 'item_array') {
                        updateTooltipPos(e);
                    }
                };
                el.onmouseleave = () => {
                    hideTooltip();
                    if (typeof highlightTemplateBlocks === "function") highlightTemplateBlocks(slot.id, false);
                };

                el.style.left = slot.x + 'px';
                el.style.top = slot.y + 'px';
                if (slot.width) el.style.width = slot.width + 'px';
                if (slot.height) el.style.height = slot.height + 'px';
                let htmlContent = '';

                if (slot.label) {
                    htmlContent += `<div class="slot-custom-label">${slot.label}</div>`;
                }

                if (isEditMode) {
                    if (slot.type === 'list') {
                        const currentText = (slot.options || []).join('\n');
                        htmlContent += `
                            <textarea class="slot-input" 
                                placeholder="–ü—É–Ω–∫—Ç 1\n–ü—É–Ω–∫—Ç 2..." 
                                onmousedown="event.stopPropagation()" 
                                oninput="updateListOptionsDirect('${slot.id}', this.value)"
                                onblur="saveState()">${currentText}</textarea>`;
                    }
                    else if (slot.type === 'pair_list') {
                        const currentText = (slot.options || []).map(o => `${o.label}:${o.value}`).join('\n');
                        htmlContent += `
        <div style="display:flex; flex-direction:column; gap:4px; width:100%; height:100%;">
            <input type="text" class="slot-input" 
                style="height:24px; font-size:11px; padding:4px 8px;" 
                placeholder="üîç –ü–æ–∏—Å–∫ –≤ —Å–ø–∏—Å–∫–µ..." 
                oninput="filterPairListTextarea('${slot.id}', this.value)"
                onmousedown="event.stopPropagation()">
            <textarea class="slot-input" id="plist-textarea-${slot.id}"
                style="flex:1; min-height:60px;"
                placeholder="–∏–º—è:–∫–æ–¥" 
                onmousedown="event.stopPropagation()" 
                oninput="updatePairListOptions('${slot.id}', this.value)"
                onblur="saveState()">${currentText}</textarea>
        </div>`;
                    }
                    else if (slot.type !== 'table' && slot.type !== 'item_array' && slot.type !== 'aspect_list') {
                        htmlContent += `<div style="font-size:10px; color:#aaa; pointer-events:none;">${slot.type.toUpperCase()}</div>`;
                    }
                } else {

                    if (slot.type === 'list') {
                        let optionsHtml = (slot.options || []).map(o =>
                            `<option value="${o}" ${slot.val === o ? 'selected' : ''}>${o}</option>`
                        ).join('');
                        htmlContent += `
                            <select class="slot-select-craft" 
                                onmousedown="event.stopPropagation()" 
                                onchange="updateSlotVal('${slot.id}', this.value)">
                                <option value="">- –í—ã–±–æ—Ä -</option>${optionsHtml}
                            </select>`;
                    }
                    if (slot.type === 'pair_list') {
                        let optionsHtml = (slot.options || []).map(o =>
                            `<option value="${o.value}" ${slot.val === o.value ? 'selected' : ''}>${o.label}</option>`
                        ).join('');
                        htmlContent += `
        <select class="slot-select-craft" 
            onmousedown="event.stopPropagation()" 
            onchange="updateSlotVal('${slot.id}', this.value)">
            <option value="">- –í—ã–±–æ—Ä -</option>${optionsHtml}
        </select>`;
                    } else if (slot.type === 'counter' || slot.type === 'text' || slot.type === 'array') {

                        const isArray = slot.type === 'array';
                        const inputType = isArray ? 'textarea' : 'input';

                        htmlContent += `
                            <${inputType} class="slot-input" 
                                ${!isArray ? `value="${slot.val || ''}"` : ''} 
                                onmousedown="event.stopPropagation()" 
                                oninput="updateSlotValFast('${slot.id}', this.value)"
                                onblur="updateSlotVal('${slot.id}', this.value); saveState()"
                                placeholder="...">${isArray ? (slot.val || '') : ''}</${inputType}>`;

                        if (!isArray) {
                            htmlContent = htmlContent.replace('placeholder="..."', `placeholder="..." value="${slot.val || ''}"`);
                        }
                    } else if (slot.type === 'note') {
                        htmlContent += `
                            <textarea class="slot-input" 
                                onmousedown="event.stopPropagation()" 
                                oninput="updateSlotValFast('${slot.id}', this.value)"
                                onblur="saveState()"
                                placeholder="–ó–∞–º–µ—Ç–∫–∞...">${slot.val || ''}</textarea>`;
                    } else if (slot.type === 'research' && slot.content) {
                        htmlContent += `<div class="slot-content-text">üìñ<br>${slot.content.name}</div>`;
                    } else if (slot.content && slot.type !== 'aspect_list' && slot.type !== 'item_array' && slot.type !== 'table') {
                        const typeClass = `type-${slot.content.type || 'item'}`;
                        const count = slot.content.count > 1 ? `<div class="slot-count">${slot.content.count}</div>` : '';

                        let imgPath = slot.content.type === 'aspect'
                            ? `https://ru.minecraft.wiki/images/Grid_${slot.content.name.charAt(0).toUpperCase() + slot.content.name.slice(1)}_(Thaumcraft_4).png`
                            : `itempanel_icons/${slot.content.name}.png`;

                        htmlContent += `
                            <div style="position:relative; width:32px; height:32px;">
                                <div class="fallback-box" id="fallback-${slot.id}">
                                    <div class="fallback-name ${typeClass}">${slot.content.name || slot.content.code}</div>
                                </div>
                                <img src="${imgPath}" 
                                    style="position:absolute; top:0; left:0; width:32px; height:32px; z-index:2;" 
                                    onload="document.getElementById('fallback-${slot.id}').style.display='none'"
                                    onerror="this.classList.add('img-error'); document.getElementById('fallback-${slot.id}').style.display='flex'">
                            </div>
                            ${count}`;
                    }
                }
                htmlContent += `<div class="slot-id">${slot.id}</div>`;
                el.innerHTML = htmlContent;

                if (slot.type === 'table') {
                    if (!slot.content) slot.content = { cols: ['Column 1'], rows: [['']], sep: ',' };
                    const tbl = slot.content;
                    if (!tbl.cols) tbl.cols = ['Column 1'];
                    if (!tbl.rows) tbl.rows = [['']];

                    const tableEl = document.createElement('table');
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    tbl.cols.forEach(col => {
                        const th = document.createElement('th');
                        th.innerText = col;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    tableEl.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    tbl.rows.forEach((row, ri) => {
                        const tr = document.createElement('tr');
                        // Ensure row has same number of cells as columns
                        while (row.length < tbl.cols.length) row.push("");

                        row.slice(0, tbl.cols.length).forEach((cell, ci) => {
                            const td = document.createElement('td');
                            const input = document.createElement('input');
                            input.value = cell || "";
                            input.oninput = (e) => {
                                slot.content.rows[ri][ci] = e.target.value; // silent update
                            };
                            input.onblur = (e) => updateTableCell(slot.id, ri, ci, e.target.value);
                            input.onpaste = (e) => handleTablePaste(e, slot.id, ri, ci);
                            input.oncontextmenu = (e) => {
                                e.preventDefault();
                                deleteTableRow(slot.id, ri);
                            };
                            td.appendChild(input);
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    tableEl.appendChild(tbody);
                    el.appendChild(tableEl);

                    const actions = document.createElement('div');
                    actions.className = 'table-row-actions';
                    const addRow = document.createElement('div');
                    addRow.className = 'table-add-row-btn';
                    addRow.innerText = '+ –°—Ç—Ä–æ–∫–∞';
                    addRow.onclick = (e) => { e.stopPropagation(); addTableRow(slot.id); };
                    actions.appendChild(addRow);
                    el.appendChild(actions);
                }

                // Add this to prevent table disappearance in some browsers/cases
                if (slot.type === 'table') {
                    el.style.height = 'auto';
                    el.style.minHeight = '60px';
                }

                if (slot.type === 'item_array') {
                    if (!slot.content) slot.content = [];

                    slot.content.forEach((item, i) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'item-array-slot';
                        itemDiv.setAttribute('data-index', i + 1);

                        if (item) {
                            itemDiv.innerHTML = `<img src="itempanel_icons/${item.name}.png" onerror="this.style.opacity='0.3'">`;
                            itemDiv.onmouseenter = (e) => showTooltip(e, item.name, item.code);
                            itemDiv.onmousemove = (e) => updateTooltipPos(e);
                            itemDiv.onmouseleave = hideTooltip;
                            itemDiv.onclick = (e) => {
                                e.stopPropagation();
                                saveState();
                                slot.content.splice(i, 1);
                                renderCanvas();
                                generateCode();
                                updateListBuilderUI(slot);
                            };
                        }

                        itemDiv.ondragover = (e) => e.preventDefault();
                        itemDiv.ondrop = (e) => {
                            e.preventDefault(); e.stopPropagation();
                            const data = JSON.parse(e.dataTransfer.getData('json'));
                            if (data.type === 'item' || data.type === 'fluid') {
                                saveState();
                                slot.content[i] = data;
                                renderCanvas();
                                generateCode();
                                updateListBuilderUI(slot);
                            }
                        };
                        el.appendChild(itemDiv);
                    });

                    const addBtn = document.createElement('div');
                    addBtn.className = 'item-array-add-slot';
                    addBtn.innerHTML = '+';
                    addBtn.title = "–î–æ–±–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π —Å–ª–æ—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –±—Ä–æ—Å—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç —Å—é–¥–∞";

                    addBtn.ondragover = (e) => e.preventDefault();
                    addBtn.ondrop = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        const data = JSON.parse(e.dataTransfer.getData('json'));
                        if (data.type === 'item' || data.type === 'fluid') {
                            saveState();
                            slot.content.push(data);
                            renderCanvas();
                            generateCode();
                            updateListBuilderUI(slot);
                        }
                    };
                    addBtn.onclick = (e) => {
                        e.stopPropagation();
                        addItemArraySlot(slot.id);
                    };
                    el.appendChild(addBtn);
                } else if (slot.type === 'aspect_list') {
                    (slot.content || []).forEach((asp, idx) => {
                        const aspDiv = document.createElement('div');
                        aspDiv.className = 'mini-asp';

                        aspDiv.onmouseenter = (e) => showTooltip(e, asp.name, asp.code);
                        aspDiv.onmousemove = (e) => updateTooltipPos(e);
                        aspDiv.onmouseleave = hideTooltip;

                        aspDiv.onmousedown = (e) => {
                            e.stopPropagation();
                            if (e.button === 0) {
                                saveState();
                                slot.content.splice(idx, 1);
                                renderCanvas();
                                generateCode();
                            }
                        };

                        aspDiv.onwheel = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            saveState();
                            if (e.deltaY < 0) asp.val++;
                            else if (asp.val > 1) asp.val--;
                            renderCanvas();
                            generateCode();
                        };

                        let imgPath = asp.img || `https://ru.minecraft.wiki/images/Grid_${asp.name.charAt(0).toUpperCase() + asp.name.slice(1)}_(Thaumcraft_4).png`;
                        const shortName = (asp.name || "??").substring(0, 2).toUpperCase();

                        aspDiv.innerHTML = `
                                <div style="position:relative; width:16px; height:16px; flex-shrink:0; display:flex; align-items:center; justify-content:center;">
                                    <div class="mini-asp-fallback" id="mini-fallback-${slot.id}-${idx}">${shortName}</div>
                                    <img src="${imgPath}" 
                                        style="position:absolute; top:0; left:0; width:16px; height:16px; z-index:2;" 
                                        onload="document.getElementById('mini-fallback-${slot.id}-${idx}').style.display='none'"
                                        onerror="this.style.display='none'; document.getElementById('mini-fallback-${slot.id}-${idx}').style.display='flex'">
                                </div>
                                <span>${asp.val}</span>
                            `;
                        el.appendChild(aspDiv);
                    });
                }

                if (isEditMode) {
                    const handle = document.createElement('div');
                    handle.className = 'drag-handle-overlay';
                    handle.onmousedown = (e) => {
                        if (e.button === 1) { onCanvasMouseDown(e); return; }
                        e.stopPropagation();
                        if (e.button === 0) handleSlotMouseDown(e, slot.id);
                    };
                    el.appendChild(handle);
                }

                el.onwheel = (e) => {
                    if (!isEditMode && slot.content && typeof slot.content === 'object' && 'count' in slot.content) {
                        e.preventDefault();
                        e.stopPropagation();
                        saveState();
                        if (e.deltaY < 0) slot.content.count++;
                        else if (slot.content.count > 1) slot.content.count--;
                        renderCanvas();
                        generateCode();
                    }
                };

                el.ondragover = (e) => e.preventDefault();
                el.ondrop = (e) => dropContentInSlot(e, slot);

                el.addEventListener('mousedown', (e) => {
                    if (e.button === 1) {
                        if (isEditMode) {
                            onCanvasMouseDown(e);
                        } else {
                            if (slot.content && typeof slot.content === 'object' && 'count' in slot.content) {
                                const newCount = prompt(`–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è ${slot.id}:`, slot.content.count || 1);
                                if (newCount !== null) {
                                    const parsed = parseInt(newCount);
                                    if (!isNaN(parsed) && parsed >= 0) {
                                        saveState();
                                        slot.content.count = parsed;
                                        renderCanvas();
                                        generateCode();
                                    }
                                }
                            }
                        }
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }

                    if (!isEditMode) {
                        if (['INPUT', 'TEXTAREA', 'SELECT', 'TD', 'TH'].includes(e.target.tagName)) return;
                        if (e.target.closest('.table-add-row-btn')) return;

                        e.stopPropagation();
                        const textTypes = ['counter', 'text', 'array', 'list', 'table', 'note'];

                        if (e.button === 0 && !textTypes.includes(slot.type) && slot.type !== 'aspect_list' && slot.type !== 'item_array') {
                            saveState();
                            slot.content = null;
                            generateCode();
                            renderCanvas();
                        }

                        if (e.button === 0 && slot.type === 'aspect_list' && e.shiftKey) {
                            saveState();
                            slot.content = [];
                            renderCanvas();
                            generateCode();
                        }
                    }
                });

                container.appendChild(el);
            });

            renderPageElements();
            updateStatsDisplay();
        }

        // --- LINK RENDERING ---
        function renderConnections(page) {
            const svg = document.getElementById('connections-layer');
            svg.innerHTML = '';
            if (!page) return;

            page.slots.forEach(slot => {
                if (slot.next) {
                    const target = page.slots.find(s => s.id === slot.next);
                    if (target) {
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");

                        const x1 = slot.x + 25;
                        const y1 = slot.y + 25;
                        const x2 = target.x + 25;
                        const y2 = target.y + 25;

                        const dx = Math.abs(x2 - x1) * 0.5;
                        const cp1x = x1 + dx;
                        const cp2x = x2 - dx;

                        const d = `M ${x1} ${y1} C ${cp1x} ${y1}, ${cp2x} ${y2}, ${x2} ${y2}`;

                        path.setAttribute("d", d);
                        path.setAttribute("class", "conn-line");

                        if (selectedSlotIds.has(slot.id) || selectedSlotIds.has(target.id)) {
                            path.classList.add('highlight');
                        }

                        svg.appendChild(path);
                    }
                }
            });
        }

        // --- BUILDER UI LOGIC ---
        function updateListBuilderUI(slot) {
            const listUI = document.getElementById('list-builder-ui');
            const aspectUI = document.getElementById('aspect-list-ui');
            const itemArrUI = document.getElementById('item-array-ui');
            const tableUI = document.getElementById('table-ui');
            listUI.classList.remove('active');
            aspectUI.classList.remove('active');
            itemArrUI.classList.remove('active');
            tableUI.classList.remove('active');
            if (!slot) return;

            if (slot.type === 'list') {
                listUI.classList.add('active');
                const container = document.getElementById('list-options-container');
                container.innerHTML = '';
                if (!slot.options) slot.options = [];
                slot.options.forEach((opt, idx) => {
                    const tag = document.createElement('div');
                    tag.className = 'option-tag';
                    tag.innerHTML = `<span>${opt}</span><span class="option-del" onclick="removeListOption('${slot.id}', ${idx})">√ó</span>`;
                    container.appendChild(tag);
                });
            } else if (slot.type === 'aspect_list') {
                aspectUI.classList.add('active');
                const container = document.getElementById('aspect-list-container');
                container.innerHTML = '';
                if (!slot.content) slot.content = [];
                slot.content.forEach((asp, idx) => {
                    let aspNameCap = asp.name.charAt(0).toUpperCase() + asp.name.slice(1);
                    let imgPath = asp.img || `https://ru.minecraft.wiki/images/Grid_${aspNameCap}_(Thaumcraft_4).png`;
                    const tag = document.createElement('div');

                    tag.className = 'asp-tag';
                    tag.innerHTML = `
                        <img src="${imgPath}" style="width:16px;height:16px;">
                        <b style="color:#a29bfe; font-size:11px;">${asp.name}</b>
                        <span class="asp-count-badge">${asp.val}</span>
                        <span class="option-del" onclick="removeAspectFromList('${slot.id}', ${idx}); event.stopPropagation();">√ó</span>
                    `;

                    tag.onwheel = (e) => {
                        e.preventDefault();
                        saveState();
                        if (e.deltaY < 0) {
                            asp.val++;
                        } else if (asp.val > 1) {
                            asp.val--;
                        }
                        updateListBuilderUI(slot);
                        renderCanvas();
                        generateCode();
                    };

                    container.appendChild(tag);
                });
            } else if (slot.type === 'item_array') {
                itemArrUI.classList.add('active');
                document.getElementById('item-array-count').innerText = (slot.content || []).filter(x => x).length;
            } else if (slot.type === 'table') {
                const tableUI = document.getElementById('table-ui');
                tableUI.classList.add('active');
                const sepInput = document.getElementById('table-sep-input');
                sepInput.value = slot.content.sep || ',';

                const container = document.getElementById('table-cols-container');
                container.innerHTML = '';
                slot.content.cols.forEach((col, idx) => {
                    const tag = document.createElement('div');
                    tag.className = 'option-tag';
                    tag.innerHTML = `<span>${col}</span><span class="option-del" onclick="deleteColumnFromTable(${idx})">√ó</span>`;
                    container.appendChild(tag);
                });
            }
        }

        window.updateTableSep = function (val) {
            const sid = Array.from(selectedSlotIds)[0];
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === sid);
            if (slot && slot.type === 'table') {
                slot.content.sep = val;
                generateCode();
            }
        };

        window.addColumnToTable = function () {
            const sid = Array.from(selectedSlotIds)[0];
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === sid);
            if (slot && slot.type === 'table') {
                saveState();
                const colName = prompt("–ò–º—è —Å—Ç–æ–ª–±—Ü–∞:", "Column " + (slot.content.cols.length + 1));
                if (colName) {
                    slot.content.cols.push(colName);
                    slot.content.rows.forEach(row => row.push(""));
                    updateListBuilderUI(slot);
                    renderCanvas();
                    generateCode();
                }
            }
        };

        window.deleteColumnFromTable = function (colIdx) {
            const sid = Array.from(selectedSlotIds)[0];
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === sid);
            if (slot && slot.type === 'table') {
                if (slot.content.cols.length <= 1) return;
                saveState();
                slot.content.cols.splice(colIdx, 1);
                slot.content.rows.forEach(row => row.splice(colIdx, 1));
                updateListBuilderUI(slot);
                renderCanvas();
                generateCode();
            }
        };

        window.addTableRowFromUI = function () {
            const sid = Array.from(selectedSlotIds)[0];
            if (sid) addTableRow(sid);
        };

        window.addTableRow = function (slotId) {
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === slotId);
            if (slot && slot.type === 'table') {
                saveState();
                slot.content.rows.push(new Array(slot.content.cols.length).fill(""));
                renderCanvas();
                generateCode();
            }
        };

        window.updateTableCell = function (slotId, rowIdx, colIdx, val) {
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === slotId);
            if (slot && slot.type === 'table') {
                slot.content.rows[rowIdx][colIdx] = val;

                // Auto-add row logic
                if (val.trim() !== "" && rowIdx === slot.content.rows.length - 1) {
                    slot.content.rows.push(new Array(slot.content.cols.length).fill(""));
                    renderCanvas();
                }

                generateCode();
            }
        };

        window.handleTablePaste = function (e, slotId, rowIdx, colIdx) {
            const text = e.clipboardData.getData('text');
            if (!text) return;

            if (text.includes('\n') || text.includes('\t')) {
                e.preventDefault();
                saveState();
                const page = findPage(activePageId);
                const slot = page.slots.find(s => s.id === slotId);
                if (slot && slot.type === 'table') {
                    const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
                    rows.forEach((rowStr, rOffset) => {
                        const cells = rowStr.split('\t');
                        const targetRowIdx = rowIdx + rOffset;

                        while (slot.content.rows.length <= targetRowIdx) {
                            slot.content.rows.push(new Array(slot.content.cols.length).fill(""));
                        }

                        cells.forEach((cellVal, cOffset) => {
                            const targetColIdx = colIdx + cOffset;
                            if (targetColIdx < slot.content.cols.length) {
                                slot.content.rows[targetRowIdx][targetColIdx] = cellVal.trim();
                            }
                        });
                    });
                    renderCanvas();
                    generateCode();
                }
            }
        };

        window.deleteTableRow = function (slotId, rowIdx) {
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === slotId);
            if (slot && slot.type === 'table') {
                saveState();
                if (slot.content.rows.length <= 1) {
                    slot.content.rows[0] = new Array(slot.content.cols.length).fill("");
                } else {
                    slot.content.rows.splice(rowIdx, 1);
                }
                renderCanvas();
                generateCode();
            }
        };

        // --- ASPECT FUNCTIONS ---
        window.addAspectManual = function () {
            if (selectedSlotIds.size !== 1) return;
            const sid = selectedSlotIds.values().next().value;
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === sid);

            const nameInput = document.getElementById('asp-manual-name');
            const countInput = document.getElementById('asp-manual-count');
            const nameVal = nameInput.value.toLowerCase().trim();
            const countVal = parseInt(countInput.value) || 1;

            if (slot && slot.type === 'aspect_list' && nameVal) {
                saveState();
                if (!slot.content) slot.content = [];

                let cap = nameVal.charAt(0).toUpperCase() + nameVal.slice(1);
                let imgUrl = `https://ru.minecraft.wiki/images/Grid_${cap}_(Thaumcraft_4).png`;

                slot.content.push({
                    name: nameVal,
                    code: nameVal,
                    val: countVal,
                    img: imgUrl
                });

                nameInput.value = '';
                updateListBuilderUI(slot);
                renderCanvas();
                generateCode();
                saveState();
            }
        };

        window.updateAspectVal = function (sid, idx, val) {
            saveState();
            const p = findPage(activePageId);
            const s = p.slots.find(x => x.id === sid);
            if (s && s.content[idx]) {
                s.content[idx].val = parseInt(val) || 1;
                generateCode();
            }
            saveState();
        };

        window.removeAspectFromList = function (sid, idx) {
            saveState();
            const p = findPage(activePageId);
            const s = p.slots.find(x => x.id === sid);
            if (s && s.content) {
                s.content.splice(idx, 1);
                updateListBuilderUI(s);
                renderCanvas();
                generateCode();
            }
            saveState();
        };

        window.removeListOption = function (sid, idx) {
            saveState();
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === sid);
            if (slot && slot.options) {
                slot.options.splice(idx, 1);
                updateListBuilderUI(slot);
                renderCanvas();
                generateCode();
            }
            saveState();
        };

        // --- SLOT FUNCTIONS ---
        window.addOptionToSelected = function () {
            if (selectedSlotIds.size !== 1) return;

            const sid = selectedSlotIds.values().next().value;
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === sid);

            if (slot && slot.type === 'list') {
                const input = document.getElementById('list-option-add');
                const val = input.value.trim();

                if (val !== "") {
                    saveState();

                    if (!slot.options) slot.options = [];
                    slot.options.push(val);

                    input.value = "";

                    updateListBuilderUI(slot);
                    renderCanvas();
                    generateCode();
                    saveState();
                }
            }
        };

        window.updateListOptions = function (id, text) {
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === id);
            if (slot) {
                slot.options = text.split('\n').map(line => line.trim()).filter(line => line !== "");
                generateCode();
            }
        };

        window.filterPairListTextarea = function (slotId, query) {
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === slotId);
            if (!slot || !slot.options) return;

            const ta = document.getElementById('plist-textarea-' + slotId);
            if (!ta) return;

            const searchTerm = query.toLowerCase().trim();

            if (!searchTerm) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏
                ta.value = (slot.options || []).map(o => `${o.label}:${o.value}`).join('\n');
                return;
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º –æ–ø—Ü–∏–∏ –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
            const filtered = slot.options.filter(o =>
                (o.label || "").toLowerCase().includes(searchTerm) ||
                (o.value || "").toLowerCase().includes(searchTerm)
            );

            ta.value = filtered.map(o => `${o.label}:${o.value}`).join('\n');
        };

        function addSlot(type) {
            const page = findPage(activePageId);
            if (!page) return;
            saveState();

            const typeMap = {
                pair_list: 'plst',
                fluid: 'liq', aspect: 'asp', research: 'res', counter: 'cnt',
                text: 'txt', list: 'lst', any: 'any', aspect_list: 'asl',
                array: 'mass', item_array: 'itm_arr', item: 'in', table: 'tbl'
            };

            let prefix = typeMap[type] || 'in';
            let count = 1;
            while (page.slots.find(s => s.id === prefix + count)) { count++; }
            const id = prefix + count;

            page.slots.push({
                id,
                type,
                x: 150,
                y: 150,
                content: (type === 'item_array' || type === 'aspect_list') ? [] : (type === 'table' ? { cols: ['Column 1'], rows: [['']], sep: ',' } : null),
                val: "",
                label: "",
                next: null,
                options: (type === 'list' ? [] : undefined)
            });

            if (type === 'note') {
                const slot = page.slots[page.slots.length - 1];
                slot.x = 200;
                slot.y = 200;
            }

            renderCanvas();
            generateCode();
            renderPageElements();
            saveState();
        }

        function renderPageElements() {
            const page = findPage(activePageId);
            const cont = document.getElementById('page-elements-list');
            if (!page || !cont) {
                if (cont) cont.innerHTML = '';
                return;
            }

            const sortedSlots = [...page.slots].sort((a, b) =>
                a.id.localeCompare(b.id, undefined, { numeric: true, sensitivity: 'base' })
            );

            cont.innerHTML = sortedSlots.map(s => {
                const labelText = s.label ? `(${s.label})` : '';
                const displayId = `{${s.id}}`;

                let typeColor = '#74b9ff';
                if (s.type === 'any') typeColor = '#95a5a6';
                if (s.type === 'fluid') typeColor = '#0984e3';
                if (s.type === 'aspect' || s.type === 'aspect_list') typeColor = '#a29bfe';
                if (s.type === 'counter') typeColor = '#2ecc71';
                if (s.type === 'research') typeColor = '#fdcb6e';

                return `
                    <div class="el-item" draggable="true" 
                        onmouseover="highlightSlotOnCanvas('${s.id}', true)"
                        onmouseout="highlightSlotOnCanvas('${s.id}', false)"
                        ondragstart="event.dataTransfer.setData('text/plain', '${displayId}')"
                        style="border-left: 3px solid ${typeColor}">
                        <b style="color: ${typeColor}">${s.id}</b> 
                        <span style="opacity:0.6; font-size: 10px;">${labelText}</span>
                    </div>
                `;
            }).join('');
        }

        function highlightSlotOnCanvas(slotId, active) {
            const el = document.getElementById('slot-div-' + slotId);
            if (el) {
                if (active) {
                    el.classList.add('highlight-hover');
                } else {
                    el.classList.remove('highlight-hover');
                }
            }
        }

        window.updateSlotValFast = function (id, val) {
            const p = findPage(activePageId);
            const s = p.slots.find(x => x.id === id);
            if (s) {
                s.val = val;
                generateCode();
            }
        };

        window.updateSlotVal = function (id, val) {
            saveState();
            const p = findPage(activePageId);
            const s = p.slots.find(x => x.id === id);
            if (s) {
                s.val = val;
                generateCode();
            }
        };

        window.calculateExpression = function (val) {
            if (typeof val === 'string' && val.startsWith('=') && val.length > 1) {
                try {
                    // Only allow numbers, math operators, dots, and parentheses
                    const mathOnly = val.substring(1).replace(/[^-+*/().0-9]/g, '');
                    if (mathOnly === "") return val;
                    // Safe evaluation using Function
                    const result = new Function(`return (${mathOnly})`)();
                    return String(result);
                } catch (e) {
                    console.warn("Calc error:", e);
                    return val;
                }
            }
            return val;
        };

        window.updateSlotLabel = function (val) {
            if (selectedSlotIds.size !== 1) return;
            const sid = selectedSlotIds.values().next().value;
            const s = findPage(activePageId).slots.find(x => x.id === sid);
            if (s) {
                saveState();
                s.label = val;
                renderCanvas();
                saveState();
            }
        };

        function updateBuilderInputs() {
            if (selectedSlotIds.size === 1) {
                const sid = selectedSlotIds.values().next().value;
                const s = findPage(activePageId).slots.find(x => x.id === sid);
                document.getElementById('slot-id-input').value = sid;
                document.getElementById('slot-id-input').disabled = false;
                document.getElementById('slot-label-input').value = s.label || "";
                document.getElementById('slot-label-input').disabled = false;
                updateListBuilderUI(s);
            } else {
                document.getElementById('slot-id-input').value = "";
                document.getElementById('slot-id-input').disabled = true;
                document.getElementById('slot-label-input').value = "";
                document.getElementById('slot-label-input').disabled = true;
                updateListBuilderUI(null);
            }
        }

        function updateSlotID(val) {
            if (selectedSlotIds.size !== 1) return;
            const sid = selectedSlotIds.values().next().value;
            const page = findPage(activePageId);
            const s = page.slots.find(x => x.id === sid);

            if (s) {
                if (page.slots.find(other => other.id === val && other !== s)) {
                    console.warn("ID " + val + " —É–∂–µ –∑–∞–Ω—è—Ç!");
                    return;
                }

                saveState();
                selectedSlotIds.delete(sid);
                s.id = val;
                selectedSlotIds.add(val);
                renderCanvas();
                generateCode();
                renderPageElements();
                saveState();
            }
        }

        function deleteSelectedSlots() {
            if (selectedSlotIds.size === 0) return;
            saveState();
            findPage(activePageId).slots = findPage(activePageId).slots.filter(s => !selectedSlotIds.has(s.id));
            selectedSlotIds.clear();
            updateBuilderInputs();
            renderCanvas();
            saveState();
        }

        // --- ALIGN TOOLS ---
        function alignSelected(mode) {
            if (selectedSlotIds.size < 1) return;
            saveState();
            const page = findPage(activePageId);
            const slots = page.slots.filter(s => selectedSlotIds.has(s.id));

            if (mode === 'left') {
                const minX = Math.min(...slots.map(s => s.x));
                slots.forEach(s => s.x = minX);
            } else if (mode === 'top') {
                const minY = Math.min(...slots.map(s => s.y));
                slots.forEach(s => s.y = minY);
            } else if (mode === 'grid') {
                slots.forEach(s => {
                    s.x = Math.round(s.x / 20) * 20;
                    s.y = Math.round(s.y / 20) * 20;
                });
            }
            renderCanvas();
            saveState();
        }

        // --- CANVAS INTERACTION ---
        function onCanvasMouseDown(e) {
            if (e.button === 1) {
                e.preventDefault();
                isPanning = true;
                panStart = { x: e.clientX, y: e.clientY };
                const vp = document.getElementById('canvas-viewport');
                panScrollStart = { x: vp.scrollLeft, y: vp.scrollTop };
                vp.classList.add('panning');
                document.addEventListener('mousemove', onCanvasPan);
                document.addEventListener('mouseup', onCanvasPanEnd);
                return;
            }

            if (e.button === 0) {
                if (!e.ctrlKey && !e.target.closest('.slot')) {
                    selectedSlotIds.clear();
                    renderCanvas();
                    updateBuilderInputs();
                }
                startMarquee(e);
            }
        }

        function onCanvasPan(e) {
            if (!isPanning) return;
            const dx = (e.clientX - panStart.x);
            const dy = (e.clientY - panStart.y);
            const vp = document.getElementById('canvas-viewport');
            vp.scrollLeft = panScrollStart.x - dx;
            vp.scrollTop = panScrollStart.y - dy;
        }

        function onCanvasPanEnd() {
            isPanning = false;
            document.getElementById('canvas-viewport').classList.remove('panning');
            document.removeEventListener('mousemove', onCanvasPan);
            document.removeEventListener('mouseup', onCanvasPanEnd);
        }

        function handleSlotMouseDown(e, id) {
            if (isLinkMode) {
                saveState();
                const page = findPage(activePageId);
                if (linkStartId === null) {
                    linkStartId = id;
                } else {
                    if (linkStartId === id) {
                        const slot = page.slots.find(s => s.id === id);
                        if (slot) slot.next = null;
                        linkStartId = null;
                    } else {
                        const slot = page.slots.find(s => s.id === linkStartId);
                        if (slot) slot.next = id;
                        linkStartId = null;
                    }
                }
                renderCanvas();
                generateCode();
                saveState();
                return;
            }

            if (e.ctrlKey) {
                if (selectedSlotIds.has(id)) selectedSlotIds.delete(id);
                else selectedSlotIds.add(id);
            } else {
                if (!selectedSlotIds.has(id)) {
                    selectedSlotIds.clear();
                    selectedSlotIds.add(id);
                }
            }

            renderCanvas();
            updateBuilderInputs();

            if (!isEditMode) return;

            isDraggingSelection = true;
            dragStartMousePos = { x: e.clientX, y: e.clientY };
            initialSlotPositions = {};
            const page = findPage(activePageId);

            selectedSlotIds.forEach(sid => {
                const s = page.slots.find(x => x.id === sid);
                if (s) initialSlotPositions[sid] = { x: s.x, y: s.y };
            });

            document.addEventListener('mousemove', onSlotDrag);
            document.addEventListener('mouseup', onSlotDragEnd);
        }

        function onSlotDrag(e) {
            if (!isDraggingSelection) return;

            const dx = (e.clientX - dragStartMousePos.x) / canvasScale;
            const dy = (e.clientY - dragStartMousePos.y) / canvasScale;

            const page = findPage(activePageId);

            selectedSlotIds.forEach(sid => {
                const el = document.getElementById('slot-div-' + sid);
                const slot = page.slots.find(s => s.id === sid);
                const initPos = initialSlotPositions[sid];

                if (slot && initPos) {
                    const nx = Math.round((initPos.x + dx) / 10) * 10;
                    const ny = Math.round((initPos.y + dy) / 10) * 10;

                    slot.x = nx;
                    slot.y = ny;

                    if (el) {
                        el.style.left = nx + 'px';
                        el.style.top = ny + 'px';
                    }
                }
            });

            renderConnections(page);
        }

        function onSlotDragEnd() {
            isDraggingSelection = false;
            document.removeEventListener('mousemove', onSlotDrag);
            document.removeEventListener('mouseup', onSlotDragEnd);

            let changed = false;
            const page = findPage(activePageId);
            selectedSlotIds.forEach(sid => {
                const el = document.getElementById('slot-div-' + sid);
                const slot = page.slots.find(s => s.id === sid);
                if (el && slot) {
                    const nx = parseInt(el.style.left);
                    const ny = parseInt(el.style.top);
                    if (slot.x !== nx || slot.y !== ny) changed = true;
                }
            });

            if (changed) {
                saveState();
                selectedSlotIds.forEach(sid => {
                    const el = document.getElementById('slot-div-' + sid);
                    const slot = page.slots.find(s => s.id === sid);
                    if (el && slot) {
                        slot.x = parseInt(el.style.left);
                        slot.y = parseInt(el.style.top);
                    }
                });
                renderCanvas();
                saveState();
            }
        }

        function startMarquee(e) {
            if (!isEditMode) return;
            if (e.target.closest('.slot')) return;
            isMarqueeActive = true;
            const rect = document.getElementById('canvas-content').getBoundingClientRect();
            marqueeStart = {
                x: (e.clientX - rect.left) / canvasScale,
                y: (e.clientY - rect.top) / canvasScale
            };

            const marq = document.getElementById('selection-marquee');
            marq.style.display = 'block';
            marq.style.left = marqueeStart.x + 'px';
            marq.style.top = marqueeStart.y + 'px';
            marq.style.width = '0px';
            marq.style.height = '0px';

            if (!e.ctrlKey) selectedSlotIds.clear();
            renderCanvas();
            updateBuilderInputs();
            document.addEventListener('mousemove', updateMarquee);
            document.addEventListener('mouseup', endMarquee);
        }

        function updateMarquee(e) {
            if (!isMarqueeActive) return;
            const rect = document.getElementById('canvas-content').getBoundingClientRect();
            const curX = (e.clientX - rect.left) / canvasScale;
            const curY = (e.clientY - rect.top) / canvasScale;
            const marq = document.getElementById('selection-marquee');
            marq.style.left = Math.min(marqueeStart.x, curX) + 'px';
            marq.style.top = Math.min(marqueeStart.y, curY) + 'px';
            marq.style.width = Math.abs(curX - marqueeStart.x) + 'px';
            marq.style.height = Math.abs(curY - marqueeStart.y) + 'px';
        }

        function endMarquee() {
            if (!isMarqueeActive) return;
            isMarqueeActive = false;
            document.getElementById('selection-marquee').style.display = 'none';
            document.removeEventListener('mousemove', updateMarquee);
            document.removeEventListener('mouseup', endMarquee);

            const marq = document.getElementById('selection-marquee');
            const mx = parseFloat(marq.style.left);
            const my = parseFloat(marq.style.top);
            const mw = parseFloat(marq.style.width);
            const mh = parseFloat(marq.style.height);

            findPage(activePageId).slots.forEach(s => {
                if (s.x + 25 >= mx && s.x + 25 <= mx + mw && s.y + 25 >= my && s.y + 25 <= my + mh) {
                    selectedSlotIds.add(s.id);
                }
            });

            renderCanvas();
            updateBuilderInputs();
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function dropContentInSlot(e, slot) {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData('json'));
            saveState();

            if (slot.type === 'aspect_list') {
                if (data.type !== 'aspect') {
                    alert("–°—é–¥–∞ –º–æ–∂–Ω–æ –∫–ª–∞—Å—Ç—å —Ç–æ–ª—å–∫–æ –∞—Å–ø–µ–∫—Ç—ã!");
                    return;
                }
                if (!Array.isArray(slot.content)) slot.content = [];

                const existing = slot.content.find(a => a.code === data.code);
                if (existing) {
                    existing.val++;
                } else {
                    slot.content.push({
                        name: data.name,
                        code: data.code,
                        val: 1,
                        img: data.img
                    });
                }
            } else if (slot.type === 'table') {
                return;
            } else if (slot.type === 'item_array') {
                return;
            } else if (slot.type === 'any' || slot.type === data.type) {
                slot.content = data;
            } else {
                alert('–ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞!');
                return;
            }

            renderCanvas();
            generateCode();
            saveState();
        }

        function updateTemplate(val) {
            const p = findPage(activePageId);
            if (p) {
                p.template = val;
                generateCode();
            }
        }

        document.getElementById('code-template').addEventListener('change', () => saveState());

        // --- GENERATE CODE (WITH CHAINING) ---
        function formatData(data) {
            if (!data || data === "null") return "";
            let str = "";
            let suffix = (data.count > 1) ? ` * ${data.count}` : '';
            if (data.type === 'item') str = `<${data.code}>` + suffix;
            else if (data.type === 'fluid') str = `<liquid:${data.code}>` + suffix;
            else if (data.type === 'aspect') str = `${data.code}` + suffix;
            else if (data.type === 'research') str = `"${data.code}"` + suffix;
            else str = (data.code || data) + suffix;
            return str;
        }

        function getChain(page, slot, visited = new Set()) {
            if (!slot || visited.has(slot.id)) return [];
            visited.add(slot.id);

            let chainSlots = [slot];
            let current = slot;
            while (current.next) {
                let nextSlot = page.slots.find(s => s.id === current.next);
                if (nextSlot && !visited.has(nextSlot.id)) {
                    visited.add(nextSlot.id);
                    chainSlots.push(nextSlot);
                    current = nextSlot;
                } else break;
            }

            const hasArray = chainSlots.some(s => s.type === 'array' || s.type === 'item_array' || s.type === 'table');

            if (!hasArray) {
                return chainSlots.map(s => {

                    if (s.type === 'counter' || s.type === 'text') return calculateExpression(s.val || "");
                    if (s.type === 'list' || s.type === 'pair_list') return s.val || "";
                    if (s.type === 'aspect_list') return (s.content || []).map(a => `${a.name.toLowerCase()} ${a.val}`).join(", ");

                    if (!s.content || s.content === "null") {
                        return (s.type === 'item' || s.type === 'fluid') ? "null" : "";
                    }

                    return formatData(s.content);
                });

            } else {
                let splitData = chainSlots.map(s => {
                    if (s.type === 'array') return (s.val || "").split('\n');

                    if (s.type === 'item_array') {
                        return (s.content || []).map(item => {
                            if (!item) return "null";
                            return formatData(item);
                        });
                    }

                    if (s.type === 'table') {
                        const tbl = s.content;
                        const sep = tbl.sep || ",";
                        return tbl.rows.map(row => {
                            return row.map(cell => calculateExpression(cell)).filter(cell => cell.trim() !== "").join(sep);
                        });
                    }

                    let singleVal = "";
                    if (s.type === 'counter' || s.type === 'text') {
                        singleVal = calculateExpression(s.val || "");
                    } else if (s.type === 'list' || s.type === 'pair_list') {
                        singleVal = s.val || "";
                    } else if (s.type === 'aspect_list') {
                        singleVal = (s.content || []).map(a => `${a.name.toLowerCase()} ${a.val}`).join(", ");
                    } else {
                        singleVal = s.content ? formatData(s.content) : (s.type === 'item' ? "null" : "");
                    }
                    return [singleVal];
                });

                let maxLines = Math.max(...splitData.map(d => d.length));
                let combinedLines = [];

                for (let i = 0; i < maxLines; i++) {
                    let combinedRowParts = chainSlots.map((s, slotIdx) => {
                        let dataArray = splitData[slotIdx];
                        let val = dataArray[i];

                        if (val === undefined) {
                            if (dataArray.length === 1) return dataArray[0];
                            return (s.type === 'item_array') ? "null" : "";
                        }
                        return val;
                    });

                    combinedLines.push(combinedRowParts.join(''));
                }

                return [combinedLines.join('\n')];
            }
        }

        function generateCode() {
            const page = findPage(activePageId);
            if (!page) return;
            let code = page.template || "";

            const sortedSlots = [...page.slots].sort((a, b) => b.id.length - a.id.length);

            sortedSlots.forEach(s => {
                const regex = new RegExp(`{${s.id}}`, 'g');
                const chain = getChain(page, s);

                let val = chain
                    .map(v => v.trim())
                    .filter(v => v !== "")
                    .join(", ");

                code = code.replace(regex, val);
            });

            document.getElementById('code-result').value = code;
        }

        function saveAndRender() {
            renderCanvas();
            generateCode();
        }

        function loadItemsCSV(input) {
            const fr = new FileReader();
            fr.onload = (e) => {
                processItemsCSV(e.target.result);
            };
            fr.readAsText(input.files[0], 'windows-1251');
        }

        function processItemsCSV(csvText) {
            const lines = csvText.split(/\r?\n/);
            DB_ITEMS = lines.map(l => {
                const p = l.split(l.includes(';') ? ';' : ',');
                if (p.length < 5) return null;
                return {
                    id: p[0],
                    meta: p[2],
                    loc: p[4],
                    fullId: `${p[0]}${p[2] !== '0' ? ':' + p[2] : ''}`
                };
            }).filter(Boolean);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±—É–¥—É—â–µ–º
            try {
                localStorage.setItem('ide_items_db', JSON.stringify(DB_ITEMS));
            } catch (e) {
                console.warn("–ë–∞–∑–∞ —Å–ª–∏—à–∫–æ–º –≤–µ–ª–∏–∫–∞ –¥–ª—è –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞, –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.");
            }
            renderLibrary();
        }

        function copyCode() {
            document.getElementById('code-result').select();
            document.execCommand('copy');
        }

        function saveProjectFile() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(projectStructure, null, 2)], { type: 'application/json' }));
            a.download = 'project.json';
            a.click();
        }

        function loadProjectFile(input) {
            const fr = new FileReader();
            fr.onload = e => {
                try {
                    projectStructure = JSON.parse(e.target.result);
                    renderTree();
                    if (projectStructure.length > 0 && projectStructure[0].children.length > 0) {
                        loadPage(projectStructure[0].children[0].id);
                    }
                } catch (err) {
                    alert("Error loading project file");
                }
            };
            fr.readAsText(input.files[0]);
        }

        window.exportItemsDB = function () {
            const data = {
                items: DB_ITEMS,
                liquids: DB_LIQUIDS,
                aspects: DB_ASPECTS,
                research: DB_RESEARCH,
                timestamp: new Date().toISOString()
            };

            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)],
                { type: 'application/json' }));
            a.download = 'ide_database_export.json';
            a.click();
        };

        window.importItemsDB = function (input) {
            const fr = new FileReader();
            fr.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    DB_ITEMS = data.items || DB_ITEMS;
                    DB_LIQUIDS = data.liquids || DB_LIQUIDS;
                    DB_ASPECTS = data.aspects || DB_ASPECTS;
                    DB_RESEARCH = data.research || DB_RESEARCH;
                    renderLibrary();
                    alert(`–ë–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${DB_ITEMS.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤, ${DB_LIQUIDS.length} –∂–∏–¥–∫–æ—Å—Ç–µ–π`);
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
                }
            };
            fr.readAsText(input.files[0]);
        };

        window.toggleGroupMode = function () {
            if (selectedSlotIds.size < 2) return;
            saveState();

            const page = findPage(activePageId);
            const selected = page.slots.filter(s => selectedSlotIds.has(s.id));

            const minX = Math.min(...selected.map(s => s.x));
            const minY = Math.min(...selected.map(s => s.y));
            const maxX = Math.max(...selected.map(s => s.x + 50));
            const maxY = Math.max(...selected.map(s => s.y + 50));

            const groupId = 'grp' + Date.now();
            page.slots.push({
                id: groupId,
                type: 'group',
                x: minX - 10,
                y: minY - 10,
                width: maxX - minX + 20,
                height: maxY - minY + 20,
                children: [...selectedSlotIds],
                label: '–ì—Ä—É–ø–ø–∞ ' + (document.querySelectorAll('.slot.group').length + 1)
            });

            renderCanvas();
            saveState();
        };

        function toggleQuickPanel() {
            const panel = document.getElementById('quick-actions-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        window.enableNamedAutosave = function (interval = 30000) {
            if (window.autosaveInterval) clearInterval(window.autosaveInterval);

            window.autosaveInterval = setInterval(() => {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const data = {
                    project: projectStructure,
                    activePage: activePageId,
                    timestamp: timestamp
                };

                localStorage.setItem(`ide_autosave_${timestamp}`, JSON.stringify(data));

                const keys = Object.keys(localStorage).filter(k => k.startsWith('ide_autosave_'));
                if (keys.length > 5) {
                    keys.sort().slice(0, -5).forEach(k => localStorage.removeItem(k));
                }
            }, interval);

            console.log('–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ –∫–∞–∂–¥—ã–µ', interval / 1000, '—Å–µ–∫');
        };

        function getCanvasStats() {
            const page = findPage(activePageId);
            if (!page) return { slots: 0, connections: 0 };

            const slots = page.slots.length;
            const connections = page.slots.filter(s => s.next).length;

            return { slots, connections };
        }



        function renderTree() {
            const container = document.getElementById('project-tree');
            if (!container) return;
            container.innerHTML = '';

            function createNodeHtml(node, parentElement) {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node-container';

                const header = document.createElement('div');
                const isSelected = selectedNodeId === node.id;
                const isActivePage = node.id === activePageId;

                header.className = `tree-header ${node.type === 'page' ? 'file-node' : ''} ${isSelected ? 'selected-node' : ''} ${isActivePage ? 'active-page' : ''}`;
                header.draggable = true;

                header.ondragstart = (e) => onTreeDragStart(e, node.id, node.type);
                header.ondragover = (e) => onTreeDragOver(e, header);
                header.ondragleave = (e) => onTreeDragLeave(e, header);
                header.ondrop = (e) => onTreeDrop(e, node.id, node.type);

                header.onclick = (e) => {
                    e.stopPropagation();
                    selectedNodeId = node.id;
                    if (node.type === 'page') loadPage(node.id);
                    renderTree();
                };

                let html = '';
                if (node.type === 'folder') {
                    const arrowClass = node.expanded ? '' : 'closed';
                    html += `<div class="tree-arrow ${arrowClass}" onclick="event.stopPropagation(); toggleFolder('${node.id}')">‚ñº</div>`;
                } else {
                    html += `<div style="width:14px"></div>`;
                }

                const iconSrc = node.iconData;
                const defaultIcon = node.type === 'folder' ? 'üìÅ' : 'üìÑ';
                const iconHtml = iconSrc
                    ? `<img src="${iconSrc}" style="width:18px; height:18px; margin-right:5px; image-rendering:pixelated;">`
                    : `<span style="margin-right:5px;">${defaultIcon}</span>`;

                header.innerHTML = `${html} <div class="tree-icon">${iconHtml}</div> <div class="tree-label">${node.name}</div>`;
                nodeDiv.appendChild(header);

                if (node.type === 'folder' && node.expanded && node.children) {
                    const childrenCont = document.createElement('div');
                    childrenCont.className = 'tree-children';
                    node.children.forEach(child => createNodeHtml(child, childrenCont));
                    nodeDiv.appendChild(childrenCont);
                }
                parentElement.appendChild(nodeDiv);
            }

            projectStructure.forEach(rootNode => createNodeHtml(rootNode, container));

            const rootDropZone = document.createElement('div');
            rootDropZone.className = 'tree-root-drop-zone';
            rootDropZone.innerText = '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞, —á—Ç–æ–±—ã –≤—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ—Ä–µ–Ω—å';

            rootDropZone.ondragover = (e) => {
                e.preventDefault();
                rootDropZone.classList.add('drag-over');
            };
            rootDropZone.ondragleave = () => rootDropZone.classList.remove('drag-over');
            rootDropZone.ondrop = (e) => {
                rootDropZone.classList.remove('drag-over');
                onTreeDrop(e, 'root', 'root');
            };
            container.appendChild(rootDropZone);
        }

        function toggleFolder(id) {
            const node = findNodeById(id);
            if (node) {
                node.expanded = !node.expanded;
                renderTree();
            }
        }

        function onTreeDragStart(e, id, type) {
            draggedTreeNodeId = id;
            draggedTreeNodeType = type;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('tree_drag', 'true');
        }

        function onTreeDragOver(e, el) {
            e.preventDefault();
            const isTreeDrag = e.dataTransfer.types.includes('tree_drag');
            const isJsonDrag = e.dataTransfer.types.includes('json');

            if (isTreeDrag) {
                e.dataTransfer.dropEffect = 'move';
                el.classList.add('drag-over');
            } else if (isJsonDrag) {
                e.dataTransfer.dropEffect = 'copy';
                el.classList.add('drag-over-item');
            }
        }

        function onTreeDragLeave(e, el) {
            el.classList.remove('drag-over');
            el.classList.remove('drag-over-item');
        }

        function onTreeDrop(e, targetId, targetType) {
            e.preventDefault();
            e.stopPropagation();

            document.querySelectorAll('.drag-over, .drag-over-item').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-item');
            });

            const jsonData = e.dataTransfer.getData('json');
            if (jsonData) {
                const data = JSON.parse(jsonData);
                const targetNode = findNodeById(targetId);

                if (targetNode) {
                    saveState();

                    let iconPath = "";
                    if (data.type === 'aspect') {
                        iconPath = data.img;
                    } else if (data.type === 'item' || data.type === 'fluid') {
                        iconPath = `itempanel_icons/${data.name}.png`;
                    } else if (data.type === 'research') {
                        iconPath = data.img;
                    }

                    targetNode.iconData = iconPath;
                    renderTree();
                    saveState();
                    return;
                }
            }

            if (!draggedTreeNodeId) return;

            saveState();
            const sourceData = findParent(draggedTreeNodeId);
            if (!sourceData) return;
            const nodeToMove = sourceData.array.find(n => n.id === draggedTreeNodeId);
            const sourceIdx = sourceData.array.indexOf(nodeToMove);

            if (targetId === 'root') {
                sourceData.array.splice(sourceIdx, 1);
                projectStructure.push(nodeToMove);
            } else {
                if (draggedTreeNodeId === targetId || isDescendant(draggedTreeNodeId, targetId)) return;
                sourceData.array.splice(sourceIdx, 1);

                if (targetType === 'folder') {
                    const targetFolder = findNodeById(targetId);
                    if (!targetFolder.children) targetFolder.children = [];
                    targetFolder.children.push(nodeToMove);
                    targetFolder.expanded = true;
                } else {
                    const targetData = findParent(targetId);
                    if (targetData) {
                        const targetIdx = targetData.array.indexOf(targetData.array.find(n => n.id === targetId));
                        targetData.array.splice(targetIdx, 0, nodeToMove);
                    }
                }
            }

            draggedTreeNodeId = null;
            renderTree();
            saveState();
        }

        function isDescendant(sourceId, targetId) {
            const sourceNode = findNodeById(sourceId);
            if (!sourceNode || sourceNode.type !== 'folder') return false;

            function check(children) {
                for (let child of children) {
                    if (child.id === targetId) return true;
                    if (child.children && check(child.children)) return true;
                }
                return false;
            }
            return check(sourceNode.children);
        }

        function findNodeById(id, nodes = projectStructure) {
            for (let node of nodes) {
                if (node.id === id) return node;
                if (node.children) {
                    const found = findNodeById(id, node.children);
                    if (found) return found;
                }
            }
            return null;
        }

        function findParent(id, nodes = projectStructure, parent = null) {
            for (let node of nodes) {
                if (node.id === id) return { parent, array: nodes };
                if (node.children) {
                    const result = findParent(id, node.children, node);
                    if (result) return result;
                }
            }
            return null;
        }

        function renameNode() {
            if (!selectedNodeId) return;
            let target = findNodeById(selectedNodeId);
            if (target) {
                let newName = prompt("–ù–æ–≤–æ–µ –∏–º—è:", target.name);
                if (newName) {
                    saveState();
                    target.name = newName;
                    renderTree();
                    saveState();
                }
            }
        }

        function findPage(id) {
            function searchInNodes(nodes) {
                for (let node of nodes) {
                    if (node.type === 'page' && node.id === id) return node;
                    if (node.children) {
                        const found = searchInNodes(node.children);
                        if (found) return found;
                    }
                }
                return null;
            }
            return searchInNodes(projectStructure);
        }

        function loadPage(id) {
            activePageId = id;

            const p = findPage(id);

            if (!p) {
                console.error("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:", id);
                return;
            }

            const templateArea = document.getElementById('code-template');
            templateArea.value = p.template || '';

            renderVisualTemplate(p.template || "");

            selectedSlotIds.clear();
            updateBuilderInputs();

            renderCanvas();
            generateCode();
            renderPageElements();

            renderTree();
        }

        function addFolder() {
            saveState();
            const newNode = {
                id: 'f' + Date.now(),
                type: 'folder',
                name: '–ù–æ–≤–∞—è –ø–∞–ø–∫–∞',
                expanded: true,
                iconData: null,
                children: []
            };

            const target = findNodeById(selectedNodeId);
            if (target && target.type === 'folder') {
                target.children.push(newNode);
                target.expanded = true;
            } else {
                projectStructure.push(newNode);
            }

            renderTree();
            saveState();
        }

        function addPage() {
            saveState();
            const newNode = {
                id: 'p' + Date.now(),
                type: 'page',
                name: '–ù–æ–≤—ã–π –ª–∏—Å—Ç',
                iconData: null,
                slots: [],
                template: ''
            };

            const target = findNodeById(selectedNodeId);
            if (target && target.type === 'folder') {
                target.children.push(newNode);
                target.expanded = true;
            } else {
                const parentInfo = findParent(selectedNodeId);
                if (parentInfo) {
                    parentInfo.array.push(newNode);
                } else {
                    if (projectStructure.length > 0 && projectStructure[0].type === 'folder') {
                        projectStructure[0].children.push(newNode);
                    } else {
                        alert("–°–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–∞–ø–∫—É –≤ –∫–æ—Ä–Ω–µ!");
                        return;
                    }
                }
            }

            renderTree();
            saveState();
        }

        function deleteNode() {
            if (!selectedNodeId) return;
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ –≤—Å—ë –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ?')) {
                saveState();
                const res = findParent(selectedNodeId);
                if (res) {
                    const idx = res.array.findIndex(n => n.id === selectedNodeId);
                    res.array.splice(idx, 1);
                }

                selectedNodeId = null;
                renderTree();
                saveState();
            }
        }

        function clearPageCanvas() {
            if (!activePageId) return;
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')) {
                saveState();
                findPage(activePageId).slots = [];
                renderCanvas();
                saveState();
            }
        }

        // --- RESIZERS ---
        function setupResizers() {
            const hResizer = document.getElementById('resizer-handle');
            const codePanel = document.getElementById('code-panel-container');
            let isResizingH = false;

            if (hResizer && codePanel) {
                hResizer.addEventListener('mousedown', function (e) {
                    isResizingH = true;
                    hResizer.classList.add('active');
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', function (e) {
                    if (!isResizingH) return;
                    const newHeight = window.innerHeight - e.clientY;
                    if (newHeight > 40 && newHeight < window.innerHeight * 0.95) {
                        codePanel.style.height = newHeight + 'px';
                    }
                });

                document.addEventListener('mouseup', function () {
                    if (isResizingH) {
                        isResizingH = false;
                        hResizer.classList.remove('active');
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        saveState();
                    }
                });
            }

            // Side Resizers
            if (document.getElementById('resizer-left')) {
                initResize('resizer-left', 'sidebar-left-panel', 'left');
            }
            if (document.getElementById('resizer-right')) {
                initResize('resizer-right', 'sidebar-right-panel', 'right');
            }

            // Top Resizer
            if (document.getElementById('resizer-top')) {
                initResizeTop('resizer-top', 'main-header');
            }
        }

        function initResize(resizerId, panelId, side) {
            const resizer = document.getElementById(resizerId);
            const panel = document.getElementById(panelId);
            if (!resizer || !panel) return;
            let startX, startWidth;

            resizer.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                startWidth = panel.offsetWidth;
                resizer.classList.add('active');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                const onMouseMove = (moveEvent) => {
                    const diff = side === 'left' ? moveEvent.clientX - startX : startX - moveEvent.clientX;
                    const newWidth = startWidth + diff;
                    if (newWidth > 100 && newWidth < 800) {
                        panel.style.width = newWidth + 'px';
                    }
                };

                const onMouseUp = () => {
                    resizer.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    saveState();
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        function initResizeTop(resizerId, panelId) {
            const resizer = document.getElementById(resizerId);
            const panel = document.getElementById(panelId);
            if (!resizer || !panel) return;
            let startY, startHeight;

            resizer.addEventListener('mousedown', (e) => {
                startY = e.clientY;
                startHeight = panel.offsetHeight;
                resizer.classList.add('active');
                document.body.style.cursor = 'ns-resize';
                document.body.style.userSelect = 'none';

                const onMouseMove = (moveEvent) => {
                    const diff = moveEvent.clientY - startY;
                    const newHeight = startHeight + diff;
                    if (newHeight > 30 && newHeight < 200) {
                        panel.style.height = newHeight + 'px';
                    }
                };

                const onMouseUp = () => {
                    resizer.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    saveState();
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }
        function syncVisualToHidden() {
            const visualDiv = document.getElementById('code-template-visual');
            const hiddenTextarea = document.getElementById('code-template');
            const plainText = visualDiv.innerText;
            hiddenTextarea.value = plainText;
            updateTemplate(plainText);
        }

        function renderVisualTemplate(text, shouldSave = false) {
            const visualDiv = document.getElementById('code-template-visual');
            if (!visualDiv) return;

            // Normalize text: replace multiple newlines or weird artifacts if any
            const normalizedText = text.replace(/\r/g, '');

            // Save state and update template if needed
            const currentTemplate = (findPage(activePageId) || {}).template || "";
            if (shouldSave && normalizedText !== currentTemplate) {
                updateTemplate(normalizedText);
                saveState();
            }

            // ESCAPE the raw text before injecting into innerHTML
            const escapedText = normalizedText
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

            let matchIdx = 0;
            const rendered = escapedText.replace(/\{([^}]+)\}/g, (match, id) => {
                const currentIdx = matchIdx++;
                return `<span class="code-syntax-block" 
                            data-index="${currentIdx}"
                            contenteditable="false"
                            onmouseenter="highlightSlotOnCanvas('${id}', true)" 
                            onmouseleave="highlightSlotOnCanvas('${id}', false)">${match}</span>`;
            });

            // CRITICAL: Only update if the generated HTML is different from current HTML 
            // AND the user is not currently focusing/editing (unless it's an explicit save/load)
            if (visualDiv.innerHTML !== rendered) {
                if (document.activeElement !== visualDiv || !shouldSave) {
                    // Try to preserve scroll position
                    const scrollY = visualDiv.scrollTop;
                    visualDiv.innerHTML = rendered;
                    visualDiv.scrollTop = scrollY;
                }
            }
        }



        function setupTemplateDrop() {
            const visualArea = document.getElementById('code-template-visual');
            if (!visualArea) return;
            visualArea.addEventListener('dragover', (e) => e.preventDefault());
            visualArea.addEventListener('drop', (e) => {
                const data = e.dataTransfer.getData('text/plain');
                if (data && data.startsWith('{')) {
                    e.preventDefault();
                    let range;
                    if (document.caretRangeFromPoint) {
                        range = document.caretRangeFromPoint(e.clientX, e.clientY);
                    } else if (document.caretPositionFromPoint) {
                        const pos = document.caretPositionFromPoint(e.clientX, e.clientY);
                        if (pos && pos.offsetNode) {
                            range = document.createRange();
                            range.setStart(pos.offsetNode, pos.offset);
                            range.collapse(true);
                        }
                    }

                    if (range && visualArea.contains(range.startContainer)) {
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                        range.insertNode(document.createTextNode(data));
                    } else {
                        // Fallback: try to insert at current selection if valid
                        const sel = window.getSelection();
                        if (sel.rangeCount && visualArea.contains(sel.getRangeAt(0).startContainer)) {
                            sel.deleteFromDocument();
                            sel.getRangeAt(0).insertNode(document.createTextNode(data));
                        } else {
                            // Absolute fallback: append to end
                            visualArea.appendChild(document.createTextNode(data));
                        }
                    }
                    const fullText = visualArea.innerText;
                    renderVisualTemplate(fullText);
                    syncVisualToHidden();
                }
            });

            // Prevent structured HTML paste, ensure clean text
            visualArea.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = e.clipboardData.getData('text/plain');
                document.execCommand('insertText', false, text);
                syncVisualToHidden();
            });

            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: –≤—Å–µ–≥–¥–∞ –∫–æ–ø–∏—Ä—É–µ–º —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç —Å {id}
            visualArea.addEventListener('copy', (e) => {
                const selection = window.getSelection();
                if (selection.isCollapsed) return;

                const range = selection.getRangeAt(0);
                const container = document.createElement('div');
                container.appendChild(range.cloneContents());

                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–º–µ–Ω—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±–ª–æ–∫–æ–≤ –Ω–∞ –∏—Ö —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∫–ª–æ–Ω–µ
                const blocks = container.querySelectorAll('.code-syntax-block');
                blocks.forEach(b => {
                    b.outerHTML = b.textContent;
                });

                // –¢–µ–ø–µ—Ä—å textContent —Å–æ–¥–µ—Ä–∂–∏—Ç —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞
                const plainText = container.innerText || container.textContent;

                if (plainText) {
                    e.clipboardData.setData('text/plain', plainText);
                    e.preventDefault();
                }
            });
        }

        window.updateListOptionsDirect = function (id, text) {
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === id);
            if (slot) {
                slot.options = text.split('\n').map(line => line.trim()).filter(line => line !== "");
                generateCode();
            }
        };

        window.clearItemArray = function () {
            if (selectedSlotIds.size !== 1) return;
            const sid = selectedSlotIds.values().next().value;
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === sid);
            if (slot && slot.type === 'item_array') {
                saveState();
                slot.content = [];
                renderCanvas();
                generateCode();
                updateListBuilderUI(slot);
            }
        };

        window.addItemArraySlot = function (slotId) {
            saveState();
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === slotId);
            if (slot) {
                if (!slot.content) slot.content = [];
                slot.content.push(null);
                renderCanvas();
            }
        };
        window.renameSelectedGroup = function () {
            if (selectedSlotIds.size !== 1) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è");
                return;
            }
            const sid = selectedSlotIds.values().next().value;
            const page = findPage(activePageId);
            const slot = page.slots.find(s => s.id === sid);
            if (slot && slot.type === 'group') {
                const newName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:", slot.label);
                if (newName !== null) {
                    saveState();
                    slot.label = newName;
                    renderCanvas();
                    saveState();
                }
            } else {
                alert("–í—ã–±—Ä–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≥—Ä—É–ø–ø–æ–π");
            }
        };

        let searchTimeout;
        function renderLibraryDebounced() {
            clearTimeout(searchTimeout);
            document.getElementById('library-container').style.opacity = '0.5';
            searchTimeout = setTimeout(() => {
                renderLibrary();
                document.getElementById('library-container').style.opacity = '1';
            }, 300);
        }

        function checkMatch(item, query) {
            if (!query) return true;
            const s = query.toLowerCase();
            if (typeof item === 'string') return item.toLowerCase().includes(s);
            return Object.values(item).some(val =>
                val && String(val).toLowerCase().includes(s)
            );
        }

        // Helper to ensure page has enough slots for a recipe type
        function ensurePageSlots(page, type, inputCount = 9) {
            const inputs = page.slots.filter(s => !s.id.toLowerCase().includes('out') && s.type !== 'fluid');
            const outputs = page.slots.filter(s => s.id.toLowerCase().includes('out') || s.id.toLowerCase().includes('result'));
            const fluids = page.slots.filter(s => s.type === 'fluid');

            const startX = 100;
            const startY = 100;
            const step = 55;

            // Ensure Output
            if (outputs.length === 0) {
                const newOut = {
                    id: "out",
                    type: "item",
                    x: startX + 300,
                    y: startY + step,
                    val: "", label: "Output", content: null
                };
                page.slots.push(newOut);
            }

            // Ensure Inputs
            if (inputs.length < inputCount) {
                let currentCount = inputs.length;
                for (let i = 0; i < (inputCount - currentCount); i++) {
                    const totalIdx = currentCount + i;
                    // 3x3 Grid Layout default
                    const gridX = totalIdx % 3;
                    const gridY = Math.floor(totalIdx / 3);

                    page.slots.push({
                        id: "in" + (totalIdx + 1),
                        type: "item",
                        x: startX + gridX * step,
                        y: startY + gridY * step,
                        val: "", label: "Input", content: null
                    });
                }
            }
        }

        // --- RECIPE TEMPLATES SYSTEM (UPDATED) ---
        const RECIPE_TEMPLATES = {
            "vanilla": {
                name: "Minecraft (Vanilla)",
                recipes: [
                    { name: "–í–µ—Ä—Å—Ç–∞–∫ (Shaped)", template: "recipes.addShaped({out}, [[{in1}, {in2}, {in3}], [{in4}, {in5}, {in6}], [{in7}, {in8}, {in9}]]);", type: "shaped" },
                    { name: "–í–µ—Ä—Å—Ç–∞–∫ (Shapeless)", template: "recipes.addShapeless({out}, [{in1}, {in2}, {in3}]);", type: "shapeless" },
                    { name: "–ü–µ—á–∫–∞", template: "furnace.addRecipe({out}, {in}, 0.0);", type: "furnace" },
                    { name: "–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç", template: "recipes.remove({out});", type: "one-slot" }
                ]
            },
            "ic2": {
                name: "Industrial Craft 2",
                recipes: [
                    { name: "–î—Ä–æ–±–∏—Ç–µ–ª—å (Macerator)", template: "mods.ic2.Macerator.addRecipe({out}, {in});", type: "machine" },
                    { name: "–ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä (Compressor)", template: "mods.ic2.Compressor.addRecipe({out}, {in});", type: "machine" },
                    { name: "–≠–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä (Extractor)", template: "mods.ic2.Extractor.addRecipe({out}, {in});", type: "machine" },
                    { name: "–£—Ç–∏–ª–∏–∑–∞—Ç–æ—Ä (Recycler)", template: "mods.ic2.Recycler.addBlacklist({in});", type: "one-slot" },
                    { name: "–ú–µ—Ç–∞–ª–ª–æ—Ñ–æ—Ä–º–æ–≤–∫–∞ (Metal Former)", template: "mods.ic2.MetalFormer.addRollingRecipe({out}, {in});", type: "machine" },
                    { name: "–¶–µ–Ω—Ç—Ä–∏—Ñ—É–≥–∞ (Centrifuge)", template: "mods.ic2.ThermalCentrifuge.addRecipe({out}, {in}, 100);", type: "machine" },
                    { name: "–ü—Ä–æ–º—ã–≤–∫–∞ —Ä—É–¥ (Ore Washing)", template: "mods.ic2.OreWasher.addRecipe({out}, {in}, 1000);", type: "machine" }
                ]
            },
            "thermal": {
                name: "Thermal Expansion",
                recipes: [
                    { name: "–ò–∑–º–µ–ª—å—á–∏—Ç–µ–ª—å (Pulverizer)", template: "mods.thermalexpansion.Pulverizer.addRecipe(4000, {in}, {out});", type: "machine" },
                    { name: "–õ–µ—Å–æ–ø–∏–ª–∫–∞ (Sawmill)", template: "mods.thermalexpansion.Sawmill.addRecipe(2000, {in}, {out});", type: "machine" },
                    { name: "–ü–ª–∞–≤–∏–ª—å–Ω—è (Smelter)", template: "mods.thermalexpansion.Smelter.addRecipe(4000, {in1}, {in2}, {out});", type: "machine-2in" },
                    { name: "–¢–∏–≥–µ–ª—å (Crucible)", template: "mods.thermalexpansion.Crucible.addRecipe(2000, {in}, {out_fluid});", type: "machine-fluid-out" },
                    { name: "–¢—Ä–∞–Ω—Å–ø–æ–∑–µ—Ä (Fluid Fill)", template: "mods.thermalexpansion.Transposer.addFillRecipe(2000, {in}, {out}, {fluid});", type: "machine-fluid-in" },
                    { name: "–¢—Ä–∞–Ω—Å–ø–æ–∑–µ—Ä (Fluid Extract)", template: "mods.thermalexpansion.Transposer.addExtractRecipe(2000, {in}, {out}, {fluid}, 100);", type: "machine-fluid-out" }
                ]
            },
            "botania": {
                name: "Botania",
                recipes: [
                    { name: "–õ–µ–ø–µ—Å—Ç–∫–æ–≤—ã–π –∞–ø—Ç–µ–∫–∞—Ä—å", template: "mods.botania.Apothecary.addRecipe({out}, [{in1}, {in2}, {in3}]);", type: "shapeless" },
                    { name: "–†—É–Ω–∏—á–µ—Å–∫–∏–π –∞–ª—Ç–∞—Ä—å", template: "mods.botania.RuneAltar.addRecipe({out}, [{in1}, {in2}, {in3}], 1000);", type: "shapeless" },
                    { name: "–ë–∞—Å—Å–µ–π–Ω –º–∞–Ω—ã (–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ)", template: "mods.botania.ManaInfusion.addInfusion({out}, {in}, 2000);", type: "machine" },
                    { name: "–ë–∞—Å—Å–µ–π–Ω –º–∞–Ω—ã (–ê–ª—Ö–∏–º–∏—è)", template: "mods.botania.ManaInfusion.addAlchemy({out}, {in}, 2000);", type: "machine" },
                    { name: "–°–¥–µ–ª–∫–∞ —Å –≠–ª—å—Ñ–∞–º–∏", template: "mods.botania.ElvenTrade.addRecipe({out}, [{in1}, {in2}]);", type: "shapeless" }
                ]
            },
            "bloodmagic": {
                name: "Blood Magic",
                recipes: [
                    { name: "–ö—Ä–æ–≤–∞–≤—ã–π –∞–ª—Ç–∞—Ä—å", template: "mods.bloodmagic.Altar.addRecipe({out}, {in}, 1, 500, 10, 10);", type: "machine" },
                    { name: "–ê–ª—Ö–∏–º–∏—á–µ—Å–∫–∞—è —Ö–∏–º–∏—è", template: "mods.bloodmagic.Alchemy.addRecipe({out}, [{in1}, {in2}, {in3}], 100, 100);", type: "shapeless" }
                ]
            },
            "thaum": {
                name: "Thaumcraft 4",
                recipes: [
                    { name: "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –≤–µ—Ä—Å—Ç–∞–∫ (Arcane)", template: "mods.thaumcraft.Arcane.addShaped(\"ASPECTS\", {out}, \"aer 1, terra 1\", [[{in1}, {in2}, {in3}], [{in4}, {in5}, {in6}], [{in7}, {in8}, {in9}]]);", type: "thaum-arcane" },
                    { name: "–¢–∏–≥–µ–ª—å (Crucible)", template: "mods.thaumcraft.Crucible.addRecipe(\"KEY\", {out}, {in}, \"aer 1, terra 1\");", type: "machine" },
                    { name: "–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ (Infusion)", template: "mods.thaumcraft.Infusion.addRecipe(\"RESEARCH\", {in_center}, [{in1}, {in2}, {in3}, {in4}], \"aer 10, terra 10\", {out}, 5);", type: "thaum-infusion" }
                ]
            },
            "buildcraft": {
                name: "BuildCraft",
                recipes: [
                    { name: "–°–±–æ—Ä–æ—á–Ω—ã–π —Å—Ç–æ–ª (Assembly)", template: "mods.buildcraft.AssemblyTable.addRecipe({out}, 10000, [{in1}, {in2}]);", type: "shapeless" },
                    { name: "–ù–ü–ó (Refinery)", template: "mods.buildcraft.Refinery.addRecipe({fluid_out}, 12, 1, {fluid_in1}, {fluid_in2});", type: "machine-fluid-2in" }
                ]
            },
            "forestry": {
                name: "Forestry",
                recipes: [
                    { name: "–ü–ª–æ—Ç–Ω–∏–∫ (Carpenter)", template: "mods.forestry.Carpenter.addRecipe({out}, [[{in1}, {in2}, {in3}], [{in4}, {in5}, {in6}], [{in7}, {in8}, {in9}]], 40, {fluid});", type: "shaped-fluid" },
                    { name: "–¶–µ–Ω—Ç—Ä–∏—Ñ—É–≥–∞ (Centrifuge)", template: "mods.forestry.Centrifuge.addRecipe([{out1} % 100, {out2} % 50], {in}, 20);", type: "machine" },
                    { name: "–°–æ–∫–æ–≤—ã–∂–∏–º–∞–ª–∫–∞ (Squeezer)", template: "mods.forestry.Squeezer.addRecipe({fluid}, [{in1}, {in2}], 20);", type: "machine-squeezer" }
                ]
            },
            "ae2": {
                name: "Applied Energistics 2",
                recipes: [
                    { name: "–ò–∑–º–µ–ª—å—á–∏—Ç–µ–ª—å (Grinder)", template: "mods.appeng.Grinder.addRecipe({in}, {out}, 4);", type: "machine" },
                    { name: "–í—ã—Å–µ–∫–∞—Ç–µ–ª—å (Inscriber)", template: "mods.appeng.Inscriber.addRecipe([{in1}, {in2}, {in3}], {out}, \"Press\");", type: "machine-3in" }
                ]
            },
            "mekanism": {
                name: "Mekanism",
                recipes: [
                    { name: "–û–±–æ–≥–∞—Ç–∏—Ç–µ–ª—å (Enrichment)", template: "mods.mekanism.EnrichmentChamber.addRecipe({in}, {out});", type: "machine" },
                    { name: "–î—Ä–æ–±–∏—Ç–µ–ª—å (Crusher)", template: "mods.mekanism.Crusher.addRecipe({in}, {out});", type: "machine" },
                    { name: "–ú–µ—Ç–∞–ª–ª—É—Ä–≥–∏—á–µ—Å–∫–∏–π (Infuser)", template: "mods.mekanism.MetallurgicInfuser.addRecipe(\"INFUSION\", 10, {in}, {out});", type: "machine" }
                ]
            },
            "exnihilo": {
                name: "Ex Nihilo",
                recipes: [
                    { name: "–°–∏—Ç–æ (Sieve)", template: "mods.exnihilo.Sieve.addRecipe({in}, {out}, 10);", type: "machine" },
                    { name: "–ú–æ–ª–æ—Ç (Hammer)", template: "mods.exnihilo.Hammer.addRecipe({in}, {out}, 1.0, 1.0);", type: "machine" },
                    { name: "–ë–æ—á–∫–∞ (–ö–æ–º–ø–æ—Å—Ç)", template: "mods.exnihilo.Compost.addRecipe({in}, 0.1, \"#FFFFFF\");", type: "one-slot" }
                ]
            },
            "avaritia": {
                name: "Avaritia",
                recipes: [
                    { name: "Extreme Crafting", template: "mods.avaritia.ExtremeCrafting.addShaped({out}, [[{in1}, {in2}, {in3}, {in4}, {in5}, {in6}, {in7}, {in8}, {in9}], [{in10}, {in11}, {in12}, {in13}, {in14}, {in15}, {in16}, {in17}, {in18}], ...]);", type: "avaritia" },
                    { name: "Compressor", template: "mods.avaritia.Compressor.add({out}, {in_count}, {in});", type: "machine" }
                ]
            },
            "gregtech": {
                name: "GregTech",
                recipes: [
                    { name: "Assembler", template: "mods.gregtech.Assembler.addRecipe({out}, {in1}, {in2}, 200, 30);", type: "machine-2in" },
                    { name: "Chemical Reactor", template: "mods.gregtech.ChemicalReactor.addRecipe({out}, {fluid}, {in1}, {in2}, 200);", type: "machine-fluids" }
                ]
            }
        };

        window.openRecipeSelectorModal = function () {
            const modal = document.getElementById('recipe-selector-modal');
            const cats = document.getElementById('recipe-modal-cats');
            const list = document.getElementById('recipe-modal-list');

            if (!modal || !cats || !list) {
                console.error("Modal elements not found!");
                return;
            }

            cats.innerHTML = '';
            list.innerHTML = '';

            if (typeof RECIPE_TEMPLATES === 'undefined' || Object.keys(RECIPE_TEMPLATES).length === 0) {
                list.innerHTML = '<div style="color:red; text-align:center; padding:20px;">Error: RECIPE_TEMPLATES not defined or empty.</div>';
                modal.style.display = 'flex';
                return;
            }

            Object.keys(RECIPE_TEMPLATES).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.style.background = '#444'; // Force visible background
                btn.style.color = '#fff';
                btn.style.border = '1px solid #555';
                btn.style.marginRight = '5px';
                btn.innerText = RECIPE_TEMPLATES[key].name;
                btn.onclick = () => renderRecipeList(key);
                btn.style.whiteSpace = 'nowrap';
                // Store key on element for active state toggling
                btn.dataset.key = key;
                cats.appendChild(btn);
            });

            // Render first cat
            renderRecipeList('vanilla');

            modal.style.display = 'flex';
        };

        window.renderRecipeList = function (catKey) {
            const list = document.getElementById('recipe-modal-list');
            const data = RECIPE_TEMPLATES[catKey];
            list.innerHTML = ``;

            document.querySelectorAll('#recipe-modal-cats .btn').forEach(b => {
                if (b.dataset.key === catKey) {
                    b.style.background = '#6366f1'; // Active color
                    b.style.borderColor = '#818cf8';
                } else {
                    b.style.background = '#444'; // Inactive color
                    b.style.borderColor = '#555';
                }
            });

            if (!data || !data.recipes) return;

            data.recipes.forEach(rec => {
                const item = document.createElement('div');
                // Explicit inline styles to ensure visibility
                item.style.cssText = 'background: #252525; padding: 12px; border-radius: 6px; border: 1px solid #444; cursor: pointer; transition: all 0.2s;';

                item.onmouseover = () => {
                    item.style.borderColor = '#6366f1';
                    item.style.background = '#2a2a2a';
                };
                item.onmouseout = () => {
                    item.style.borderColor = '#444';
                    item.style.background = '#252525';
                };

                item.innerHTML = `<div style="font-weight:bold; color:#fff; margin-bottom:5px; font-size:13px;">${rec.name}</div>
                              <div style="font-size:11px; color:#aaa; font-family:'Consolas', monospace; word-break:break-all; line-height:1.4;">${rec.template}</div>`;

                item.onclick = () => applyRecipeTemplate(rec.template, rec.type);
                list.appendChild(item);
            });
        }

        function applyRecipeTemplate(tmpl, type) {
            document.getElementById('recipe-selector-modal').style.display = 'none';

            const page = findPage(activePageId);
            if (!page) return;

            saveState();

            // --- 1. DETECT NEEDED SLOTS & AUTO-ADD THEM ---
            const inputs = page.slots.filter(s => !s.id.toLowerCase().includes('out') && s.type !== 'fluid');
            const outputs = page.slots.filter(s => s.id.toLowerCase().includes('out') || s.id.toLowerCase().includes('result'));
            const fluids = page.slots.filter(s => s.type === 'fluid');

            // Helper to check if we have enough slots, if not create them
            function ensureSlots(neededIn, neededOut, neededFluid) {
                ensurePageSlots(page, 'custom', neededIn);
                // Additional fluid/custom logic if needed, but ensurePageSlots handles basic item grid
                const fluids = page.slots.filter(s => s.type === 'fluid');
                const startX = 100;
                const startY = 100;

                if (fluids.length < neededFluid) {
                    for (let i = 0; i < (neededFluid - fluids.length); i++) {
                        page.slots.push({
                            id: "fluid" + (i + 1),
                            type: "fluid",
                            x: startX + 200,
                            y: startY + 200 + (i * 60),
                            val: "", label: "Fluid", content: null
                        });
                    }
                }
            }

            // Logic based on types
            if (type === 'shaped' || type === 'shapeless' || type === 'thaum-arcane') {
                ensureSlots(9, 1, 0);
            } else if (type === 'machine' || type === 'furnace' || type === 'one-slot') {
                ensureSlots(1, 1, 0);
            } else if (type === 'machine-2in' || type === 'machine-squeezer') {
                ensureSlots(2, 1, 0);
            } else if (type === 'machine-3in') {
                ensureSlots(3, 1, 0);
            } else if (type === 'machine-fluid-out') { // e.g., Thermal Crucible (item in, fluid out)
                ensureSlots(1, 0, 1);
            } else if (type === 'machine-fluid-in') { // e.g., Thermal Transposer Fill (fluid in, item in, item out)
                ensureSlots(1, 1, 1);
            } else if (type === 'machine-fluid-2in') { // e.g., BuildCraft Refinery (2 fluids in, 1 fluid out)
                ensureSlots(0, 0, 2); // No item inputs/outputs, just fluids
            } else if (type === 'shaped-fluid') { // e.g., Forestry Carpenter (shaped item inputs, fluid input, item out)
                ensureSlots(9, 1, 1);
            } else if (type === 'thaum-infusion') {
                ensureSlots(6, 1, 0);
            } else if (type === 'avaritia') {
                ensureSlots(81, 1, 0); // Extreme crafting!
            } else if (type === 'machine-fluids') { // e.g., GregTech Chemical Reactor (item in, fluid in, item out)
                ensureSlots(2, 1, 1);
            }

            renderCanvas();
            // Re-fetch slots after creation
            const freshInputs = page.slots.filter(s => !s.id.toLowerCase().includes('out') && s.type !== 'fluid');
            const freshOutputs = page.slots.filter(s => s.id.toLowerCase().includes('out') || s.id.toLowerCase().includes('result'));
            const freshFluids = page.slots.filter(s => s.type === 'fluid');

            // --- 2. APPLY TEMPLATE REPLACEMENT ---
            let newTmpl = tmpl;

            if (freshOutputs.length > 0) newTmpl = newTmpl.replace(/{out}/g, `{${freshOutputs[0].id}}`);
            if (freshOutputs.length > 1) newTmpl = newTmpl.replace(/{out1}/g, `{${freshOutputs[0].id}}`).replace(/{out2}/g, `{${freshOutputs[1].id}}`);

            if (freshInputs.length > 0) newTmpl = newTmpl.replace(/{in}/g, `{${freshInputs[0].id}}`);

            freshInputs.forEach((s, i) => {
                newTmpl = newTmpl.replace(new RegExp(`{in${i + 1}}`, 'g'), `{${s.id}}`);
                if (i === 0) newTmpl = newTmpl.replace(/{in_center}/g, `{${s.id}}`);
            });

            if (freshFluids.length > 0) {
                newTmpl = newTmpl.replace(/{fluid}/g, `{${freshFluids[0].id}}`);
                newTmpl = newTmpl.replace(/{out_fluid}/g, `{${freshFluids[0].id}}`);
                newTmpl = newTmpl.replace(/{fluid_in1}/g, `{${freshFluids[0].id}}`);
                newTmpl = newTmpl.replace(/{fluid_out}/g, `{${freshFluids[0].id}}`); // For BuildCraft Refinery
            }
            if (freshFluids.length > 1) {
                newTmpl = newTmpl.replace(/{fluid_in2}/g, `{${freshFluids[1].id}}`);
            }

            page.template = newTmpl;

            const visual = document.getElementById('code-template-visual');
            if (visual) visual.innerText = newTmpl;
            renderVisualTemplate(newTmpl);

            const ta = document.getElementById('code-template');
            if (ta) ta.value = newTmpl;

            updateBuilderInputs();
            generateCode();
            saveState();
        } // End of Recipe Logic
    </script>
    <div id="recipe-selector-modal"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#181818; border:1px solid #444; padding:20px; z-index:20000; width:90%; max-width:800px; height:80vh; border-radius:8px; box-shadow:0 10px 40px rgba(0,0,0,0.8); flex-direction:column;">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3 style="margin:0; color:#fff;">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤ Minetweaker (1.7.10)</h3>
            <button onclick="document.getElementById('recipe-selector-modal').style.display='none'"
                class="btn danger">X</button>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #333; overflow-x:auto;"
            id="recipe-modal-cats">
            <!-- Categories injected here -->
        </div>
        <div style="flex:1; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:10px; align-content:start;"
            id="recipe-modal-list">
            <!-- Templates injected here -->
        </div>
    </div>
</body>

</html>